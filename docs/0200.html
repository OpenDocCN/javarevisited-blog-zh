<html>
<head>
<title>If you develop software with an OOP Language, you need “Double Dispatch”: here’s why (and what the heck it is)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如果你用面向对象的语言开发软件，你需要“双重调度”:这是为什么(这到底是什么)</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/if-you-develop-software-with-an-oop-language-you-need-double-dispatch-heres-why-and-what-the-19b33a0df857?source=collection_archive---------0-----------------------#2019-12-12">https://medium.com/javarevisited/if-you-develop-software-with-an-oop-language-you-need-double-dispatch-heres-why-and-what-the-19b33a0df857?source=collection_archive---------0-----------------------#2019-12-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/67237f38d495e6af676c798b51062002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XsbQO6APpN6hiGnz"/></div></div><p class="iq ir et er es is it bd b be z dx translated">罗斯·芬登在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d2cd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当使用面向对象的语言——如Java——开发软件时，可能存在各种情况，在这些情况下，根据更通用的接口来操作一些对象是有效的，而在同一程序中，在其他情况下，需要根据更专用的接口来访问相同的对象。</p><p id="8115" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，考虑这样一种情况，在某个软件架构中，我们必须操作<code class="du ju jv jw jx b">Messages</code>(例如发送给移动应用程序或Web服务用户的通知):对于处理<code class="du ju jv jw jx b">Messages</code>的组成或传输的架构部分，它“可见”仅仅是对<code class="du ju jv jw jx b">Messages</code>的一般描述是必要的和充分的；而对于处理实际发送的架构部分，有必要正确管理<em class="jt">每种不同类型的</em><code class="du ju jv jw jx b">Message</code>(例如，SMS或电子邮件，或移动设备的推送通知)。</p><p id="cdd5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是一个(简化的)UML类图，它描述了一个对应于前面例子的系统:</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/bc573d8713479b0f6d0c46d3d65e35de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d8Wbs-bPl2Ayi-RGvHsNzQ.png"/></div></div></figure><p id="83b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">考虑从队列中获取并交付一个<code class="du ju jv jw jx b">Message</code>的用例；下面是一个可能的(简化的)Java实现:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="93a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du ju jv jw jx b">mailBox</code>对象必须能够根据它实际上是一个<code class="du ju jv jw jx b">SMSMessage</code>还是一个<code class="du ju jv jw jx b">EmailMessage</code>来处理不同的消息发送。</p><p id="0fb8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，我们可以编写下面的单元测试(总是用Java):</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="724f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这项测试中:</p><ul class=""><li id="cf5d" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js kk kl km kn bi translated">我们从队列中取出一个<code class="du ju jv jw jx b">Message</code>——假设我们收到一条短信(通过嘲讽)</li><li id="a83d" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">我们通过<code class="du ju jv jw jx b">MailBox</code>交付<code class="du ju jv jw jx b">Message</code></li><li id="6dbf" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">我们检查发送结果——在测试的情况下，必须证明SMS已经发送</li></ul><p id="d57c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du ju jv jw jx b">deliver()</code>方法的最佳实现是什么？</p><h2 id="c5b2" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">错误的实现(在Java中)</h2><p id="376a" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">一种自然的方法是利用所谓的“双重调度”。</p><p id="50dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">“双重分派”是某些面向对象语言的特征，使得在运行时用于响应某个调用的实际方法的选择不仅基于其方法被调用的实例的“特征”(在我们的例子中为<code class="du ju jv jw jx b">mailBox</code>)，而且基于方法的参数——在它们在某个类层次结构中实现的有效类的特定含义(在我们的例子中为<code class="du ju jv jw jx b">message</code>变量)。</p><p id="8c67" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，我们可以想象，有两个<code class="du ju jv jw jx b">deliver(Message)</code>的实现:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="d3c8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，由于<code class="du ju jv jw jx b">MailBox</code>类必须能够在泛型<code class="du ju jv jw jx b">Messages</code>上被调用，我们还必须添加一个类型的方法:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="42d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不幸的是，由于Java并没有<em class="jt">而不是</em>原生支持“双重分派”，所以这种幼稚的方法行不通:<code class="du ju jv jw jx b">mailBox.deliver(message)</code>会不会<em class="jt">总是</em>导致<code class="du ju jv jw jx b">deliver(Message)</code>(即参数最“抽象”接口的方法)的实际调用——返回<code class="du ju jv jw jx b">null</code>。</p><h2 id="e1ab" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">工作实现——通过“反模式”</h2><p id="ec6e" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">更有效的方法是使用一个<code class="du ju jv jw jx b">instanceOf</code>和一系列<code class="du ju jv jw jx b">ifs</code>:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="735c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">测试现在开始了。</p><p id="0a76" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是代码的质量并不是最佳的。</p><p id="9f74" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">的确，有些“代码气味”很容易被注意到；如果有人会添加一个新的<code class="du ju jv jw jx b">Message</code>(比如说一个<code class="du ju jv jw jx b">MobilePushNotification</code>):</p><ul class=""><li id="29ca" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js kk kl km kn bi translated">不容易知道代码库中是否存在这一点(或其他点),需要添加一条语句来正确处理新类型的<code class="du ju jv jw jx b">Message</code></li><li id="9867" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">此外，在确定该代码时，为了增加新<code class="du ju jv jw jx b">Message</code>的管理，有必要修改现有的工作代码，该代码在此期间可能会因其他干预措施而变得更加复杂，因此其修改可能会导致意外问题</li><li id="e136" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">一个“造型”被应用到一个<code class="du ju jv jw jx b">message</code>中:如果代码将被重构，那么造型可能被移动到一个不再合适的位置</li></ul><h2 id="45cb" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">最后，好的那个！</h2><p id="d0f8" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">更有效的方法是使用访问者模式实现“双重分派”。</p><p id="6498" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们创建一个<code class="du ju jv jw jx b">MessageVisitor</code>:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="2349" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后我们修改<code class="du ju jv jw jx b">Messages</code>以便他们接受它:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="bbc3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，我们确保<code class="du ju jv jw jx b">MailBox</code>实现了<code class="du ju jv jw jx b">MessageVisitor&lt;DeliveryOutcome&gt;</code>，并且我们以下面简单的方式实现了<code class="du ju jv jw jx b">deliver(Message)</code>:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="933e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且一个<code class="du ju jv jw jx b">Message</code>，比如说一个<code class="du ju jv jw jx b">SMSMessage</code>，将如下实现<code class="du ju jv jw jx b">accept()</code>:</p><figure class="jz ka kb kc fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="c12d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个UML图总结了一个<code class="du ju jv jw jx b">MailBox</code>实现的新设计:</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/729718358e42172359db0385b6a7c297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*maGQSCBxk8buCvtx6FmsdQ.png"/></div></div></figure><p id="63cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这样，当我们添加一个新类型的<code class="du ju jv jw jx b">Message</code>时，编译器会立即通知我们<code class="du ju jv jw jx b">MessageVisitor</code>需要一个新的合适的方法，随后，编译器会一直通知我们<code class="du ju jv jw jx b">MailBox</code>的实现也需要新方法的实现:</p><ul class=""><li id="99d9" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js kk kl km kn bi translated">系统的知识由编译器管理——而不是由拥有代码库的团队的口头或书面记忆来管理</li><li id="34c8" class="kf kg hi ix b iy ko jc kp jg kq jk kr jo ks js kk kl km kn bi translated">需求的变化(例如新的<code class="du ju jv jw jx b">Message</code>)将通过扩展系统(使用新的方法)来实现，而不修改现有的方法</li></ul><p id="d4ee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">超级整洁！</p><h2 id="5213" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">结论</h2><p id="604c" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">我们已经看到，当我们必须在通过OOP编码的软件系统中交替使用通用接口和特定实现时，使用“双重调度”是多么必要。</p><p id="4f95" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，我们已经看到了如何使用Visitor模式在Java中有效地实现双重分派。</p><p id="35f4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在我的GitHub项目资源库<a class="ae iu" href="https://github.com/PiercarloSlavazza/double-dispatch-java-example" rel="noopener ugc nofollow" target="_blank">double-dispatch-Java-example</a>中找到完整的代码(所有情况的实现，包括单元测试)。</p><div class="lu lv ez fb lw lx"><a rel="noopener follow" target="_blank" href="/javarevisited/10-oop-design-principles-you-can-learn-in-2020-f7370cccdd31"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">2020年你可以学到的10个OOP设计原则</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">想要写出更好、更可靠的代码，能够经受住生产中时间的考验吗？这些设计原则会有所帮助。</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">medium.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml io lx"/></div></div></a></div><h2 id="97e1" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">你可能喜欢的其他文章</h2><p id="6f14" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated"><a class="ae iu" href="https://javarevisited.blogspot.com/2017/12/10-things-java-programmers-should-learn.html#axzz5atl0BngO" rel="noopener ugc nofollow" target="_blank">2020年Java程序员应该学会的10件事</a> <br/> <a class="ae iu" href="http://www.java67.com/2015/03/10-books-every-programmer-and-software-engineer-read.html" rel="noopener ugc nofollow" target="_blank">每个程序员必读的10本书</a> <br/> <a class="ae iu" href="http://javarevisited.blogspot.sg/2014/01/10-tips-to-improve-programming-skill-become-better-programmer.html#axzz553pz1hYh" rel="noopener ugc nofollow" target="_blank">提高编程技能的10个技巧</a> <br/> <a class="ae iu" href="http://javarevisited.blogspot.sg/2018/01/10-tools-every-software-developer-know.html#axzz559dyoLSA" rel="noopener ugc nofollow" target="_blank"> 10个工具每个软件开发人员应该知道的</a> <br/> <a class="ae iu" href="https://javarevisited.blogspot.com/2019/03/5-courses-programmers-can-join-to-learn.html#axzz5jKqbGRcg" rel="noopener ugc nofollow" target="_blank">深入学习软件架构的5门课程</a> <br/> <a class="ae iu" href="https://javarevisited.blogspot.com/2018/01/top-20-libraries-and-apis-for-java-programmers.html" rel="noopener ugc nofollow" target="_blank"> 20个库和APIS Java程序员应该知道的</a><br/><a class="ae iu" href="http://www.java67.com/2017/12/10-programming-languages-to-learn-in.html" rel="noopener ugc nofollow" target="_blank">2020年要学习的10大编程语言</a> <br/></p><div class="lu lv ez fb lw lx"><a href="https://javarevisited.blogspot.com/2019/10/the-java-developer-roadmap.html#123" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">2020年Java开发者路线图</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">大家好，首先祝大家2020新年快乐。我已经分享了很多成为网络的路线图…</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">javarevisited.blogspot.com</p></div></div><div class="mg l"><div class="mm l mi mj mk mg ml io lx"/></div></div></a></div></div></div>    
</body>
</html>