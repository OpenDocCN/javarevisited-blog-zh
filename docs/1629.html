<html>
<head>
<title>Running ALTER TABLE on production MySql with millions of records…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在有数百万条记录的生产MySql上运行ALTER TABLE</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/running-alter-table-on-production-mysql-with-millions-of-records-293f42b44df7?source=collection_archive---------1-----------------------#2021-10-09">https://medium.com/javarevisited/running-alter-table-on-production-mysql-with-millions-of-records-293f42b44df7?source=collection_archive---------1-----------------------#2021-10-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="07a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有些事情我们不喜欢做，但是我们不得不做！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/159db045d3d7c60fc38bfee090b8cf0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3e1X9ny7T_9jCD1T"/></div></div><p class="jp jq et er es jr js bd b be z dx translated">由<a class="ae jt" href="https://unsplash.com/@tvick?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">泰勒维克</a>在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="468d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生产数据库上的模式变更一直是一个棘手的问题，当我们谈论数百万条记录时，这个问题就更加严重了，如果您过去在生产服务器上运行过变更，那么您就会知道,<code class="du ju jv jw jx b">ALTER TABLE</code>命令基本上是读取整个表的锁，然后短暂地写入锁。如果有数百万条记录，这意味着一个简单的<code class="du ju jv jw jx b">ADD COLUMN</code>将需要20-30分钟，并将导致生产停工。</p><blockquote class="jy jz ka"><p id="e5b7" class="if ig kb ih b ii ij ik il im in io ip kc ir is it kd iv iw ix ke iz ja jb jc hb bi translated"><em class="hi">注意:对于MySQL版本&lt; 5.6锁是必需的，但是如果你使用的是5.6+和InnoDB，很多</em> <a class="ae jt" href="https://dev.mysql.com/doc/refman/5.6/en/innodb-online-ddl-operations.html" rel="noopener ugc nofollow" target="_blank"> <em class="hi"> ALTER TABLE操作都可以避免锁。</em>T11】</a></p></blockquote><h1 id="16f6" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><strong class="ak"> Percona工具包救援助手🚀</strong></h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ld"><img src="../Images/1e8702bb53915ad7ac855b2f510d8aab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/0*yhUPxjZSdkgOPK2K.png"/></div></figure><p id="fcff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jt" href="https://www.percona.com/doc/percona-toolkit/3.0" rel="noopener ugc nofollow" target="_blank"> Percona Toolkit Helper </a>自带<strong class="ih hj"><em class="kb">pt-online-schema-change</em></strong><em class="kb">其中的</em> <a class="ae jt" href="https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html#name" rel="noopener ugc nofollow" target="_blank"> <em class="kb">文档</em> </a> <em class="kb"> … </em></p><blockquote class="jy jz ka"><p id="cd35" class="if ig kb ih b ii ij ik il im in io ip kc ir is it kd iv iw ix ke iz ja jb jc hb bi translated">pt-online-schema-change 在不阻塞读或写的情况下改变表的结构。在DSN中指定数据库和表。在阅读该工具的文档并仔细检查您的备份之前，请勿使用该工具。</p></blockquote><p id="535c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，<strong class="ih hj">pt-online-schema-change</strong>的工作方式类似于MySql ALTER的内部工作方式，但唯一的区别是它处理的是要更改的表的副本。下面是它在幕后做的事情:</p><ol class=""><li id="7709" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">创建要修改的表的空副本，并根据需要修改它。</li><li id="8dd3" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">复制原始表中的内容，并从原始表中创建触发器，以便在发生任何更新时更新新表中的相应行。</li><li id="7f4f" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">数据是以小块的形式复制的，这可以根据用户来控制，我们稍后会谈到这一点。</li><li id="7dc5" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">当复制完成时，它同时对原始表和新表进行原子重命名，并删除原始表post。</li></ol><p id="c377" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在整个过程中，原始数据库是空闲的，可以为读写流量提供服务。</p><h1 id="4520" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">安装指南</h1><p id="9e24" class="pw-post-body-paragraph if ig hi ih b ii ls ik il im lt io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">请参考Percona toolkit网站的<a class="ae jt" href="https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html#downloading" rel="noopener ugc nofollow" target="_blank">下载部分</a>了解更多信息。</p><pre class="je jf jg jh fd lx jx ly lz aw ma bi"><span id="d371" class="mb kg hi jx b fi mc md l me mf">sudo apt install percona-toolkit<br/>wget percona.com/get/percona-toolkit.tar.gz<br/>wget percona.com/get/percona-toolkit.rpm<br/>wget percona.com/get/percona-toolkit.deb</span></pre><p id="d52c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">样本用法:</strong></p><pre class="je jf jg jh fd lx jx ly lz aw ma bi"><span id="5802" class="mb kg hi jx b fi mc md l me mf">pt-online-schema-change --host &lt;HOST&gt; --user &lt;DB_USER&gt; --ask-pass  --alter "add column &lt;YOUR_COLUMN_NAME&gt;" D=&lt;DATABASE&gt;,t=&lt;TABLE&gt; --execute</span></pre><p id="a5a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">强制选项:</strong></p><ol class=""><li id="47a8" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated"><strong class="ih hj"> —主机:</strong>在此指定数据库主机</li><li id="71e5" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —询问-通过:</strong>在执行时询问密码或使用<br/> <strong class="ih hj"> —密码</strong>:在命令本身中输入密码</li><li id="b802" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> — alter: </strong>要运行的alter命令</li><li id="4653" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> — D </strong>:您的数据库的名称</li><li id="5b0f" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> — T </strong>:表格名称</li><li id="4a2a" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —执行:</strong>由于安全原因，这必须被指定</li></ol><h1 id="635d" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><strong class="ak">其他有用的选项</strong></h1><ol class=""><li id="eaa9" class="le lf hi ih b ii ls im lt iq mg iu mh iy mi jc lj lk ll lm bi translated"><strong class="ih hj"> —模拟运行:</strong>顾名思义，它不执行ALTER TABLE，而是检查所有内容，并检查运行命令时可能出现的问题。您可以将此视为对查询<br/>的模拟修改(这不能与<strong class="ih hj"> — execute、</strong>一起使用，两者是互斥的)</li><li id="c899" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj">—alter-foreign-keys-method:</strong>涉及外键的修改是很棘手的。这里可用的一些选项有:<br/><strong class="ih hj">—rebuild _ constraints:</strong>该方法删除并重新添加引用新表的外键。这通常是首选，除非子表太大，改变它们需要很长时间。<br/> <strong class="ih hj"> drop_swap: </strong>该选项将禁用外键检查，然后删除原始表，接着将新表重命名到它的位置。这种重命名操作不是原子的，因此风险更大，因为原始表在很短的时间间隔内不存在，这可能导致查询失败。<br/> <strong class="ih hj"> auto: </strong>让Percona决定什么最适合你的桌子。</li><li id="4702" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —检查-更改:</strong>检查更改命令，并在可能出现意外行为时发出警告</li><li id="c2d3" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> — check-slave-lag: </strong>如果副本滞后大于<strong class="ih hj"> — max-lag </strong>，暂停数据复制</li><li id="80cf" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —块大小:</strong>定义数据块的行数。(数据以块的形式复制)</li><li id="080f" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —临界负载:</strong>复制完每个块后，Percona会检查状态，如果负载过高，则会中止。您可以添加一个逗号分隔的MySql状态变量和阈值列表</li><li id="92e9" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —删除新表:</strong>控制如果数据复制失败，是否删除新表</li><li id="58d8" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —删除旧表:</strong>控制操作完成后是否要删除旧表</li><li id="2218" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —打印:</strong>打印工具触发的SQL命令</li><li id="f52c" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —最大延迟:</strong>如果副本延迟超过设定值，则暂停查询</li><li id="506c" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> — max-load: </strong>每个块被复制后，Percona检查状态，如果负载过高，暂停查询</li><li id="ef93" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> —新表格名称:</strong>您可以指定新表格的名称</li><li id="645a" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj"> — sleep: </strong>在复制每个块之间暂停多长时间</li></ol><h1 id="2f79" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">关于用法的一些注意事项</h1><ol class=""><li id="249f" class="le lf hi ih b ii ls im lt iq mg iu mh iy mi jc lj lk ll lm bi translated">如果表中没有主键或唯一索引，这种改变将不起作用。</li><li id="fdc8" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">除非指定了foreign key选项，否则ALTER将不适用于带有外键的表。(<em class="kb">在选项部分勾选# 2)</em></li><li id="236a" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">如果负载过大或检测到从属滞后，该工具会自动暂停。这些值可以使用命令行选项来控制。</li><li id="f19c" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">在这里追踪已知的bugs】。</li><li id="adec" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">根据文档，它适用于<code class="du ju jv jw jx b">Percona XtraDB Cluster (PXC) 5.5.28–23.7</code>,但在我们的测试中，它适用于MySQL 5.7，查看下一节了解更多信息。</li></ol><h1 id="042d" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">测试执行结果</h1><p id="6e5b" class="pw-post-body-paragraph if ig hi ih b ii ls ik il im lt io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">以下是对结果的一些观察:</p><p id="79c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果直接在MySql上执行ALTER TABLE，执行时间大致相同，但是对应用程序读/写流量没有影响。</p><p id="e3ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是在<strong class="ih hj">测试数据库</strong>和非生产环境下运行的结果。该表有多个外键关系，记录超过500万条，总执行时间大约为10分钟。</p><p id="1a41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是示例执行输出</p><blockquote class="jy jz ka"><p id="85e2" class="if ig kb ih b ii ij ik il im in io ip kc ir is it kd iv iw ix ke iz ja jb jc hb bi translated">(注意:为了保密，隐藏了数据库和表名):</p></blockquote><pre class="je jf jg jh fd lx jx ly lz aw ma bi"><span id="f64c" class="mb kg hi jx b fi mc md l me mf">Not checking slave lag because no slaves were found and --check-slave-lag was not specified.<br/>Operation, tries, wait:<br/>  analyze_table, 10, 1<br/>  copy_rows, 10, 0.25<br/>  create_triggers, 10, 1<br/>  drop_triggers, 10, 1<br/>  swap_tables, 10, 1<br/>  update_foreign_keys, 10, 1<br/>Child tables:<br/>  `&lt;DATABASE&gt;`.`&lt;TABLEA&gt;` (approx. 257042 rows)<br/>  `&lt;DATABASE&gt;`.`&lt;TABLEB&gt;` (approx. 1194 rows)<br/>  `&lt;DATABASE&gt;`.`&lt;TABLEC&gt;` (approx. 931229 rows)<br/>Will automatically choose the method to update foreign keys.<br/>Altering `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`...<br/>Creating new table...<br/>Created new table &lt;DATABASE&gt;._&lt;TABLE&gt;_new OK.<br/>Altering new table...<br/>Altered `&lt;DATABASE&gt;`.`_&lt;TABLE&gt;_new` OK.<br/>2021-10-08T19:11:08 Creating triggers...<br/>2021-10-08T19:11:08 Created triggers OK.<br/>2021-10-08T19:11:08 Copying approximately 5564340 rows...<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:   6% 06:39 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  15% 05:39 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  23% 04:56 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  31% 04:23 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  37% 04:09 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  45% 03:34 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  53% 03:01 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  60% 02:35 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  65% 02:20 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  72% 01:52 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  80% 01:21 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  86% 00:55 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  92% 00:32 remain<br/>Copying `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`:  99% 00:02 remain<br/>2021-10-08T19:18:19 Copied rows OK.<br/>2021-10-08T19:18:19 Max rows for the rebuild_constraints method: 28380<br/>Determining the method to update foreign keys...<br/>2021-10-08T19:18:19   `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`: too many rows: 257042; must use drop_swap<br/>2021-10-08T19:18:19 Drop-swapping tables...<br/>2021-10-08T19:18:19 Analyzing new table...<br/>2021-10-08T19:18:19 Dropped and swapped tables OK.<br/>Not dropping old table because --no-drop-old-table was specified.<br/>2021-10-08T19:18:19 Dropping triggers...<br/>2021-10-08T19:18:19 Dropped triggers OK.<br/>Successfully altered `&lt;DATABASE&gt;`.`&lt;TABLE&gt;`.</span></pre><p id="d7d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="7ec1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该工具提供了许多特性，可以安全地在大型生产表上执行变更。但是，在使用这个工具之前，应该注意一些值得注意的事情。此外，文档建议在生产环境中运行该命令之前，在测试环境中进行<a class="ae jt" href="https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html#risks" rel="noopener ugc nofollow" target="_blank">生产备份</a>和测试。</p></div><div class="ab cl mj mk gp ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hb hc hd he hf"><p id="da69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你需要更多的帮助，请随时联系我。请务必关注所有新的更新。谢谢你的阅读。干杯🍺</p></div></div>    
</body>
</html>