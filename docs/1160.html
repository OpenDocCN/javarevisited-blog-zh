<html>
<head>
<title>Basic example to use Apache Kafka as communication between Microservices.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apache Kafka作为微服务间通信的基本示例。</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/basic-example-to-use-apache-kafka-as-communication-between-mircoservices-a097b4005a50?source=collection_archive---------0-----------------------#2021-04-19">https://medium.com/javarevisited/basic-example-to-use-apache-kafka-as-communication-between-mircoservices-a097b4005a50?source=collection_archive---------0-----------------------#2021-04-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d6e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将把apache Kafka与<a class="ae jd" rel="noopener" href="/javarevisited/10-best-java-microservices-courses-with-spring-boot-and-spring-cloud-6d04556bdfed"> spring-boot微服务</a>整合为一种沟通模式。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/f997d7415e9a664259cbb4a0234cecb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*6YobXcU6KkJX_E1uWnNbCQ.png"/></div></figure><p id="1889" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将有两个微服务—</p><ol class=""><li id="3dcf" class="jm jn hi ih b ii ij im in iq jo iu jp iy jq jc jr js jt ju bi translated">发布者(将发送消息的服务)</li><li id="96d7" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">订户(将使用消息的服务)</li></ol><p id="d997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">先决条件&amp;设置:</strong></p><blockquote class="ka kb kc"><p id="1b6e" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated">步骤1 — <strong class="ih hj">下载并运行</strong> <a class="ae jd" href="https://zookeeper.apache.org/releases.html#download" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Zookeeper </strong> </a>。(用于跟踪kafka节点的状态，并存储基本元数据，如关于主题、经纪人、消费者补偿的信息)</p><p id="9ad4" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated">注意—如果您在运行zookeeper服务时遇到有关配置文件的错误，请尝试将配置文件名更改为“<strong class="ih hj">zoo . CFG”</strong>。</p></blockquote><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="00e3" class="km kn hi ki b fi ko kp l kq kr">Bash from zookeeper root — <strong class="ki hj">sh bin/zkServer.sh start</strong></span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ks"><img src="../Images/1f0c83a249ab1c10cfc25fdb093b10e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FD_qPCQn0JoJGbJ6Q6x1Hw.png"/></div></div></figure><blockquote class="ka kb kc"><p id="fd29" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated">步骤2 —下载并运行kafka服务器/代理。</p></blockquote><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="7007" class="km kn hi ki b fi ko kp l kq kr">Bash from kafka root — <strong class="ki hj">bin/kafka-server-start.sh config/server.properties</strong></span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kx"><img src="../Images/cb210f3899a429e506665ad091d17af5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CGXyL-bzO5lbg6f2R2MLuQ.png"/></div></div></figure><h1 id="cbbc" class="ky kn hi bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">现在我们准备使用我们的微服务，它将作为使用这个Kafka broker的发布者和订阅者。</h1><h1 id="8eba" class="ky kn hi bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Publisher Springboot应用程序:</h1><p id="6339" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">我已经创建了一个rest端点，我们将使用它向<a class="ae jd" rel="noopener" href="/javarevisited/top-10-apache-kafka-online-training-courses-and-certifications-621f3c13b38c"> Kafka </a>代理发布消息。</p><p id="76f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">依赖关系</strong>:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><a href="https://javarevisited.blogspot.com/2018/04/top-5-apache-kafka-course-to-learn.html#axzz6kZHuJeAZ"><div class="er es ma"><img src="../Images/43cd81ef8d43fbb61854d543c1400ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pYHWAFZIZG4XadU-RkYAdw.png"/></div></a></figure><p id="6d99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">应用程序.属性:</strong></p><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="e5e3" class="km kn hi ki b fi ko kp l kq kr">server.port=9041</span><span id="53dc" class="km kn hi ki b fi mb kp l kq kr">spring.kafka.producer.key-serializer = org.apache.kafka.common.serialization.StringSerializer</span><span id="765a" class="km kn hi ki b fi mb kp l kq kr">spring.kafka.producer.value-serializer = org.apache.kafka.common.serialization.StringSerializer</span><span id="f2ee" class="km kn hi ki b fi mb kp l kq kr">spring.kafka.producer.bootstrap-servers=localhost:9092</span></pre><p id="cd17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的pub应用程序将在9041上运行，这里需要注意的一个属性是“<strong class="ih hj">spring . Kafka . producer . bootstrap-servers</strong>”，这是我们的代理运行的服务器主机&amp;端口。</p><p id="c3c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在<strong class="ih hj"> server.properties </strong>文件的kafka directory config文件夹中检查您的代理配置。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mc"><img src="../Images/ddade49b5310ee353d403d3886c43a08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*88JvrH7Wr9lVf1kAe_ol9A.png"/></div></div></figure><p id="b7cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://javarevisited.blogspot.com/2017/08/difference-between-restcontroller-and-controller-annotations-spring-mvc-rest.html#ixzz6OYNB9oii" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">控制器</strong> </a> <strong class="ih hj"> : </strong></p><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="b0fc" class="km kn hi ki b fi ko kp l kq kr">@RestController<br/>@RequestMapping(value = "/archive")<br/>public class Controller {</span><span id="897a" class="km kn hi ki b fi mb kp l kq kr">private final Publisher producer;</span><span id="2ec9" class="km kn hi ki b fi mb kp l kq kr">@Autowired<br/>public Controller(Publisher producer) {<br/>this.producer = producer;<br/>  }</span><span id="5f94" class="km kn hi ki b fi mb kp l kq kr">@GetMapping<br/>public void sendMessageToKafkaTopic(@RequestParam("message") String message){<br/>     this.producer.sendMessage(message);<br/>  }<br/>}</span></pre><p id="4bbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">发布者服务:</strong></p><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="85c3" class="km kn hi ki b fi ko kp l kq kr">@Service<br/>public class Publisher {</span><span id="360f" class="km kn hi ki b fi mb kp l kq kr">   private static final Logger logger = LoggerFactory.getLogger(Publisher.class);<br/>   private static final String TOPIC = "archived_docs";</span><span id="4707" class="km kn hi ki b fi mb kp l kq kr">   @Autowired<br/>   private KafkaTemplate&lt;String,String&gt; kafkaTemplate;</span><span id="a362" class="km kn hi ki b fi mb kp l kq kr">public void sendMessage(String message){</span><span id="1072" class="km kn hi ki b fi mb kp l kq kr">    logger.info(String.format("$$ -&gt; Producing message --&gt; %s",message));</span><span id="f43b" class="km kn hi ki b fi mb kp l kq kr">    this.kafkaTemplate.send(TOPIC,message);<br/>  }<br/>}</span></pre><p id="5b83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到，消息将要发布到的主题是<strong class="ih hj">“archived _ docs”</strong>。</p><h1 id="5233" class="ky kn hi bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">订户Springboot应用程序:</h1><p id="cfd0" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated"><strong class="ih hj">依赖关系</strong>:与发布者相同。</p><p id="5447" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">应用程序.属性:</strong></p><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="0ca6" class="km kn hi ki b fi ko kp l kq kr">server.port = 9042</span></pre><p id="d32d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以直接创建一个服务来监听来自Kafka broker的消息。</p><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="8f93" class="km kn hi ki b fi ko kp l kq kr">@Service<br/>public class Subscriber {</span><span id="ab6d" class="km kn hi ki b fi mb kp l kq kr">private final Logger logger = LoggerFactory.getLogger(Subscriber.class);</span><span id="8d4a" class="km kn hi ki b fi mb kp l kq kr">@KafkaListener(topics = "archived_docs", groupId = "archived")<br/>public void consume(String message){<br/>   logger.info(String.format("$$ -&gt; Consumed Message -&gt; %s",message));</span><span id="9af4" class="km kn hi ki b fi mb kp l kq kr">   }<br/>}</span></pre><p id="5c41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此处，该服务正在监听主题为“<strong class="ih hj"> archived_docs </strong>”的传入消息。一旦该服务使用了消息，我们就将其记录在控制台中。</p><p id="9564" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在公布一些消息吧:</p><p id="b245" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的发布器运行在9041上，我们调用API来发布吧。</p><pre class="jf jg jh ji fd kh ki kj kk aw kl bi"><span id="b4c1" class="km kn hi ki b fi ko kp l kq kr"><a class="ae jd" href="http://localhost:9041/archive?message=kuttiStory" rel="noopener ugc nofollow" target="_blank">http://localhost:9041/archive?message=kuttiStory</a></span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es md"><img src="../Images/6051bc0d1bc0112e80b9ea5482678571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6mHDIdlcBbSf1lT8kTs7pA.png"/></div></div></figure><p id="4f05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我们检查订阅者日志，我们应该会看到使用的消息。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es me"><img src="../Images/f0a34b8cfe70f1d2a8487f04142e3708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A9g38to3O3cn68l2yjDFbQ.png"/></div></div></figure><blockquote class="ka kb kc"><p id="04f9" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated">PS——Kafka的主要优点之一是它使微服务松散耦合。一个微服务可以只发布消息，而不关心另一个服务何时/是否得到它，它的工作(发布消息)就完成了。假设消费者应用程序宕机。没问题。当它再次运行时，消费者应用程序将在它启动运行时收到该消息。</p></blockquote><p id="4658" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你自己试试，停止消费者app，打生产者API，当你再次启动消费者app的时候，它就会消费消息。</p><p id="9291" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是基本的kafka工作流程。</p><p id="698d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><p id="150f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://www.youtube.com/watch?v=NjHYWEV_E_o" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=NjHYWEV_E_o</a></p></div></div>    
</body>
</html>