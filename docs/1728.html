<html>
<head>
<title>How to select a Partition Key in Azure Cosmos DB? Partition Key Strategies?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Azure Cosmos DB中选择分区键？分区关键策略？</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/how-to-select-a-partition-key-in-azure-cosmos-db-partition-key-strategies-f44ba134790e?source=collection_archive---------4-----------------------#2021-11-12">https://medium.com/javarevisited/how-to-select-a-partition-key-in-azure-cosmos-db-partition-key-strategies-f44ba134790e?source=collection_archive---------4-----------------------#2021-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c37a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将讨论在选择分区键时必须考虑的因素。如果你还不熟悉Azure Cosmos DB，我已经分享了另一篇关于它的关键信息的文章。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/f7b75c3ff1219df2098c59e98afda030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*udxL-Xvwl8Y_00_u"/></div></div><p class="jq jr et er es js jt bd b be z dx translated"><a class="ae jd" href="https://unsplash.com/@sincerelymedia?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">真诚媒体</a>在<a class="ae jd" href="https://unsplash.com/s/photos/database?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="f747" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated"><strong class="ak">通用指南</strong></h1><p id="13ab" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">让我们来看看分区键的一些原理。</p><h2 id="499f" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">1.不可变属性</h2><p id="693d" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">是一个值不变的属性。如果一个属性是您的分区键，您不能更新该属性的值。</p><h2 id="eb77" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">2.高基数</h2><p id="0472" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">属性应该具有广泛的可能值和独特的。这将有助于确保逻辑分区尽可能小，从而允许更多的请求单元(RU)消耗。</p><h2 id="eb61" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated"><strong class="ak"> 3。跨逻辑分区均匀分布数据</strong></h2><p id="7e9f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">类似于第2点，这有助于确保在物理分区上均匀的RU消耗和存储分布。</p><h1 id="e2da" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">要注意的其他检查点</h1><h2 id="e3d1" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">不会导致逻辑分区超过20GB</h2><p id="7489" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">每个逻辑分区最多只能增长到20GB。</p><h2 id="877a" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated"><strong class="ak">事务范围在单个逻辑分区内</strong></h2><p id="e13a" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">如果您需要Azure Cosmos DB中的<a class="ae jd" href="https://docs.microsoft.com/en-us/azure/cosmos-db/database-transactions-optimistic-concurrency#multi-item-transactions" rel="noopener ugc nofollow" target="_blank">多项ACID事务</a>，您将需要使用<a class="ae jd" href="https://docs.microsoft.com/en-us/azure/cosmos-db/how-to-write-stored-procedures-triggers-udfs#stored-procedures" rel="noopener ugc nofollow" target="_blank">存储过程或触发器</a>。所有基于JavaScript的存储过程和触发器都限定在一个逻辑分区内。</p><p id="c621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如果使用itemId作为分区键，就不可能通过存储过程/触发器进行批量导入。然而，这并不是完全不可能的，你可以看看他们的<a class="ae jd" href="https://docs.microsoft.com/en-us/azure/cosmos-db/bulk-executor-overview" rel="noopener ugc nofollow" target="_blank">批量执行器库</a>，这两个库都可用。NET和Java。</p><h2 id="dcf6" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated"><strong class="ak">调配的吞吐量均匀分布在物理分区中</strong></h2><p id="23c3" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">容器的吞吐量均匀地分布在物理分区中。如果您的分区键没有将数据均匀地分布在不同的物理分区中，一些分区就有可能变得“热”起来，并且可能会发生速率限制(即节流)。如果您预计总数据大小将需要多个物理分区，这一点很重要。</p><blockquote class="ll lm ln"><p id="f796" class="if ig lo ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">“热”分区是指有太多的请求指向一小部分分区。</p></blockquote><p id="e121" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你的分区键给了你最小的逻辑分区吗？使用较小的逻辑分区，您可以避免对另一个物理分区的不必要的需求，这样您所提供的吞吐量就必须在不同的物理分区之间共享。下图展示了在一个数据总量为100 GB的示例中，根据逻辑分区的大小需要多少物理分区的差异。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ls"><img src="../Images/6e3a188938d2f8474acd2b94a897752c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9l1SGww3VxNOkZbmoqwPMA.png"/></div></div></figure><h2 id="b16d" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">有跨分区查询吗？</h2><p id="219f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">确定应用程序所需的查询非常重要。同样，如果您有大量数据，建议您尽可能避免跨分区查询。在这种情况下，跨分区查询将导致高RU成本。</p><h1 id="b9f2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">读/写重型系统</h1><p id="856c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">总体而言，根据您需要的数据库类型，您可能会侧重于要满足的不同条件:</p><ul class=""><li id="96ab" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc ly lz ma mb bi translated">Read heavy system <br/> -分区键存在于所有(如果不是大多数)查询中(以防止跨分区查询)<br/> -分发并发查询</li><li id="6fda" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated">写繁重系统<br/>——将并发写分布在大范围的值上</li></ul><h1 id="e56c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">例子</h1><p id="61de" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们来看一下使用物联网场景的两种分区键选择。</p><ol class=""><li id="8260" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc mh lz ma mb bi translated">通过IoTId</li><li id="129f" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc mh lz ma mb bi translated">到一周前</li></ol><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mi"><img src="../Images/4f0eb763f4b669c85eeb96493a82d3da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8c1wfUzjrfwlRqOlkOWFJw.png"/></div></div><p class="jq jr et er es js jt bd b be z dx translated">数据示例</p></figure><p id="0fcc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在左侧，每个物联网设备的数据量似乎大致相同。如果您的查询总是通过IoTId，这将有助于您直接进入相应的分区。但是，如果您预见到任何设备的数据将超过最大逻辑分区大小(20GB)，您必须考虑一个计划。</p><p id="4612" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在右侧，使用一周中的某一天，如果在特定的几天碰巧有更多的数据，可能会有问题(如第一个条形所示)。这将导致数据的不均匀分布，从而产生我们不想要的“热”分区。</p></div><div class="ab cl mj mk gp ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hb hc hd he hf"><h1 id="0b2b" class="ju jv hi bd jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr bi translated">我的所有属性都不适合作为分区键</h1><p id="de42" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">你可以考虑使用<a class="ae jd" href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql/synthetic-partition-keys" rel="noopener ugc nofollow" target="_blank">合成分区键</a>。合成分区键是组合属性以形成分区键的概念。</p><p id="fbd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你所要做的就是包括那个地层的另一个属性。例如/partitionKey = itemId + month</p></div><div class="ab cl mj mk gp ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hb hc hd he hf"><h1 id="aa2c" class="ju jv hi bd jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr bi translated">结论</h1><p id="e19c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">以上解决了在决定分区键时应该考虑的大部分因素。您可能找不到满足所有这些条件的完美分区键，但是只要满足其中的大多数条件(基于您的应用程序需求，即大多数常用查询)，它就应该为您提供“最佳”性能。</p><p id="5321" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">祝你好运，并祝你在Azure Cosmos DB的旅程愉快！😁</p><p id="6b59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>