<html>
<head>
<title>When Disaster Strikes: Production Troubleshooting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">灾难来袭时:生产故障排除</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/when-disaster-strikes-production-troubleshooting-8b15b5a78cc1?source=collection_archive---------1-----------------------#2022-05-04">https://medium.com/javarevisited/when-disaster-strikes-production-troubleshooting-8b15b5a78cc1?source=collection_archive---------1-----------------------#2022-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f06cf61a20323d93381cc88322361bf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HKuoxl6TdlldkmPqYcN7iA.png"/></div></div></figure><p id="e99c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">汤姆·格兰诺和<a class="ae jo" href="https://twitter.com/debugagent/" rel="noopener ugc nofollow" target="_blank">本人</a>有幸成为<a class="ae jo" href="https://twitter.com/vlad_mihalcea" rel="noopener ugc nofollow" target="_blank">弗拉德·米哈尔恰的</a>在线公司已经有一段时间了。因此，我们决定<a class="ae jo" href="https://go.lightrun.com/production-troubelshooting-masterclass" rel="noopener ugc nofollow" target="_blank">一起开一个研讨会</a>讨论我们在这个过程中学到的很多东西。这个研讨会是非常非正式的，只是一群人聊天，炫耀我们可以用工具做什么。</p><p id="e8e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了庆祝这一点，我想我应该写下一些我们过去讨论过的技巧，让你对加入我们的研讨会有所了解，这本身也是一个有用的工具。</p><h1 id="8f45" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">问题是</h1><p id="12b5" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在开始之前，我想花点时间谈谈生产和开发人员在生产环境中的角色。作为一名黑客，我经常做任何事情。这对小公司来说没问题，但随着公司的发展，我们会增加流程。</p><p id="7e45" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">生产不会像以前那样被烧毁。感谢staging，QA，CI/CD和<a class="ae jo" rel="noopener" href="/javarevisited/13-best-courses-to-learn-devops-for-senior-developers-in-2020-a2997ff7c33c"> DevOps </a>对我这样的人进行控制…</p><p id="5009" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以我们把这些东西都准备好了。我们通过了质量保证和测试，一切都很完美。对吗？</p><figure class="kt ku kv kw fd ij er es paragraph-image"><a href="https://javarevisited.blogspot.com/2020/04/top-5-books-to-learn-devops-for-developers.html"><div class="er es ks"><img src="../Images/543896b5bde1525c557f217bf87c3434.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*e8FpJXJbemCLpy5U"/></div></a></figure><p id="b0d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嗯……不完全是。</p><p id="f99c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然可以。<a class="ae jo" rel="noopener" href="/javarevisited/top-5-online-courses-to-become-a-devops-engineer-in-2020-764f5e60c2b">现代DevOps </a>极大地改变了生产质量、监控和性能。毫无疑问。但是bug是不可避免的。那些溜进来的是最坏的害虫。它们很难被发现，而且通常只会大规模发生。</p><p id="8724" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一些问题，比如性能问题。只有在生产数据库中才会被注意到。试运行或开发环境无法完全复制现代复杂部署。基础设施即代码(IaC)在这方面很有帮助，但即使有这样的解决方案，生产的规模也是不同的。</p><h1 id="5b68" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">这是唯一真正重要的地方</h1><p id="363c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">所有非生产性的东西都已就位，以方便生产。就是这样。我们可以有最好的和最广泛的测试。100%覆盖我们的本地环境。但是当我们的系统在生产中运行时，行为就不同了。我们不能完全控制它。</p><p id="4e1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">膝跳反应是“更多的测试”。我经常看到这种情况。如果我们对此有一个测试就好了…解决方案是想出我们可能犯的每一个错误，并为此建立一个测试。这太疯狂了。如果我们知道错误，我们就可以避免它。认为不同的团队成员会有这种洞察力的想法也是错误的。人们会犯类似的错误，虽然我们可以用这种方法消除一些错误。更多的测试产生更多的问题… <a class="ae jo" rel="noopener" href="/javarevisited/7-best-courses-to-learn-jenkins-and-ci-cd-for-devops-engineers-and-software-developers-df2de8fe38f3"> CI/CD </a>变得更慢，导致生产部署时间更长。</p><p id="9dae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这意味着当我们有生产缺陷时。由于冗余测试，修复时间会更长。这意味着我们需要经历的整个CI质量流程将需要更长的时间。这也意味着我们需要在CI资源上投入更多资金…</p><h1 id="2c98" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">记录</h1><p id="e962" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><a class="ae jo" href="https://javarevisited.blogspot.com/2011/05/top-10-tips-on-logging-in-java.html" rel="noopener ugc nofollow" target="_blank">日志</a>解决了一些问题。它是任何服务器基础设施的重要组成部分。但是问题与我们在测试中遇到的问题相似。</p><p id="0e26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我们写日志时，我们不知道什么是重要的。那么在生产中我们可能会发现它不见了。过度日志是相反方向的一个巨大问题。它可以:</p><ul class=""><li id="a970" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">破坏性能和缓存</li><li id="8b1d" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">因日志保留而产生巨额成本</li><li id="5022" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">由于冗长难懂，使得<a class="ae jo" href="https://javarevisited.blogspot.com/2011/07/java-debugging-tutorial-example-tips.html" rel="noopener ugc nofollow" target="_blank">调试</a>更加困难</li></ul><p id="ccd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它可能仍然缺少我们需要的信息…</p><p id="ee53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我最近在reddit的一个帖子里也发表了这样的评论:</p><p id="319b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">“我公司的一个团队在几天时间里意外地在Azure Log Analytics上浪费了大约100k。他们将日志记录的详细程度设置到了一个迄今为止还没有测试过的水平，并且加入了一些额外的副本。当他们在Slack上宣布他们的错误时，我了解到，是的，的确有日志记录过多这种事情。”—全螺纹<a class="ae jo" href="https://www.reddit.com/r/devops/comments/udgohy/there_is_no_such_thing_as_too_much_logging_or_is/" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><p id="9456" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还是那句话，<a class="ae jo" href="https://javarevisited.blogspot.com/2016/06/why-use-log4j-logging-vs.html" rel="noopener ugc nofollow" target="_blank">日志</a>很棒。但并没有解决核心问题。</p><h1 id="1a63" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">灵活</h1><p id="8573" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们的开发团队需要快速响应。我们需要对问题做出快速反应。当然，我们需要首先尝试并阻止它们…但是像生活中的大多数事情一样，收益递减规律在这里也是有效的。测试、日志等都有限制。</p><p id="15d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我们需要尽快全面了解这个bug。根据直觉进行局部复制的过程充其量是有问题的。我们需要一种观察问题的方法。</p><p id="71fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这并不新鲜。有很多解决方案可以解决生产中的问题，例如，APM工具为我们提供了对生产绩效的宝贵见解。他们不会取代侧写员。它们提供了一个重要的数据点:我们的客户使用的应用程序有多快！</p><p id="ad1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是这些工具中的大多数都是面向开发的。有道理。开发人员是负责生产的人，所以监控工具自然是为他们设计的。但是DevOps不应该负责修复R&amp;D bug，甚至不应该负责理解它们……这里有一个脱节。</p><h1 id="39bf" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">输入开发者可观察性</h1><p id="fd76" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">开发人员可观察性是针对开发人员的可观察性的支柱，而不是针对<a class="ae jo" rel="noopener" href="/javarevisited/7-free-google-cloud-devops-engineer-certification-courses-f0046ac39f7e"> DevOps </a>。有了这个领域的工具，我们可以立即获得符合我们需求的反馈，减少发现问题的麻烦。在这些工具之前，如果生产中不存在日志，并且我们不了解问题…我们必须用“更多日志”重新部署我们的产品，并祈祷好运…</p><h1 id="4a09" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">在实践和研讨会中…</h1><p id="3a2e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我解释问题的时间比解释解决方案的时间要长。我倾向于认为，这是因为一旦我们“明白”了，解决方案就显而易见了。主要是细节问题。</p><p id="bfc0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就像我们都知道的:细节决定成败…</p><p id="03be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">开发人员可观察性<a class="ae jo" rel="noopener" href="/javarevisited/10-essential-tools-data-scientists-should-learn-in-2022-acbae6558643">工具</a>对于习惯于使用调试器和<a class="ae jo" rel="noopener" href="/javarevisited/7-best-courses-to-learn-intellij-idea-for-beginners-and-experienced-java-programmers-2e9aa9bb0c05">ide</a>的开发人员来说可能非常熟悉。但是它们还是有很大的不同。断点就是一个例子。</p><h1 id="782d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">现在是快照了</h1><p id="4565" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们都知道这种训练。在不起作用的代码中设置一个断点，然后单步执行，直到找到问题。这在我们的流程中根深蒂固，以至于我们很少停下来思考这个问题。</p><p id="4807" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，如果我们在生产环境中这样做，服务器将在等待我们跨越时被卡住。这可能会影响服务器中的所有用户，我甚至不会讨论安全性/稳定性的影响(你还不如拿把锤子把服务器拆了。有那么差)。</p><p id="4c46" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">快照做断点做的一切。它们可以是有条件的，比如条件断点。它们包含堆栈跟踪，您可以单击堆栈中的元素。每一帧都包括该特定帧中变量的值。但问题是:他们不会停下来。</p><p id="c65d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以你没有“跨过”这个选项。这一部分是不可避免的，因为我们没有停止。你需要重新思考调试错误的过程。</p><h1 id="f123" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">currentTimeMillis()</h1><p id="00e4" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我喜欢侧写师。但是当我需要真正理解一个方法的成本时，我会去找我信任的老<code class="du ll lm ln lo b">currentTimeMillis()</code>调用。没有其他方法可以在小代码块上获得准确/一致的性能指标。</p><p id="3fbf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但正如我之前所说。生产才是最重要的。我不能只是在代码上贴满微度量，然后再检查。</p><p id="ba4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以开发者可观察性工具增加了测量事物的能力。计算到达一行代码的次数。或者字面上执行相当于<code class="du ll lm ln lo b">currentTimeMillis()</code>方法tictoc测量。</p><h1 id="16e4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">在那里见</h1><p id="53d6" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">"只有退潮时，你才会发现谁在裸泳。"—沃伦·巴菲特</p><p id="7d8e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我喜欢这句话。我们需要时刻做好准备。我们需要快速行动，做好最坏的打算。但是我们也需要实用性。我们不是原创，有常见的bug，我们会左右逢源。我们可能会更快地注意到它们，但错误并不是原创的。</p><p id="fd1c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在研讨会中，我们将关注一些最常见的错误，并演示如何使用开发人员可观察性来跟踪它们。我们将给出现实世界中的例子，说明我们在过去和工作中遇到的失败和问题。我对此感到非常兴奋，希望能在<a class="ae jo" href="https://go.lightrun.com/production-troubelshooting-masterclass" rel="noopener ugc nofollow" target="_blank">见到大家</a>！</p></div></div>    
</body>
</html>