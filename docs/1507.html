<html>
<head>
<title>Using Interceptor in a Spring Boot API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Spring Boot API中使用拦截器</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/using-interceptor-in-a-spring-boot-api-9d7a0781dd19?source=collection_archive---------0-----------------------#2021-08-28">https://medium.com/javarevisited/using-interceptor-in-a-spring-boot-api-9d7a0781dd19?source=collection_archive---------0-----------------------#2021-08-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/cfeec99c1afcf39c99eceadd9fe060ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W58wBRcbYfmPqlyn.png"/></div></div></figure><p id="09d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">出于多种原因，有必要拦截对API路由的请求，其中一些原因可能是:</p><ul class=""><li id="894d" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">认证；</li><li id="797b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">记录输入数据；</li><li id="fb5b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">为请求响应生成一些信息；</li><li id="cfb5" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">和许多其他事情；</li></ul><p id="fd81" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个api示例中，我将执行以下操作:</p><ul class=""><li id="dca5" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">标题中某些字段的验证；</li><li id="9b94" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">匿名请求的许可(没有上面提到的验证)；</li><li id="e7ea" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在响应标头中包含某些字段；</li></ul><p id="981b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先要做的是创建项目。你可以在这里做:<a class="ae kc" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank">https://start.spring.io/</a></p><p id="fb20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我有一些其他的文本，显示了如何创建项目，请求，数据库crud，我不会在这里重复这些相同的东西。我将设置拦截器并使用它。</p><p id="0399" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于拦截器的重要信息:</p><p id="02a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以使用三种方法:</p><ul class=""><li id="1db6" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj"> preHandle() </strong>这个方法用于对发送到控制器的请求执行一些操作。</li><li id="45c1" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj"> postHandle() </strong>这个方法用于对发送给客户端的响应执行一些操作。</li><li id="78d0" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj"> afterCompletion() </strong>该方法用于在请求和响应后执行动作。</li></ul><p id="d4c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我从preHandle()开始验证一个字段，我称之为“Authorization ”,并将在请求头中发送。</p><p id="2fee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我在控制器中创建了一个带有简单健康检查的方法:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="e7a9" class="km kn hi ki b fi ko kp l kq kr">@Slf4j<br/>@Component<br/>public class Interceptor implements HandlerInterceptor {<br/><br/>    @Override<br/>    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {<br/>        log.info("Request intercepted: " + request.getHeader("Authorization"));<br/>        return true;<br/>    }<br/><br/>}</span></pre><p id="cd25" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我注册了这个拦截器:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="83f3" class="km kn hi ki b fi ko kp l kq kr">@RequiredArgsConstructor<br/>@Component<br/>public class ConfigInterceptor extends WebMvcConfigurerAdapter {<br/><br/>    private final Interceptor interceptor;<br/><br/>    @Override<br/>    public void addInterceptors(InterceptorRegistry registry) {<br/>        registry.addInterceptor(interceptor);<br/>    }<br/><br/>}</span></pre><p id="3dae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦完成，拦截器就可以使用了。</p><p id="be35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">目前，它只是生成一个包含“Authorization”字段内容的日志，您可以通过调用health check:</p><p id="4e39" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<a class="ae kc" rel="noopener" href="/javarevisited/7-best-courses-to-learn-postman-tool-for-web-service-and-api-testing-f225c138fa5a">邮递员</a>的示例:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/84da4ee365f9ad901f2d458832ccdf1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MSDOeoAjopIJuoZX.png"/></div></figure><p id="956c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">日志:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/5981c317cf934256b4462bf7c623ef40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LVAE1SKTKdvIASey.png"/></div></figure><p id="73f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在是时候拦截在这个头中没有特定值的请求了，我修改了拦截器类中的preHandle()方法:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="ddeb" class="km kn hi ki b fi ko kp l kq kr">@Slf4j<br/>@Component<br/>public class Interceptor implements HandlerInterceptor {<br/><br/>    @Override<br/>    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {<br/><br/>        if (request.getHeader("Authorization") == null){<br/>            log.info("Authorization not sent.");<br/>            log.info("Validation NOK.");<br/>            return false;<br/>        }<br/>        else if (request.getHeader("Authorization").equals("Test"))    {<br/>            <br/>log.info("Validation OK.");<br/>            return true;<br/>        } else {<br/>            log.info("Validation NOK.");<br/>            return false;<br/>        }<br/><br/>    }<br/><br/>}</span></pre><p id="a05e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">结果发送相同的直通邮递员，但没有标题:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/2a7a08fda54e6a2a836832ff9be92461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r4jYWQlVA_7ErYDm.png"/></div></figure><p id="567c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并且预期的“200 ok”没有被发送到客户端。</p><p id="200a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">邮差用无效标题发送相同GET的结果:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/b622ffed9a5a18042d23b7e47f132d3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uls88pA81wVcm_AG.png"/></div></figure><p id="e654" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，预期的“200 ok”也没有发送到客户端。</p><p id="5dd3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，发送具有正确值的报头的请求的结果是:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/1f4a70162d30c3bd7138e3d767892314.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VcMvaJLXboiVplGr.png"/></div></figure><p id="c491" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并且200 ok被发送到客户端:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/55a2711de2c70eca474e836ae85889c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K9uoEgSQ9XYzM5vl.png"/></div></figure><p id="64c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好的，我们在头中有一个字段，当被验证时允许或不允许一个请求的成功。但这条路线是一个健康检查，它不会暴露任何敏感的东西，理论上，它可以在没有这项检查的情况下使用。</p><p id="3746" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其结果将是在除“/healthcheck”之外的API的所有其他路由中对报头进行验证。</p><p id="d0cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我采取了几个步骤:</p><p id="df01" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我创建了一个<a class="ae kc" href="https://www.java67.com/2018/07/java-enum-with-constructor-example.html" rel="noopener ugc nofollow" target="_blank">枚举</a>:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="6758" class="km kn hi ki b fi ko kp l kq kr">public enum ValidationType {<br/><br/>    ANNONYMOUS ("Online");<br/><br/>    String value;<br/><br/>    ValidationType(String value){<br/>        this.value = value;<br/>    }<br/><br/>    public String getValue(){<br/>        return value;<br/>    }<br/><br/>}</span></pre><p id="0b10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我在<a class="ae kc" href="https://javarevisited.blogspot.com/2017/08/difference-between-restcontroller-and-controller-annotations-spring-mvc-rest.html#ixzz6OYNB9oii" rel="noopener ugc nofollow" target="_blank">控制器</a>上使用了这个注释:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="5085" class="km kn hi ki b fi ko kp l kq kr">@RestController<br/>public class HealthCheck {<br/><br/>    @AllowAnnonymous<br/>    @GetMapping(value = "/healthcheck")<br/>    public String getHealthCheck(){<br/>        return "200 ok";<br/>    }<br/><br/>}</span></pre><p id="0066" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我更改了preHandle():</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="c2b0" class="km kn hi ki b fi ko kp l kq kr">@Slf4j<br/>@Component<br/>public class Interceptor implements HandlerInterceptor {<br/><br/>    @Override<br/>    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {<br/><br/>        final AllowAnnonymous allowAnnonymous = ((HandlerMethod)handler).getMethod().getAnnotation((AllowAnnonymous.class));<br/><br/>        if(allowAnnonymous != null){<br/>            return true;<br/>        }<br/><br/>        if (request.getHeader("Authorization") == null){<br/>            response.addHeader("Interceptor", "Authorization not sent");            <br/>            log.info("Authorization not sent.");<br/>            log.info("Validation NOK.");<br/>            return false;<br/>        }<br/>        else if (request.getHeader("Authorization").equals("Test")) {<br/>            response.addHeader("Interceptor", "Authorization OK");<br/>            log.info("Validation OK.");<br/>            return true;<br/>        } else {<br/>             <br/>            log.info("Validation NOK.");<br/>            return false;<br/>        }<br/><br/>    }<br/>}</span></pre><p id="6156" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在《邮差》中，你可以看到我回复的标题:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/12d6c157e8234de00c42790f0b372f81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fr5_V5aIrTX-vZaIdl2kpg.png"/></div></div></figure><p id="f91a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是一个需要重构的基本示例，但它也给出了如何使用拦截器的想法。</p><p id="f8bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望有帮助。</p><p id="69cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我把消息来源留在这里:【https://github.com/mmarcosab/interceptor-example T2】</p></div></div>    
</body>
</html>