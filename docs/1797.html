<html>
<head>
<title>Keycloak Integration with External Existing Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与外部现有数据库集成</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/keycloak-integration-with-existing-database-587c119db3ae?source=collection_archive---------1-----------------------#2021-12-08">https://medium.com/javarevisited/keycloak-integration-with-existing-database-587c119db3ae?source=collection_archive---------1-----------------------#2021-12-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9986" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我曾多次使用Keycloak作为身份和访问管理解决方案。我遇到的一个问题是，当我们想将我们的身份验证迁移到keycloak时，我们仍然有许多用户和密码存储在当前的外部数据库中。那么解决办法是什么呢？</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="1921" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题陈述</strong></p><ol class=""><li id="0777" class="jk jl hi ih b ii ij im in iq jm iu jn iy jo jc jp jq jr js bi translated">将身份验证迁移到Keycloak</li><li id="b836" class="jk jl hi ih b ii jt im ju iq jv iu jw iy jx jc jp jq jr js bi translated">现有用户仍在当前数据库中维护(keycloak之外)</li><li id="335a" class="jk jl hi ih b ii jt im ju iq jv iu jw iy jx jc jp jq jr js bi translated">用户唯一id将是其电子邮件</li></ol></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="9239" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案</strong></p><p id="58a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案是:Keycloak的用户联盟。使用这种解决方案，当我们尝试验证用户时，它仍然会查询现有的数据库。如果认证成功，Keycloak将在其<a class="ae jy" href="https://javarevisited.blogspot.com/2018/05/top-5-sql-and-database-courses-to-learn-online.html" rel="noopener ugc nofollow" target="_blank">数据库</a>中创建相似用户，并将认证链接到该用户联盟中。</p><p id="3f98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个解决方案的业务流程如图1所示。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><a href="https://javarevisited.blogspot.com/2019/10/top-5-coursera-professional-certificates-for-programmers-IT-professionals.html"><div class="er es jz"><img src="../Images/9542d0eee45004fd7c54c2ea1c955d4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0cKS7emp8abRXAQt7vhRA.png"/></div></a><p class="kh ki et er es kj kk bd b be z dx translated">图一。使用外部数据库的Keycloak用户联盟</p></figure><p id="2d88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种用户联盟的解决方案可以在我的<a class="ae jy" href="https://github.com/rsatrio/Keycloak-Federation-ExistingDB" rel="noopener ugc nofollow" target="_blank"> github </a>上找到(别忘了给个星)。需要注意几件事:</p><ol class=""><li id="efd7" class="jk jl hi ih b ii ij im in iq jm iu jn iy jo jc jp jq jr js bi translated">创建扩展AbstractUserAdapterFederatedStorage并从keycloak库中实现UserModel的类</li></ol><pre class="ka kb kc kd fd kl km kn ko aw kp bi"><span id="b61d" class="kq kr hi km b fi ks kt l ku kv">public class UserData extends AbstractUserAdapterFederatedStorage  implements UserModel {</span></pre><p id="d523" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建实现UserStorageProvider、UserLookupProvider和CredentialInputValidator的类。不要忘记覆盖isValid()方法。这是执行身份验证过程的方法。</p><pre class="ka kb kc kd fd kl km kn ko aw kp bi"><span id="9272" class="kq kr hi km b fi ks kt l ku kv">public class FederationDBProvider  implements UserStorageProvider,<br/>UserLookupProvider<br/>,CredentialInputValidator</span></pre><p id="836b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.为编号(2)创建工厂类</p><pre class="ka kb kc kd fd kl km kn ko aw kp bi"><span id="5da4" class="kq kr hi km b fi ks kt l ku kv">public class FederationDBProviderFactory implements UserStorageProviderFactory&lt;FederationDBProvider&gt; {</span></pre><p id="7850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.使用keycloak-core和keycloak-server-spi库</p><p id="c90c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.配置keycloak以使用正确的jdbc库和jndi来连接到该数据库</p><p id="d747" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.在<strong class="ih hj"> resources </strong>中创建META-INF/services文件夹，其中包含一个名为"<strong class="ih hj">org . key cloak . storage . userstorageproviderfactory</strong>的文件，该文件包含我们创建的工厂类(在本例中为" com . rizky . key cloak . federationdb . federationdbproviderfactory "类)。</p><p id="7ae2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们结束了。请注意，实际配置将是相当繁琐的。你可以用我的<a class="ae jy" href="https://github.com/rsatrio/Keycloak-Federation-ExistingDB" rel="noopener ugc nofollow" target="_blank"> github repo </a>作为这种场景的起点。如果你有任何问题，请留下你的评论。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="d17c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong></p><ol class=""><li id="06e9" class="jk jl hi ih b ii ij im in iq jm iu jn iy jo jc jp jq jr js bi translated"><a class="ae jy" href="https://github.com/rsatrio/Keycloak-Federation-ExistingDB" rel="noopener ugc nofollow" target="_blank">https://github.com/rsatrio/Keycloak-Federation-ExistingDB</a></li></ol></div></div>    
</body>
</html>