<html>
<head>
<title>Booking System admitting Overbooking</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">允许超售的预订系统</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/booking-system-admitting-overbooking-17ab8984dd5b?source=collection_archive---------3-----------------------#2021-10-19">https://medium.com/javarevisited/booking-system-admitting-overbooking-17ab8984dd5b?source=collection_archive---------3-----------------------#2021-10-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f6f23d93cc70c40d8ce598b82d68cfe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Xx2L54IpD7bIoCMS"/></div></div><p class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@wildlittlethingsphoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">海伦娜·洛佩斯</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="ad6c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<a class="ae iu" rel="noopener" href="/javarevisited/booking-system-with-pessimistic-locks-4ec107e4bd5">上一篇文章</a>中，我描述了如何使用悲观锁构建预订服务。它的主要特点是不允许超额预订。</p><p id="a80f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽管如此，还是会出现超额预定的情况。比如订酒店房间的时候。客户经常取消这些预订，因此超额预订有助于减少客房闲置的机会。如果突然没有人取消预订，酒店通常可以为客人提供更好的房间。</p><h1 id="543d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">超额预订模型</h1><p id="de2f" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">假设我们有10套标准公寓和10套豪华套房。在这种情况下，预订标准间的客人可以入住豪华套房。这将比房间闲置更有利可图。同样假设，我们知道通常有15%的预订被取消。</p><p id="01df" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们需要决定我们准备好允许预订的房间类型——例如，15个标准套房和11个豪华套房。在现实世界中，这种分布很可能由机器学习模型设定，考虑到客户提前预订房间的数量、利润最大化和其他参数。</p><h1 id="a881" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">履行</h1><p id="e4e5" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在解决这个问题变得非常类似于<a class="ae iu" rel="noopener" href="/javarevisited/booking-system-with-pessimistic-locks-4ec107e4bd5">预订而不超额预订</a>，包括锁的获取。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/5df54f8d3638fdaed8e032ab33ab47ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pkGVAteSsTF4NtF7hlAXmA.png"/></div></div><p class="iq ir et er es is it bd b be z dx translated">RDBMS模式的一个例子</p></figure><p id="b5f9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">算法可以是这样的:</p><ol class=""><li id="f159" class="lb lc hi ix b iy iz jc jd jg ld jk le jo lf js lg lh li lj bi translated">使用<code class="du lk ll lm ln b">lock_until</code>栏获取酒店的锁(最长有效期为15-20秒)。</li><li id="9223" class="lb lc hi ix b iy lo jc lp jg lq jk lr jo ls js lg lh li lj bi translated">使用<code class="du lk ll lm ln b">period_start</code>和<code class="du lk ll lm ln b">period_end</code>获取客户日期范围内酒店的所有有效订单。</li><li id="1944" class="lb lc hi ix b iy lo jc lp jg lq jk lr jo ls js lg lh li lj bi translated">根据超额预订模型，检查订单是否符合我们的限制。</li><li id="a0ee" class="lb lc hi ix b iy lo jc lp jg lq jk lr jo ls js lg lh li lj bi translated">创建一个将在5分钟内付款的订单。</li><li id="f958" class="lb lc hi ix b iy lo jc lp jg lq jk lr jo ls js lg lh li lj bi translated">打开酒店的锁。</li></ol><p id="ea4e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果在5分钟内没有付款，订单状态将更改为过期。</p><p id="808c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您不需要带锁来搜索哪些酒店在所选日期可用。</p><h1 id="b0d1" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">多种饲料</h1><p id="f3a9" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">由于用户可以在不同的系统中预订公寓，这项任务可能会变得复杂。假设有人在我们的聚合服务上，有人直接在酒店网站上。</p><p id="82a3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当流程中涉及第三方系统时，我们不能使用分布式事务。因此，同步冲突是不可避免的。我们应该记住这件事，这种情况应该根据业务要求来处理。例如，接受同步后的实际超额预订可能大于给定模型中的超额预订，并让酒店自行处理。或者通过将超额预订限制调整到潜在的同步冲突。</p></div></div>    
</body>
</html>