<html>
<head>
<title>Let’s Learn Together Sessions: Spring Cloud Config Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们一起学习会话:Spring云配置服务器</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/lets-learn-together-sessions-spring-cloud-config-server-17ecd171d86?source=collection_archive---------2-----------------------#2021-09-17">https://medium.com/javarevisited/lets-learn-together-sessions-spring-cloud-config-server-17ecd171d86?source=collection_archive---------2-----------------------#2021-09-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f7a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文揭示了如何使用Spring Cloud Config Server更好地管理配置，这是我们的应用程序中最重要的部分之一。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/924a310404047db4091befe1b829c295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5acPxnWZIz-tBw1o"/></div></div><p class="jp jq et er es jr js bd b be z dx translated">照片由<a class="ae jt" href="https://unsplash.com/@rimakruciene?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rima Kruciene </a>在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="7cf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi ju translated"><span class="l jv jw jx bm jy jz ka kb kc di"> O </span>软件世界的主要组成部分之一，甚至是我们应用程序中最常用的概念是<strong class="ih hj">配置</strong>。配置足够强大，可以改变我们的应用程序的行为。它们还提供了一种灵活的方式来管理我们的应用程序中的工作流。我使用了词语<strong class="ih hj">灵活的</strong>，因为配置既可以在内部<strong class="ih hj">管理</strong>也可以在外部管理<strong class="ih hj">。</strong></p><p id="2809" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在内部，您可以通过使用应用程序配置文件或常量类或变量，在应用程序代码库上保存您的配置。另一方面，由于不是应用程序代码库的一部分，它们可以在外部管理，使用外部配置文件，位于服务器或配置服务器(如git-repo)或任何其他可访问的服务器上的配置映射中。</p><p id="fd5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们说配置时，你可能会有点困惑。这就是为什么我想多解释一点。因为软件行业有很多配置；<strong class="ih hj">服务器配置</strong>、<strong class="ih hj">数据库配置</strong>、<strong class="ih hj">应用配置、</strong>等等……在本文中，我们主要关注<strong class="ih hj">应用配置</strong>包括:</p><ul class=""><li id="bfa0" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">财务应用程序中的业务或工作流程变量，如<a class="ae jt" href="https://ec.europa.eu/taxation_customs/what-vat_en" rel="noopener ugc nofollow" target="_blank">增值税</a>税率</li><li id="7b8e" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">基于所用框架和第三方工具的应用程序属性，例如应用程序的服务器端口</li><li id="d7c5" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">访问应用程序中使用的外部服务器和API的信息(主要是主机和端口信息),例如访问<a class="ae jt" href="https://www.xe.com/xecurrencydata/" rel="noopener ugc nofollow" target="_blank"> XE </a>以获取最新汇率的信息</li><li id="8a2e" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">数据库连接、提供者和管理信息，SQL或NoSQL</li><li id="e7cc" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">超时和运行状况检查配置参数</li><li id="6cdf" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">弹性和回退配置(重试、断路器、隔板、时间限制器或速率限制器)</li><li id="edd1" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">指标管理和仪表板配置，如Prometheus的scraper配置，用于从应用程序收集指标并将其存储在数据库中</li><li id="a00a" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">应用程序日志配置等等…</li></ul><p id="abaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我希望我们在单词<strong class="ih hj">配置</strong>上处于同一点。</p><p id="8d26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然在应用程序中管理配置非常灵活，但对于开发人员来说，在应用程序中管理它们并不总是那么容易。由于这些配置是动态变量，它们可能需要在生产和其他环境中进行更改。</p><p id="23e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">软件行业的最佳实践之一是将配置文件分成基于环境的配置文件。例如，我们可以在<a class="ae jt" rel="noopener" href="/javarevisited/10-best-online-courses-to-learn-spring-framework-in-2020-f7f73599c2fd"> Spring framework </a>中使用概要文件来管理不同环境的应用程序行为和配置。我们可以在每个环境中定义一个或多个活动的概要文件，这样Spring就会考虑这些活动的概要文件来运行我们的应用程序。</p><p id="e43e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我已经说过的，您可以从内部和外部管理您的应用程序配置。<strong class="ih hj"> </strong>但它们之间有什么区别呢？在什么情况下我们需要选择哪一个？</p><p id="c0fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">把你的配置<strong class="ih hj">保存在内部</strong>意味着把你的配置放在你代码库中的某个地方，这样你就可以随时轻松地访问它们。<br/>但是在这种方法论中，你必须在每一次配置变更上操作<strong class="ih hj">SDLC</strong><strong class="ih hj">(</strong><a class="ae jt" rel="noopener" href="/javarevisited/6-best-sdlc-courses-for-beginners-and-experienced-programmers-devops-and-project-managers-b8242c04d761"><strong class="ih hj">软件开发生命周期</strong> </a> <strong class="ih hj"> ) </strong>。</p><p id="2ac6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，<strong class="ih hj">在外部</strong>，您可以将您的配置保存在一个文件系统或另一个服务器上，这样您的应用程序就可以在启动时或任何需要的时候从该源获取配置文件。这种方法还支持在重启服务器后更新配置，甚至支持在不重启服务器的情况下自动刷新。</p><p id="c175" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，我应该选择哪种方法来保存我的配置呢？这是一个棘手的问题，我们不能马上回答。您必须做的第一件事是问自己或领域专家，您希望多久更改一次配置？如果他/她说从不，那么保持这样的配置是有意义的。</p><p id="178c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果希望经常更改这些配置，那么将这些配置保存在外部系统上是很有用的。如果有一个配置你不确定多久会被改变一次，我更喜欢将这些配置存储在外部。</p><p id="2ad5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个决定取决于您的应用程序基础设施和业务预期。如果您在一个敏捷系统中工作，通常希望您有一个灵活的应用程序基础设施来应对业务变化。因此，在外部保存配置文件是一种更好的方式。</p><p id="9b9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，从技术角度来看，将配置存储在外部是最受欢迎的方式。特别是考虑到<strong class="ih hj">云</strong>基础设施、<a class="ae jt" rel="noopener" href="/javarevisited/7-free-microservices-courses-for-java-programmers-c9b2f3a2ea7d"> <strong class="ih hj">微服务</strong> </a>以及从<strong class="ih hj">传统SDLC(瀑布等)向</strong> <a class="ae jt" rel="noopener" href="/javarevisited/7-best-agile-and-scrum-online-training-courses-3b191e9b65eb"> <strong class="ih hj">敏捷</strong> </a>的转变，配置文件的外部管理已经成为应用适应这些系统和流程的重要标准。<a class="ae jt" href="https://12factor.net/" rel="noopener ugc nofollow" target="_blank"> 12 Factor App </a>，其中一个流行的文档，宣称了一个App与云兼容的最佳实践，告诉<strong class="ih hj">“在环境中存储配置”。</strong>他们将管理配置过度应用的最佳实践解释为:</p><blockquote class="kr"><p id="4f21" class="ks kt hi bd ku kv kw kx ky kz la jc dx translated">应用程序有时会将配置作为常量存储在代码中。这违反了要求将配置与代码严格分离的十二要素。配置在不同的部署中有很大的不同，代码则没有。</p></blockquote><p id="2b0c" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">因此，我们学习了管理配置文件的最佳实践。下一步是学习如何做到这一点。对于这一点，有很多库和技术，比如由<a class="ae jt" rel="noopener" href="/javarevisited/top-15-online-courses-to-learn-docker-kubernetes-and-aws-for-fullstack-developers-and-devops-d8cc4f16e773"> Kubernetes </a>开发的<a class="ae jt" href="https://kubernetes.io/docs/concepts/configuration/configmap/" rel="noopener ugc nofollow" target="_blank"> ConfigMap </a>，由Alibaba开发的<a class="ae jt" href="https://nacos.io/en-us/docs/what-is-nacos.html" rel="noopener ugc nofollow" target="_blank"> Nacos </a>，由<a class="ae jt" href="https://cfengine.com/" rel="noopener ugc nofollow" target="_blank"> CFEngine </a>，<a class="ae jt" rel="noopener" href="/javarevisited/7-best-puppet-online-courses-for-system-administrators-and-devops-engineers-889b5ab8aeca"> Puppet </a>等等……但是在本文中，我将只尝试解释名为<strong class="ih hj">Spring Cloud Config Server</strong>的基于Spring的解决方案。我可以发表关于上面列出的其他配置管理技术的文章。</p><h1 id="8e9d" class="lg lh hi bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">在哪里使用配置服务器？</h1><p id="07a7" class="pw-post-body-paragraph if ig hi ih b ii me ik il im mf io ip iq mg is it iu mh iw ix iy mi ja jb jc hb bi translated">我想你已经知道在哪里可以使用这项技术了。但是在您的应用程序中使用这项技术有一些限制。</p><p id="3c35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个也是最重要的标准是你的后端技术。Spring只支持<strong class="ih hj">基于JVM的技术</strong>，所以你必须使用<a class="ae jt" rel="noopener" href="/javarevisited/10-advanced-java-books-and-courses-for-experienced-developers-b90cc1086975"> Java </a>或者<a class="ae jt" rel="noopener" href="/javarevisited/top-5-courses-to-learn-kotlin-in-2020-dfc3fa7706d8"> Kotlin </a>作为你的后端开发语言。</p><p id="d416" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个限制是Spring依赖。由于Config Server是Spring Cloud库的一部分，没有<a class="ae jt" rel="noopener" href="/javarevisited/top-10-free-courses-to-learn-spring-framework-for-java-developers-639db9348d25"> <strong class="ih hj"> Spring </strong> </a>和<strong class="ih hj"/><a class="ae jt" rel="noopener" href="/javarevisited/5-best-courses-to-learn-spring-cloud-and-microservices-1ddea1af7012"><strong class="ih hj">Spring Cloud</strong></a>就无法使用。</p><figure class="je jf jg jh fd ji er es paragraph-image"><a href="https://javarevisited.blogspot.com/2018/02/top-5-spring-microservices-courses-with-spring-boot-and-spring-cloud.html"><div class="er es mj"><img src="../Images/7ca82ac844e60272df3ea052446f267b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SeTcnDPrQLt_9frzC6aHQA.png"/></div></a><p class="jp jq et er es jr js bd b be z dx translated"><a class="ae jt" href="https://spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring </a>对<a class="ae jt" href="https://spring.io/microservices" rel="noopener ugc nofollow" target="_blank"> Spring.io微服务</a>拍照</p></figure><p id="43e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你工作的公司的技术栈是建立在微服务基础设施、<a class="ae jt" href="https://javarevisited.blogspot.com/2018/06/top-6-spring-framework-online-courses-Java-programmers.html" rel="noopener ugc nofollow" target="_blank"> Spring framework </a>和JVM技术之上，你可以使用Spring Config Server作为你的一些应用程序的配置管理工具。</p><h1 id="b76e" class="lg lh hi bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">从哪里开始？</h1><p id="9977" class="pw-post-body-paragraph if ig hi ih b ii me ik il im mf io ip iq mg is it iu mh iw ix iy mi ja jb jc hb bi translated">如果您想要在您的项目中使用Spring Config Server，您必须首先使用您的依赖项管理工具将它作为一个依赖项添加到您的项目中。如果您使用的是<a class="ae jt" rel="noopener" href="/javarevisited/6-best-maven-courses-for-beginners-in-2020-23ea3cba89"> <strong class="ih hj"> Maven </strong> </a>，您可以将Spring Config Server添加到<strong class="ih hj"> pom.xml </strong>文件中，如下所示:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="f1fa" class="mp lh hi ml b fi mq mr l ms mt">&lt;dependencies&gt;<br/>   &lt;dependency&gt;<br/>      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>      &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;<br/>   &lt;/dependency&gt;<br/>&lt;/dependencies&gt;</span></pre><p id="b0ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于<a class="ae jt" rel="noopener" href="/javarevisited/5-best-gradle-courses-and-books-to-learn-in-2021-93f49ce8ff8e"> Gradle </a>，您需要将下面的命令作为依赖项添加到您的<strong class="ih hj"> build.gradle </strong>文件中:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="80ae" class="mp lh hi ml b fi mq mr l ms mt">dependencies <strong class="ml hj">{<br/>    </strong>implementation group: 'org.springframework.cloud', name:  'spring-cloud-config-server'<br/><strong class="ml hj">}</strong></span></pre><p id="546b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置服务器保存应用程序所有环境的敏感数据。在某些情况下，您可以存储数据库和其他服务器访问凭证、API密钥和许多其他配置，当黑客访问它们时，可能会对您的应用程序造成攻击。</p><p id="fcb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，保护配置服务器是将Spring Cloud Config Server集成到您的应用程序基础设施中的一个关键点。Spring Cloud Config Server可以很容易地与Spring Security集成在一起，以提供基本的认证。</p><p id="c904" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的Maven项目中，您必须将以下依赖项添加到pom.xml中:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="e2b3" class="mp lh hi ml b fi mq mr l ms mt">&lt;dependencies&gt;<br/>   &lt;dependency&gt;<br/>      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>      &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;<br/>   &lt;/dependency&gt;<br/>&lt;/dependencies&gt;</span></pre><p id="a0f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，您可以通过将下面的命令添加到Gradle项目中来集成它，如下所示:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="5255" class="mp lh hi ml b fi mq mr l ms mt">dependencies <strong class="ml hj">{<br/>  </strong>implementation group: 'org.springframework.boot', name: 'spring-boot-starter-security'<br/><strong class="ml hj">}</strong></span></pre><h1 id="9672" class="lg lh hi bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">如何使用Spring Cloud Config Server？</h1><p id="a4c2" class="pw-post-body-paragraph if ig hi ih b ii me ik il im mf io ip iq mg is it iu mh iw ix iy mi ja jb jc hb bi translated">要将配置管理功能与Spring Cloud Config Server集成，您需要一个Spring Boot应用程序作为您的配置服务器。此应用程序必须包括上述依赖关系。</p><p id="9a6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们必须将<a class="ae jt" href="https://www.java67.com/2018/12/top-5-spring-cloud-annotations-for-java.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> @EnableConfigServer </strong>注释</a>添加到我们的应用程序主类中，如下所示:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="50cf" class="mp lh hi ml b fi mq mr l ms mt">@SpringBootApplication<br/>@EnableConfigServer<br/>public class ConfigServerApplication {<br/><br/>    public static void main(String[] args) {<br/>        SpringApplication.run(ConfigServerApplication.class, args);<br/>    }<br/><br/>}</span></pre><p id="df9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置服务器是一个工作在8080端口的Spring Boot应用程序，该端口是任何<a class="ae jt" href="https://javarevisited.blogspot.com/2018/05/the-springbootapplication-annotation-example-java-spring-boot.html" rel="noopener ugc nofollow" target="_blank"> Spring Boot应用程序</a>的默认端口。在我们的例子中，让我们给它一个特定的端口，比如9090，以区别于其他的Spring boot应用程序。</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="53a5" class="mp lh hi ml b fi mq mr l ms mt">server:<br/>   port: 9090</span></pre><p id="7f2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要一个Github存储库来保存不同环境下的一个或多个应用程序的配置。您可以将这个存储库视为一个结构良好的文件目录。这个文件目录包括许多子目录，这些子目录在层次级别上表达应用程序和概要文件。</p><p id="3fe2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spring Cloud配置服务器以下列形式解析配置:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="b1a3" class="mp lh hi ml b fi mq mr l ms mt">/{application}/{profile}[/{label}]<br/>/{application}-{profile}.yml<br/>/{label}/{application}-{profile}.yml<br/>/{application}-{profile}.properties<br/>/{label}/{application}-{profile}.properties</span></pre><p id="f275" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们有三个服务，分别是Crm、Account和Hr。例如，您可以遵循<code class="du mu mv mw ml b">{application}/{profile}</code>语法来管理存储库中的配置，如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><a href="https://www.java67.com/2017/11/top-5-free-core-spring-mvc-courses-learn-online.html"><div class="er es mx"><img src="../Images/e9c3c66560b83ca2a73afad501645cef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*ArlpaOUKvTzXNKuDjQ1crQ.png"/></div></a><p class="jp jq et er es jr js bd b be z dx translated">配置存储库的文件目录</p></figure><p id="7388" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上图中，您可以看到目录模式中的第一层代表服务，而第二层包含特定应用程序的不同概要文件的配置。</p><p id="bb69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下一步中，我们将在配置服务器应用程序中定义必要的配置，以连接到Git配置存储库，并在服务启动并运行时从该存储库中解析配置。</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="6a68" class="mp lh hi ml b fi mq mr l ms mt"><strong class="ml hj">spring:</strong><br/>  <strong class="ml hj">cloud:</strong><br/>    <strong class="ml hj">config:</strong><br/>      <strong class="ml hj">server:</strong><br/>       <strong class="ml hj"> git:</strong><br/>          <strong class="ml hj">uri:</strong> https://github.com/justayar/SpringBootTemplates/<br/>          <strong class="ml hj">searchPaths:</strong> 'app_configs/{application}/{profile}'<br/>          <strong class="ml hj">cloneOnStart:</strong> true</span></pre><p id="254d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的配置中，我们设置了引用Git配置存储库的<strong class="ih hj"><em class="my">【uri】</em></strong>参数。使用<strong class="ih hj"><em class="my">“search paths”</em></strong>参数，我们将公式提供给配置服务器，以解析特定服务和配置文件的配置。</p><p id="0d58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将"<strong class="ih hj"><em class="my">cloneon start "</em></strong>设置为true有助于在配置服务器启动时快速识别错误配置的配置源(例如无效的存储库URI)。有了这些配置，我们就完成了配置服务器应用程序到Git配置存储库的集成。</p><p id="4568" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们在文章的前一部分中提到的，使配置服务器安全是标准配置管理机制最重要的一点。此时，<a class="ae jt" rel="noopener" href="/javarevisited/top-10-courses-to-learn-spring-security-and-oauth2-with-spring-boot-for-java-developers-8f0222d6066d">春保</a>来帮我们了。为了在配置服务器上提供基本认证，我们可以将<em class="my"/><strong class="ih hj"><em class="my">用户名/密码"</em> </strong>对添加到我们的配置文件中，如下所示:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="8643" class="mp lh hi ml b fi mq mr l ms mt">spring:<br/>  security:<br/>    user:<br/>      name: config_admin<br/>      password: Pass_1234</span></pre><p id="0ed5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置好这个配置之后，我们就完成了配置服务器应用程序的实现。下一步是实现一个客户端应用程序，它使用我们已经实现的配置服务器应用程序作为配置管理工具。该应用程序必须使用<a class="ae jt" rel="noopener" href="/javarevisited/5-advanced-spring-framework-books-experienced-java-developers-should-read-in-2020-best-of-lot-2a786fc5ad31?source=collection_home---4------4-----------------------"> Spring </a>作为基础框架，并且在其pom.xml文件中具有以下Spring Cloud Starter配置依赖项:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="4739" class="mp lh hi ml b fi mq mr l ms mt">&lt;dependencies&gt;<br/>   &lt;dependency&gt;<br/>      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>      &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;<br/>   &lt;/dependency&gt;<br/>&lt;/dependencies&gt;</span></pre><p id="dbe9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在将依赖项添加到客户机应用程序之后，我们可以通过下一步，即将客户机应用程序连接到作为配置管理器的配置服务器应用程序。为此，我们可以将以下基本集成配置添加到我们的属性文件中(您可以使用bootstrap.yml或application.yml文件)</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="20c9" class="mp lh hi ml b fi mq mr l ms mt">spring:<br/>  cloud:<br/>    config:<br/>      uri: http://localhost:9000<br/>      username: config_admin<br/>      password: Pass_1234<br/>  application:    <br/>    name: ticker</span></pre><p id="bd0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"><em class="my">“uri”</em></strong>参数定义了配置服务器应用程序的基本URL。因为我们已经向配置服务器应用程序添加了安全层，所以客户端需要<a class="ae jt" href="https://javarevisited.blogspot.com/2018/01/how-http-basic-authentication-works-in.html#axzz6hhgr3Uqg" rel="noopener ugc nofollow" target="_blank">身份验证</a>来访问它。为此，我们需要设置<strong class="ih hj"> <em class="my">【用户名】</em></strong><strong class="ih hj"><em class="my">【密码】</em> </strong>字段。</p><p id="f5fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的配置服务器可以包含许多应用程序的配置，因此我们需要在客户端属性文件中指定应用程序的"<strong class="ih hj"> <em class="my"> name" </em> </strong>，以使配置服务器中的配置解析过程更加容易。</p><p id="c4d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们在配置服务器应用中所做的那样，我们可以定义一个特定的端口来区分我们的客户端应用和<a class="ae jt" rel="noopener" href="/javarevisited/10-best-java-microservices-courses-with-spring-boot-and-spring-cloud-6d04556bdfed?source=rss-bb36d8439904------2&amp;utm_source=dlvr.it&amp;utm_medium=linkedin">微服务</a>基础设施中的其他应用。我们在下面为这个客户端应用程序定义了9091端口:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="3ece" class="mp lh hi ml b fi mq mr l ms mt">server:<br/>   port: 9091</span></pre><p id="55c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以试试它是否有效。为了测试它，我们在客户机应用程序的属性文件上设置静态属性。我们将我们的客户端应用程序设计为一个简单的Ticker服务，它从<a class="ae jt" href="https://de.cryptonator.com/api" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Cryptonator汇率API </strong> </a> <strong class="ih hj">获取汇率。</strong>汇率API获取以下参数以返回不同货币的汇率:</p><ul class=""><li id="618a" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated"><strong class="ih hj">基础</strong> —基础货币代码</li><li id="1041" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">目标</strong> —目标货币代码</li><li id="bfbe" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">价格</strong> —数量加权价格</li></ul><p id="993c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在Ticker服务中使用<strong class="ih hj">基本</strong>和<strong class="ih hj">目标</strong>参数作为静态变量。另一方面，价格是一个动态变量，您可以为每个服务调用设置不同的值。</p><p id="9511" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们可以将基本参数和目标参数添加到属性文件中，如下所示(这些是基本参数和目标参数的默认配置):</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="4db3" class="mp lh hi ml b fi mq mr l ms mt">market:<br/>  base: btc<br/>  target: eur</span></pre><p id="00f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在服务类中，我们可以将静态变量、base和target作为参数传递给API，方法是将这些静态变量注入一个字段。</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="df0d" class="mp lh hi ml b fi mq mr l ms mt">@Service<br/>public class CryptonatorTickerService implements TickerService {<br/><br/>    @Value("${market.base}")<br/>    private String base;<br/><br/>    @Value("${market.target}")<br/>    private String target;<br/><br/>}</span></pre><p id="56a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们为配置文件定义基本参数和目标参数，该文件位于Git配置存储库中的ticker目录下。</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="cc37" class="mp lh hi ml b fi mq mr l ms mt">market:<br/>  base: usd<br/>  target: try</span></pre><p id="08f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们运行Ticker应用程序时，我们可以看到它从Git配置存储库中解析了上述静态参数，并将它们作为API的参数注入到服务中。</p><p id="b227" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然一切都很完美，但我们仍能感觉到缺少了一些东西。我们可以意识到，当相关的配置文件发生变化时，我们必须重新启动Ticker服务来从配置服务器获取更新的参数。此时，Spring框架用另一个名为<strong class="ih hj"/><a class="ae jt" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">【Spring Boot执行器】</strong> </a>的库来帮助我们。</p><p id="c0c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jt" href="https://www.java67.com/2021/02/spring-boot-actuator-interview-questions-answers-java.html" rel="noopener ugc nofollow" target="_blank"> Spring Boot执行器</a>通过提供额外的特性来增强Spring框架，以便更容易地监控和管理您的Spring Boot应用程序。它提供了一些基本的HTTP端点:</p><ul class=""><li id="1ff5" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated"><strong class="ih hj">指标</strong> —显示您的应用程序的当前指标，如CPU使用率，或使用的JVM内存</li><li id="7f44" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">健康</strong> —显示您的应用程序的健康状态</li><li id="60e1" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">关闭</strong> —提供一个端点来正常关闭您的应用程序</li><li id="b96c" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj"> actuator/refresh </strong> —提供一个端点来刷新应用程序的配置，而无需重启</li></ul><p id="266b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要在您的Spring Boot应用程序中使用Spring Actuator，您需要将它的依赖项添加到您的<a class="ae jt" href="https://javarevisited.blogspot.com/2015/01/difference-between-maven-ant-jenkins-and-hudson.html#axzz6cKi4RVpi" rel="noopener ugc nofollow" target="_blank"> Maven </a>和<a class="ae jt" href="https://javarevisited.blogspot.com/2020/06/maven-vs-gradle-beginners-introduction.html#axzz6dHZ7oEpK" rel="noopener ugc nofollow" target="_blank"> Gradle </a>的构建文件中，如下所示:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="65f3" class="mp lh hi ml b fi mq mr l ms mt">&lt;dependencies&gt;<br/>    &lt;dependency&gt;<br/>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br/>    &lt;/dependency&gt;<br/>&lt;/dependencies&gt;</span><span id="65a6" class="mp lh hi ml b fi mz mr l ms mt">dependencies {<br/>    implementation 'org.springframework.boot:spring-boot-starter-actuator'<br/>}</span></pre><p id="2e73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spring Actuator寻找<strong class="ih hj"> @RefreshScope </strong>注释来识别将由刷新机制自动刷新的包。当调用actuator/refresh端点时，带有这些注释的类中的属性变量将自动刷新。因此，我们只将@RefreshScope注释添加到应用程序中包含属性变量的服务类中。</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="19cc" class="mp lh hi ml b fi mq mr l ms mt">@Service<br/>@RefreshScope<br/>public class CryptonatorTickerService implements TickerService {<br/><br/>    @Value("${market.base}")<br/>    private String base;<br/><br/>    @Value("${market.target}")<br/>    private String target;<br/><br/>}</span></pre><p id="f9d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们运行客户端应用程序时，我们可以看到它从配置服务器获得了最新的配置。我们需要在与我们的应用程序相关的Git配置存储库的每次更新中调用以下端点:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="0db4" class="mp lh hi ml b fi mq mr l ms mt">http://localhost:9001/actuator/refresh</span></pre><p id="5ac9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你也可以使用下面的<a class="ae jt" href="https://javarevisited.blogspot.com/2017/03/10-examples-of-curl-command-in-unix-and-Linux.html#axzz6bYzaddcE" rel="noopener ugc nofollow" target="_blank">卷曲命令</a>:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="47ec" class="mp lh hi ml b fi mq mr l ms mt">curl localhost:9001/actuator/refresh -d {} -H “Content-Type: application/json”</span></pre><p id="a4ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们想到了另一个问题，对于在生产环境中有许多实例的应用程序，如何轻松地管理它？根据Spring Actuator刷新机制下的理论，我们必须为应用程序的所有实例调用上面的命令。我知道这听起来有多艰难和愚蠢。春云也有一个解决方案，叫做<a class="ae jt" href="https://spring.io/projects/spring-cloud-bus" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> <em class="my">春云总线</em> </strong> </a>，来解决这个复杂性。Spring在他们的官方网站上解释如下:</p><blockquote class="kr"><p id="648e" class="ks kt hi bd ku kv kw kx ky kz la jc dx translated">Spring Cloud Bus使用轻量级消息代理链接分布式系统的节点。然后，这可以用于广播状态变化(例如，配置变化)或其他管理指令。AMQP和Kafka代理实现包含在项目中。或者，在类路径上找到的任何<a class="ae jt" href="https://spring.io/projects/spring-cloud-stream" rel="noopener ugc nofollow" target="_blank">Spring Cloud Stream</a>binder都将作为传输文件开箱即用。</p></blockquote><p id="5391" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">Spring Cloud Bus是一个有点复杂的解决方案，不是本文的一部分。我想以承诺在我的下一篇文章中详细写一个单独的故事来结束这篇文章。</p><h1 id="eb75" class="lg lh hi bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">结论</h1><p id="7a0f" class="pw-post-body-paragraph if ig hi ih b ii me ik il im mf io ip iq mg is it iu mh iw ix iy mi ja jb jc hb bi translated">配置是我们应用程序不可避免的一部分。随着微服务架构、基于云的应用甚至无服务器基础设施的出现，正确的配置管理已经成为应用的一个重要方面。</p><p id="0f18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在敏捷世界中，更快地响应变化是非常关键的。不断变化的业务需求、客户期望和意想不到的环境因素不断增加了对监控和管理系统的需求。在这一点上，配置允许我们随时随地轻松地更改工作流甚至应用的行为，而无需操作<a class="ae jt" href="https://javarevisited.blogspot.com/2020/08/top-5-courses-to-learn-software.html#axzz6oQMlXxTh" rel="noopener ugc nofollow" target="_blank"> SDLC </a>。</p><p id="3734" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天广为接受的软件开发标准，如<strong class="ih hj"> 12FactorApp </strong>提出了配置的外部管理，以提供对这些变化需求的快速响应。</p><p id="764b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在配置管理领域，不同的语言有许多可供选择的解决方案。Kubernetes的<a class="ae jt" href="https://kubernetes.io/docs/concepts/configuration/configmap/" rel="noopener ugc nofollow" target="_blank"> ConfigMap </a>，阿里巴巴的<a class="ae jt" href="https://nacos.io/en-us/docs/what-is-nacos.html" rel="noopener ugc nofollow" target="_blank"> Nacos </a>，CFEngine ，<a class="ae jt" href="https://puppet.com/" rel="noopener ugc nofollow" target="_blank"> Puppet </a>只是这些解决方案中的一部分。</p><p id="d6e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我尝试了Spring Cloud Config Server，以及如何在基于Spring和Java的项目中轻松使用它。此外，我试图用一个简单的服务器和客户机应用程序来演示它。</p><p id="ed73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以从<a class="ae jt" href="https://github.com/justayar/SpringBootTemplates" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">这里</strong> </a>访问源代码。</p></div><div class="ab cl na nb gp nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="hb hc hd he hf"><h1 id="242d" class="lg lh hi bd li lj nh ll lm ln ni lp lq lr nj lt lu lv nk lx ly lz nl mb mc md bi translated">感谢您的阅读。随时给我反馈:)</h1></div></div>    
</body>
</html>