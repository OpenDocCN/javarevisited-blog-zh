<html>
<head>
<title>Inbound Authentication with OAuth 2.0 and OIDC on WSO2 IS 🥷🏼</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WSO2上OAuth 2.0和OIDC的入站身份验证是🥷🏼</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/inbound-authentication-with-oauth-2-0-and-oidc-on-wso2-is-55a197d270b4?source=collection_archive---------3-----------------------#2022-09-07">https://medium.com/javarevisited/inbound-authentication-with-oauth-2-0-and-oidc-on-wso2-is-55a197d270b4?source=collection_archive---------3-----------------------#2022-09-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="db80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OAuth 2.0和OIDC是WSO2 IS的两种主要认证类型。简单来说，</p><ul class=""><li id="8043" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">OAuth 2.0是一种协议，它控制对受保护资源(如web应用程序、本机应用程序或API服务)的访问授权。</li><li id="3425" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">OIDC或OpenID Connect是一种建立在OAuth 2.0上的协议，有助于对用户进行身份验证并传递有关他们的信息。</li></ul><p id="aa46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将看看这两者是如何在WSO2 IS 5.11中用于入站认证的。</p><h2 id="8f1c" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">理解术语</h2><h2 id="2620" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">OAuth 2.0</h2><p id="c1fb" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">OAuth 2.0是用于向客户端应用程序提供访问标准。如果我们希望以一种安全的方式授权访问我们的应用程序数据，那么我们希望使用OAuth 2.0协议。</p><p id="d7c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OAuth 2.0规范有四个重要的角色。</p><ul class=""><li id="0016" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><strong class="ih hj"> <em class="ks">授权服务器</em> </strong> —发布接入令牌的服务器。在这种情况下，WSO2是授权服务器。</li><li id="de67" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj"> <em class="ks">资源所有者</em> </strong> —通常是应用程序的最终用户，他授予使用访问令牌访问资源服务器的权限。</li><li id="8246" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj"> <em class="ks">客户端</em> </strong> —向WSO2请求访问令牌的应用程序，然后将其传递给资源服务器。</li><li id="4cdf" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj"> <em class="ks">资源服务器</em> </strong> —接受访问令牌，并且必须验证其有效性。在这种情况下，这是您的应用程序。</li></ul><p id="fa54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其他重要术语有:</p><ul class=""><li id="3de5" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><strong class="ih hj"><em class="ks">OAuth 2.0 grant</em></strong>—用户给予客户端的授权。授权的例子是授权码和客户凭证。</li><li id="4e6f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj"> <em class="ks">访问令牌</em> </strong> —授权服务器(WSO2 IS)为换取授权而颁发的令牌。</li><li id="2320" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj"> <em class="ks">刷新令牌</em> </strong> —可选令牌，如果访问令牌已经过期，则该令牌被交换为新的访问令牌。</li></ul><p id="7d07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常的OAuth 2.0授权流如下所示</p><ol class=""><li id="b13b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kt jj jk jl bi translated">客户端向资源所有者(通常是用户)请求授权。</li><li id="7fc4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kt jj jk jl bi translated">如果用户给予授权，客户机将授权传递给授权服务器(在本例中是WSO2)</li><li id="721f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kt jj jk jl bi translated">如果授权有效，授权服务器返回一个访问令牌，可能还有一个刷新令牌。</li><li id="eb9d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kt jj jk jl bi translated">客户端现在使用该访问令牌来访问资源服务器。</li></ol><figure class="kv kw kx ky fd kz er es paragraph-image"><a href="https://javarevisited.blogspot.com/2021/02/spring-security-interview-questions-answers-java.html"><div class="er es ku"><img src="../Images/ac7b103aabf2e7743df41ac231cc858a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*e599lXzozhFPAsLsCzrf6A.png"/></div></a><p class="lc ld et er es le lf bd b be z dx translated">OAuth 2.0流程</p></figure><h2 id="8ce8" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">OpenID连接</h2><p id="16a4" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">OpenID Connect是建立在OAuth 2.0之上的认证标准。它添加了一个称为ID令牌的额外令牌。OpenID Connect还标准化了OAuth 2.0留给用户选择的领域，比如作用域、端点发现和客户端的动态注册。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><a href="https://www.java67.com/2012/08/spring-interview-questions-answers.html"><div class="er es ku"><img src="../Images/3f0690973d5b5a78f40c8a1a2446fde3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*4FJM8X-63-DYbeO0CZ-D8Q.png"/></div></a><p class="lc ld et er es le lf bd b be z dx translated">OIDC流</p></figure><p id="0d94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您在上图中所注意到的，与OAuth 2.0流程相比，OIDC流程有两个基本的增加。第一个是由客户端应用程序随授权请求一起发送到授权服务器的范围。这里，<strong class="ih hj"> <em class="ks"> openid </em> </strong> <em class="ks"> </em>被添加到范围中以表示这是OIDC流。在接收时，授权服务器知道这是一个OIDC流，并在认证后发送一个ID令牌。这是一个包含用户信息的JSON web令牌。</p><h2 id="5d61" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">OAuth授权类型</h2><p id="b20f" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">谈到OAuth，最重要的术语之一是授权类型。授权类型基本上意味着您的应用程序获得访问令牌的一种方式。OAuth 2.0有一些不同类型的授权类型，扩展也能够定义新的授权类型。WSO2 IS中使用的OAuth授权类型如下所述。</p><p id="7143" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">授权码授予</strong></p><p id="e027" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，客户端应用程序将资源所有者指向授权服务器(WSO2 IS ),以直接从资源所有者那里获得授权。则资源所有者被重定向回具有授权码的客户端应用程序，该授权码将被客户端应用程序获取并在后台被提交用于访问令牌。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><a href="https://javarevisited.blogspot.com/2017/06/3-best-spring-security-online-training-courses-java-programmers.html"><div class="er es lg"><img src="../Images/a218cbe17ce496cd28b28eea8564ea9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*8Ps-6iaozbu-nqLDBbzz4Q.png"/></div></a></figure><p id="0770" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取授权码的URL如下所示。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="5fb5" class="js jt hi li b fi lm ln l lo lp">https://localhost:9443/oauth2/authorize?response_type=code&amp;client_id=&lt;CLIENT_ID&gt;&amp;redirect_uri=&lt;REDIRECT_URI&gt;</span></pre><p id="1ade" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，使用下面的<a class="ae jr" href="https://javarevisited.blogspot.com/2017/03/10-examples-of-curl-command-in-unix-and-Linux.html" rel="noopener ugc nofollow" target="_blank"> cURL命令</a>我们可以获得访问令牌。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="165d" class="js jt hi li b fi lm ln l lo lp">curl -v -X POST --basic -u &lt;CLIENT_ID&gt;:&lt;CLIENT_SECRET&gt; -H "Content-Type:application/x-www-form-urlencoded;charset=UTF-8" -k -d "grant-type=authorization_code&amp;code=&lt;AUTHORIZATION_CODE&gt;&amp;redirect_uri=&lt;REDIRECT_URI&gt;" &lt;TOKEN_ENDPOINT&gt;</span></pre><p id="5192" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">隐性授予</strong></p><p id="fb45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">隐式授权类型适用于不能对客户端凭据保密的公共客户端。这类似于授权码授权，但不是用授权码重定向，而是用访问令牌重定向。此外，这种授权类型不发布刷新令牌，该刷新令牌可用于使用刷新令牌授权来获得新的访问令牌。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es lg"><img src="../Images/db9e63330429660f515b7f73e898f5df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*pSFoG3lzEaQppPrZP9X5CA.png"/></div></figure><p id="a54d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下URL可用于尝试此授权类型。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="6060" class="js jt hi li b fi lm ln l lo lp">https://localhost:9443/oauth2/authorize?response_type=token&amp;client_id=&lt;CLIENT_ID&gt;&amp;redirect_uri=&lt;REDIRECT_<br/>URI&gt;</span></pre><p id="c632" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">资源所有者密码凭证授予</strong></p><p id="5375" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">客户端应用程序本身会提示资源所有者输入用户名和密码，而不是将用户重定向到授权服务器。然后，客户端会将它们和客户端应用程序凭证一起发送到授权服务器。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es lq"><img src="../Images/20a837d809bc8634bd3a005df6092739.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/format:webp/1*X8iieVJZiJn-m71WT46C6Q.png"/></div></figure><p id="8103" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下cURL命令可用于尝试客户机凭证授权类型。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="9dad" class="js jt hi li b fi lm ln l lo lp">curl -v -X POST -H "Authorization: Basic &lt;Base64Encoded(CLIENT_ID:CLIENT_SECRET)&gt;" -k -d "grant_type=client_credentials" -H "Content-Type:application/x-www-form-urlencoded" &lt;TOKEN_ENDPOINT&gt;</span><span id="279b" class="js jt hi li b fi lr ln l lo lp">curl -u &lt;CLIENT_ID&gt;:&lt;CLIENT_SECRET&gt; -k -d "grant_type=client_credentials" -H "Content-Type:application/x-www-form-urlencoded" &lt;TOKEN_ENDPOINT&gt;</span></pre><p id="38c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">刷新令牌授权</strong></p><p id="89f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可以在当前访问令牌过期或需要新的访问令牌时使用。在这种情况下，刷新令牌充当凭证，由授权服务器颁发给客户端。</p><p id="6fcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要使用刷新令牌，必须首先通过使用授权码授权或客户端凭证/密码授权类型来获得它。使用获得的刷新令牌，可以获得新的访问令牌。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es ls"><img src="../Images/d54f018b9eda9a1e6a3cb43e1c24e0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*zmqHbNzucIXptRS-bQxlzw.png"/></div></figure><p id="7dd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的cURL命令可以用来尝试这种授权类型。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="ec93" class="js jt hi li b fi lm ln l lo lp">curl -k -d "grant_type=refresh_token&amp;refresh_token=&lt;REFRESH_TOKEN&gt;" -H "Authorization: Basic &lt;Base64Encoded(CLIENT_ID:CLIENT_SECRET)&gt;" -H "Content-Type: application/x-www-form-urlencoded" &lt;TOKEN_ENDPOINT&gt;</span></pre><p id="c9cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了上述四种主要的授权类型之外，WSO2 IS还可以使用这些授权类型的四种扩展。</p><ul class=""><li id="8ce7" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">设备流授权类型</li><li id="e43d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">JWT无记名授权类型</li><li id="4558" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">SAML2不记名声明配置文件。</li><li id="90bd" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">Kerberos授权类型</li></ul><h2 id="0f0a" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">WSO2 IS和OAuth 2.0/ OIDC</h2><h2 id="8320" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">OAuth 2.0/OIDC入站身份验证</h2><p id="ddce" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">为了了解WSO2如何与OAuth 2.0/OIDC协议一起工作，我们将使用WSO2 IS 5.11.0。要下载WSO2 IS 5.11.0，请到<a class="ae jr" href="https://wso2.com/identity-server/" rel="noopener ugc nofollow" target="_blank">https://wso2.com/identity-server/</a>下载最新的WSO2 IS zip存档(我将使用5.11.0)。下载IS后，解压到<code class="du lt lu lv li b">bin</code>目录。然后在终端中键入<code class="du lt lu lv li b">sh wso2server.sh</code>来运行它。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/ffb9a5ace3964a65ad827e3e26d977ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K88A0mpmAZ5BR9odLRKxMA.png"/></div></div><p class="lc ld et er es le lf bd b be z dx translated">WSO2正在运行</p></figure><p id="a20d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动IS后，你可以打开浏览器，输入<code class="du lt lu lv li b">https://localhost:9443/carbon</code>进入管理控制台。之后，您可以通过输入默认用户名<code class="du lt lu lv li b">admin</code>和默认密码<code class="du lt lu lv li b">admin</code>登录管理控制台</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/fd0c63be12e2c183b9358042bca0a31b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sab6zxBwLytuK-cEUf0OaA.png"/></div></div><p class="lc ld et er es le lf bd b be z dx translated">WSO2是管理控制台</p></figure><p id="925a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录管理控制台后，进入<code class="du lt lu lv li b">Service Providers</code> → <code class="du lt lu lv li b">Add</code>添加新的服务提供商。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/6cbda46b4a59a71c013b542a2c900483.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kErv3g-BVC14A5cpXJiX4Q.png"/></div></div><p class="lc ld et er es le lf bd b be z dx translated">添加新SP</p></figure><p id="510f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，系统会提示您进入一个新页面来配置您的应用程序。在那里，您可以通过进入<code class="du lt lu lv li b">Inbound Authentication Configuration</code> → <code class="du lt lu lv li b">OAuth/ OpenID Connect Configuration</code>并点击<code class="du lt lu lv li b">configure</code>将应用配置为OAuth/OIDC应用</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/2bde5d4fb9592a38ec594bf52b4cf5cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MYVjRyL7BUbssshWFmUFQg.png"/></div></div><p class="lc ld et er es le lf bd b be z dx translated">OAuth/OIDC配置</p></figure><p id="e6a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，你可以看到我只添加了回调URL <code class="du lt lu lv li b">http://localhost:8080/pickup-dispatch/oauth2client</code>，其他的都是默认的。</p><p id="3b60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要了解所有这些复选框和其他东西，请参考<a class="ae jr" href="https://is.docs.wso2.com/en/5.10.0/learn/configuring-oauth2-openid-connect-single-sign-on/" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><h2 id="4ffd" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">在Tomcat中配置Webapp</h2><p id="645e" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">现在，让我们来使用一个示例web应用程序，我们可以将其配置为服务提供商。要做到这一点，你需要有Tomcat，你可以从官方的<a class="ae jr" href="https://tomcat.apache.org/" rel="noopener ugc nofollow" target="_blank"> tomcat网站</a>下载。下载tomcat zip文件后，解压并使用终端打开目录。如果您使用<code class="du lt lu lv li b">ls</code>命令查看<code class="du lt lu lv li b">bin</code>文件夹，您可以看到有一个名为<code class="du lt lu lv li b">startup.sh</code>的<code class="du lt lu lv li b">.sh</code>文件，它将启动tomcat。但是要运行它，你需要给另一个名为<code class="du lt lu lv li b">catalina.sh</code>的<code class="du lt lu lv li b">.sh</code>文件执行权限。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="95c3" class="js jt hi li b fi lm ln l lo lp">chmod +x catalina.sh</span></pre><p id="0d9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后用<code class="du lt lu lv li b">sh startup.sh</code>启动tomcat服务器</p><p id="6725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将只启动tomcat服务器，而不显示任何日志文件。要查看日志文件，请在终端中打开一个新标签，并运行以下命令。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="65d8" class="js jt hi li b fi lm ln l lo lp">tail -100f &lt;TOMCAT_HOME&gt;/logs/catalina.out</span></pre><p id="d15c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果你打开浏览器，进入<code class="du lt lu lv li b">localhost:8080</code>，你可以看到tomcat正在运行，没有任何问题。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/e74ef543c8f44177138cba0db85b59d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eTtr41ipov3_n-KmWTXVTw.png"/></div></div></figure><p id="4cd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要停止tomcat服务器，您可以运行以下命令。</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="c6a6" class="js jt hi li b fi lm ln l lo lp">sh &lt;TOMCAT_HOME&gt;/bin/shutdown.sh</span></pre><p id="1d16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(或者，您可以使用<code class="du lt lu lv li b">sh catalina.sh run</code>运行带有日志的tomcat服务器，然后按<code class="du lt lu lv li b">command/ctrl + c</code>停止它。)</p><p id="66d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们下载一个示例web应用程序，并在tomcat中运行它。为此，请转到此<a class="ae jr" href="https://github.com/wso2/samples-is/releases" rel="noopener ugc nofollow" target="_blank">链接</a>并下载<code class="du lt lu lv li b">pickup-dispatch.war</code>文件。</p><p id="51af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下载完<code class="du lt lu lv li b">pickup-dispatch.war</code>文件后，将其复制并粘贴到<code class="du lt lu lv li b">&lt;TOMCAT_HOME&gt;/webapps</code>目录中。现在，如果您启动tomcat服务器，您可以看到在<code class="du lt lu lv li b">&lt;TOMCAT_HOME&gt;/webapps</code>目录中创建了一个名为<code class="du lt lu lv li b">pickup-dispatch</code>的目录。打开<code class="du lt lu lv li b">&lt;TOMCAT_HOME&gt;/webapps/WEB-INF/classes/dispatch.properties</code>，用我们服务提供商的<code class="du lt lu lv li b">OAuth Client Key</code>和<code class="du lt lu lv li b">OAuth Client Secret</code>更改<code class="du lt lu lv li b">consumerKey</code>和<code class="du lt lu lv li b">consumerSecret</code>的值。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/562399b908c8d76f16cd69ae54ee39f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqCoD6NeFYkihMFLabHbaA.png"/></div></div></figure><p id="248d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，还有另一个名为<code class="du lt lu lv li b">callBackUrl</code>的属性名，我们用它来配置WSO2 IS中的服务提供者。</p><p id="daae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们在WSO2 IS中创建SP-1时已经允许了所有的授权类型，并且在tomcat中配置了服务提供者，所以我们可以理解WSO2 IS提供的OAuth/OIDC流了。</p><p id="37f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">乌斯/OIDC演示</strong></p><p id="1541" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本演示中，我们将使用授权代码授权类型。由于我们已经知道授权码授权URL类型，我们可以替换这些值并为我们的服务提供商生成授权码授权URL，<code class="du lt lu lv li b">https://localhost:9443/oauth2/authorize?response_type=code&amp;scope=openid internal_login&amp;redirect_uri=http://localhost:8080/pickup-dispatch/oauth2client&amp;client_id=U0LDh6OPZfAoJn8aGrNywZXOMowa</code></p><p id="e2b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用URL中的scope参数，我们可以定义客户端应用程序需要授权的几个范围。如果您想获得可用于OAuth 2.0和OIDC的作用域的完整列表，可以执行以下cURL命令。(这里，cURL中的基本授权是作为一个基本的auth token，你可以使用这个<a class="ae jr" href="https://www.blitter.se/utils/basic-authentication-header-generator/" rel="noopener ugc nofollow" target="_blank">链接</a>生成基本的auth token。)</p><pre class="kv kw kx ky fd lh li lj lk aw ll bi"><span id="af08" class="js jt hi li b fi lm ln l lo lp">curl --location --request GET 'https://localhost:9443/api/identity/oauth2/v1.0/scopes' --header 'Authorization: Basic YWRtaW46YWRtaW4='</span><span id="a636" class="js jt hi li b fi lr ln l lo lp">curl --location --request GET 'https://localhost:9443/api/server/v1/oidc/scopes' --header 'Authorization: Basic YWRtaW46YWRtaW4='</span></pre><p id="6817" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们在浏览器中运行<code class="du lt lu lv li b">https://localhost:9443/oauth2/authorize?response_type=code&amp;scope=openid internal_login&amp;redirect_uri=http://localhost:8080/pickup-dispatch/oauth2client&amp;client_id=U0LDh6OPZfAoJn8aGrNywZXOMowa</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/a28a7d6f9ca299d69874cdf7b8c34f73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KQS1BnUDtOxiCBAIthipLQ.png"/></div></div></figure><p id="9a81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您在浏览器中看到的，我们已被重定向到另一个页面，其URL为<code class="du lt lu lv li b">https://localhost:9443/authenticationendpoint/login.do...</code>，有效负载包含<code class="du lt lu lv li b">sessionDataKey(6b6e7d2f-e3a4-4dc8-9bce-cfa00c04e3b6)</code>，如果我们在该页面上给出正确的凭证，我们将被重定向到具有相同<code class="du lt lu lv li b">sessionDataKey(6b6e7d2f-e3a4-4dc8-9bce-cfa00c04e3b6)</code>的<code class="du lt lu lv li b">commonauth</code>端点，然后我们将被要求授权我们在<code class="du lt lu lv li b">consent.do</code>端点请求的权限。需要记住的重要一点是<code class="du lt lu lv li b">sessionDataKey</code>仅在用户认证完成后才可用(当到达<code class="du lt lu lv li b">consent.do</code>时<code class="du lt lu lv li b">sessionDataKey</code>已经过期)。)</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/e2f7f4f9719ff03fe222c1a1a5207136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IlZjC0J__aUJFsuy7OVP6A.png"/></div></div></figure><p id="d1f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们授予客户端应用程序此权限，我们将被重定向到客户端应用程序，并带有包含授权代码和会话状态的有效负载。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/f20eaa2e3ebd72191b88342148319be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NJuYReqiYl5CmouKa2VoZA.png"/></div></div></figure><p id="0ff0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了授权码，它允许我们登录到应用程序。在这个OAuth/OIDC流中，我们遇到了来自<code class="du lt lu lv li b">commonauth</code>端点的<code class="du lt lu lv li b">commonAuthId</code> cookie和来自<code class="du lt lu lv li b">commonauth</code>端点之后的<code class="du lt lu lv li b">authorize</code>端点的<code class="du lt lu lv li b">obps</code> cookie。这两个cookies都用于SSO会话管理。例如，如果我们删除了<code class="du lt lu lv li b">opbs</code> cookie，将会生成另一个<code class="du lt lu lv li b">obps</code> cookie，因为<code class="du lt lu lv li b">commonAuthId</code> cookie存在于会话中。如果我们删除<code class="du lt lu lv li b">commonAuthId</code>，我们仍然可以访问在浏览器中打开的页面，但无法打开更多页面，因为网络应用/服务提供商会要求登录。但是，如果我们删除了这两个cookies，我们将从web应用程序中注销。</p><p id="2ccc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回头看看我们的申请，我们看到，我们同意<code class="du lt lu lv li b">Login</code>，那么<code class="du lt lu lv li b">Login</code>是如何进入同意流程的呢？它伴随着我们对<code class="du lt lu lv li b">scopes</code>的<code class="du lt lu lv li b">authorization</code>调用而来，因为我们提到<code class="du lt lu lv li b">internal_login</code>是一个范围，所以它在同意页面上。</p><p id="79ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了突出这一点，我们可以使用另一个范围，再次检查流量。如果我们发送下面的请求，<code class="du lt lu lv li b">https://localhost:9443/oauth2/authorize?response_type=code&amp;scope=openid internal_event_publish&amp;redirect_uri=http://localhost:8080/pickup-dispatch/oauth2client&amp;client_id=U0LDh6OPZfAoJn8aGrNywZXOMowa</code>我们将在<code class="du lt lu lv li b">consent.do</code>端点得到下面的消息。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/c0285c207e37ecdc00c57ccef5941ca1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tQYcwxPP0gVRtqCY9cV0UQ.png"/></div></div></figure><p id="d7e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于我们使用授权许可类型检查了OAuth/OIDC流程，我们可以将流程总结如下。</p><ul class=""><li id="f9d3" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><code class="du lt lu lv li b">https://localhost:9443/oauth2/authorize?response_type=code&amp;scope=openid internal_login&amp;redirect_uri=http://localhost:8080/pickup-dispatch/oauth2client&amp;client_id=U0LDh6OPZfAoJn8aGrNywZXOMowa</code> <br/> -初始授权请求。<br/> - <code class="du lt lu lv li b">sessionNonceCookie</code>被创造出来(<code class="du lt lu lv li b">sessionNonceCookie</code>被创造出来是为了躲避CSRF的攻击。此cookie包含与使用HMAC加密哈希加密的会话相关的重要数据。</li><li id="f346" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><code class="du lt lu lv li b">https://localhost:9443/authenticationendpoint/login.do...</code> <br/> -有效载荷<code class="du lt lu lv li b">relyingParty</code>有了<code class="du lt lu lv li b">OAuth Client Key</code>-<br/>-<code class="du lt lu lv li b">sessionDataKey</code>就创造出来了。</li><li id="f64e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><code class="du lt lu lv li b">https://localhost:9443/commonauth</code> <br/> -有效载荷包含<code class="du lt lu lv li b">username</code>和<code class="du lt lu lv li b">password</code> (OIDC JSON web token用户信息)<br/> - <code class="du lt lu lv li b">commonAuthId</code> cookie被创建。</li><li id="0789" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><code class="du lt lu lv li b">https://localhost:9443/oauth2/authorize?sessionDataKey=2b500ada-1a34-42dc-b7bc-0e045be1c0cd</code></li><li id="6604" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">有效载荷中<code class="du lt lu lv li b">https://localhost:9443/authenticationendpoint/oauth2_consent.do...</code>-<br/>-<code class="du lt lu lv li b">sessionDataKeyConsent</code>。</li><li id="2ccd" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><code class="du lt lu lv li b">https://localhost:9443/oauth2/authorize</code> <br/> - <code class="du lt lu lv li b">obps</code> cookie创建完毕。</li><li id="6b45" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><code class="du lt lu lv li b">https://localhost:8080/pickup-dispatch/oauth2client?code=ed96beb8-1e09-3e42-b91c-5b...</code><br/>——授权<code class="du lt lu lv li b">code</code>和<code class="du lt lu lv li b">session_state</code>在有效载荷中。</li><li id="9f83" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><code class="du lt lu lv li b">https://localhost:8080/pickup-dispatch/index.jsp</code></li></ul><p id="9235" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原来就是这样！这就是结局！希望你理解了入站认证在WSO2和OAuth 2.0以及OIDC中是如何工作的！</p><h2 id="a38b" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">参考</h2><ol class=""><li id="b548" class="jd je hi ih b ii kn im ko iq mb iu mc iy md jc kt jj jk jl bi translated"><a class="ae jr" href="https://frontegg.com/blog/oauth-grant-types" rel="noopener ugc nofollow" target="_blank">https://frontegg.com/blog/oauth-grant-types</a></li><li id="3c39" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kt jj jk jl bi translated"><a class="ae jr" href="https://wso2.com/blogs/thesource/2019/08/oauth-2-basics/" rel="noopener ugc nofollow" target="_blank">https://wso2.com/blogs/thesource/2019/08/oauth-2-basics/</a></li><li id="9a90" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kt jj jk jl bi translated"><a class="ae jr" href="https://developer.okta.com/docs/concepts/oauth-openid/" rel="noopener ugc nofollow" target="_blank">https://developer.okta.com/docs/concepts/oauth-openid/</a></li><li id="781f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kt jj jk jl bi translated"><a class="ae jr" href="https://is.docs.wso2.com/en/latest/references/concepts/authorization/grant-types/" rel="noopener ugc nofollow" target="_blank">https://is . docs . WSO 2 . com/en/latest/references/concepts/authorization/grant-types/</a></li><li id="7fe4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kt jj jk jl bi translated"><a class="ae jr" href="https://reqbin.com/curl" rel="noopener ugc nofollow" target="_blank">https://reqbin.com/curl</a></li></ol></div></div>    
</body>
</html>