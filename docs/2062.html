<html>
<head>
<title>Enable HTTP/2 and HTTPS on Apache Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Apache服务器上启用HTTP/2和HTTPS</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/enable-http-2-and-https-on-apache-server-d963b43aa6d?source=collection_archive---------4-----------------------#2022-04-18">https://medium.com/javarevisited/enable-http-2-and-https-on-apache-server-d963b43aa6d?source=collection_archive---------4-----------------------#2022-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="33cf" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">我们将讨论使Apache服务器能够通过HTTP/2提供资源所需的配置。我们还在Apache服务器上启用了HTTPS，因为浏览器只支持通过加密连接(SSL/TLS)的HTTP/2。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/02837880c067de1ac92d34f1b90c946e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*i4K0PB64UyR1rGLZQ_asFA.gif"/></div><p class="jf jg et er es jh ji bd b be z dx translated">图片来源:<a class="ae jj" href="https://css-tricks.com/http2-real-world-performance-test-analysis/" rel="noopener ugc nofollow" target="_blank"> HTTP/2 —大卫·阿塔尔德</a>的真实性能测试和分析</p></figure><p id="45fc" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">HTTP/2是HTTP协议的第二个版本，是为了解决HTTP/1.1的缺点而发布的。HTTP/2版本已经过优化，使网站加载速度明显加快。</p><p id="d01c" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">而在本文中，我们主要关注如何设置Apache服务器来使用HTTP/2。在靠近末尾的<strong class="jm hj">参考</strong>部分有一些链接，帮助你理解HTTP/2和HTTP/1.1之间的技术差异，以及它如何解决HTTP/1.1的缺点。</p><p id="e232" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">默认情况下，Apache 被设置为使用HTTP/1.1，但是加载了HTTP/2支持。但是在我们开始配置之前，让我们先来看看支持HTTP/2的浏览器。</p><h1 id="903f" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">浏览器支持</h1><p id="95fe" class="pw-post-body-paragraph jk jl hi jm b jn ky ij jp jq kz im js jt la jv jw jx lb jz ka kb lc kd ke kf hb bi translated">几乎所有现代浏览器都支持HTTP/2。如果托管网站的服务器也支持HTTP/2，则可以利用HTTP/2的优势。如果浏览器或web服务器不支持HTTP/2，它将退回到使用HTTP/1.1。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><a href="https://javarevisited.blogspot.com/2016/05/what-are-idempotent-and-safe-methods-of-HTTP-and-REST.html"><div class="er es ld"><img src="../Images/c9aeb251d86adea94f0bc33c22ede5c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jBkI0K1sEHXbgW1XgJ2VaA.png"/></div></a><p class="jf jg et er es jh ji bd b be z dx translated">来源:<a class="ae jj" href="https://caniuse.com/?search=HTTP2" rel="noopener ugc nofollow" target="_blank">我能用</a>吗</p></figure><h1 id="8b80" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">启用SSL作为先决条件</h1><p id="5b19" class="pw-post-body-paragraph jk jl hi jm b jn ky ij jp jq kz im js jt la jv jw jx lb jz ka kb lc kd ke kf hb bi translated">但是，只有加密连接才支持HTTP/2。该网站必须通过安全的SSL/TLS连接提供服务，并在浏览器中作为<code class="du le lf lg lh b">https://</code>访问。因此，在使用HTTP/2之前，服务器应该启用<a class="ae jj" href="https://javarevisited.blogspot.com/2022/02/top-5-courses-to-learn-ssl-and-tls-in.html" rel="noopener ugc nofollow" target="_blank"> SSL/TLS </a>。</p><p id="7d7b" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">启用SSL需要安全证书。出于本文的目的，我们将使用自签名证书，但是在生产中，您将使用由可信证书颁发机构(CA)颁发和签名的有效证书。</p><p id="4435" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">为了创建<a class="ae jj" href="https://www.java67.com/2012/09/keytool-command-examples-java-add-view-certificate-ssl.html" rel="noopener ugc nofollow" target="_blank">自签名证书</a>，我们将使用OpenSSL工具。在unix shell中运行以下命令(对于Windows，您可以使用作为Git安装的一部分提供的<code class="du le lf lg lh b">git-bash.exe</code>，它包括OpenSSL工具或<a class="ae jj" href="https://www.ssl.com/how-to/install-openssl-on-windows-with-cygwin/" rel="noopener ugc nofollow" target="_blank"> CYGWIN工具</a>来模拟unix命令。另外，<a class="ae jj" href="https://cmder.net/" rel="noopener ugc nofollow" target="_blank"> Cmder </a>是传统Windows CMD提示符的一个很好的替代选项，它允许您在运行Windows shell的同时运行unix shell。</p><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="0d12" class="lm kh hi lh b fi ln lo l lp lq">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout &lt;location&gt;/certs/server.key -out &lt;location&gt;/certs/server.crt</span></pre><p id="fa53" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated"><code class="du le lf lg lh b">&lt;location&gt;</code>这里是在<code class="du le lf lg lh b">httpd.conf</code>文件中配置的apache服务器的根目录<code class="du le lf lg lh b">${SRVROOT}</code>。</p><p id="a06c" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">执行<code class="du le lf lg lh b">openssl</code>命令会提示你输入一些细节，适当地填充它们。理想情况下,<code class="du le lf lg lh b">Common Name (e.g. server FQDN or YOUR name)</code>是您访问网页时使用的域名/IP，但出于开发目的，您可以将其保留为<code class="du le lf lg lh b">localhost</code></p><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="cced" class="lm kh hi lh b fi ln lo l lp lq">Country Name (2 letter code) [AU]:<strong class="lh hj">CN</strong><br/>State or Province Name (full name) [Some-State]:<strong class="lh hj">Some State</strong><br/>Locality Name (eg, city) []:<strong class="lh hj">Some City</strong><br/>Organization Name (eg, company) [Internet Widgits Pty Ltd]: <strong class="lh hj">Some Org</strong><br/>Organizational Unit Name (eg, section) []: <strong class="lh hj">Some OU</strong><br/>Common Name (e.g. server FQDN or YOUR name) []:<strong class="lh hj">localhost</strong><br/>Email Address []:<strong class="lh hj">example@example.org</strong></span></pre><p id="b0e7" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">这将在<code class="du le lf lg lh b">&lt;location&gt;/certs</code>目录中创建<code class="du le lf lg lh b">server.key</code>和<code class="du le lf lg lh b">server.crt</code>文件。</p><p id="d81d" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">在<code class="du le lf lg lh b">httpd.conf</code>文件中，取消下面3行的注释，</p><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="80f3" class="lm kh hi lh b fi ln lo l lp lq">LoadModule ssl_module modules/mod_ssl.so<br/>LoadModule socache_shmcb_module modules/mod_socache_shmcb.so<br/>Include conf/extra/httpd-ssl.conf</span></pre><p id="848f" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">在<code class="du le lf lg lh b">conf/extra/httpd-ssl.conf</code>文件中，您会发现已经在<code class="du le lf lg lh b">&lt;VirtualHost&gt;</code>中映射的证书，它使用我们在上面的步骤中创建的相同文件<code class="du le lf lg lh b">server.key</code>和<code class="du le lf lg lh b">server.crt</code>。</p><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="a2e6" class="lm kh hi lh b fi ln lo l lp lq">SSLCertificateFile "${SRVROOT}/conf/server.crt"<br/>SSLCertificateKeyFile "${SRVROOT}/conf/server.key"<br/>SSLEngine on</span></pre><p id="f3e8" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">重启服务器，在浏览器中打开<a class="ae jj" href="https://localhost/" rel="noopener ugc nofollow" target="_blank"> https://localhost:443 </a>。检查链接是否有效，默认页面是否可访问。您将看到一个访问页面的安全错误，但这没关系，因为我们使用自签名证书。在<code class="du le lf lg lh b">conf/extra/httpd-ssl.conf</code>中配置的默认SSL端口是443。</p><p id="32db" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated"><strong class="jm hj">注意</strong>:虽然通过HTTPS访问，但是请求直到此时仍然使用HTTP/1.1</p><h1 id="c3a3" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">启用HTTP/2</h1><p id="7576" class="pw-post-body-paragraph jk jl hi jm b jn ky ij jp jq kz im js jt la jv jw jx lb jz ka kb lc kd ke kf hb bi translated">要启用HTTP/2，在<code class="du le lf lg lh b">httpd.conf</code>中取消对下面一行的注释</p><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="dfca" class="lm kh hi lh b fi ln lo l lp lq">LoadModule http2_module modules/mod_http2.so</span></pre><p id="21e7" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">在<code class="du le lf lg lh b">conf/extra/httpd-ssl.conf</code>中，在接近结尾和结尾<code class="du le lf lg lh b">&lt;/VirtualHost&gt;</code>之前添加下面一行</p><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="44e6" class="lm kh hi lh b fi ln lo l lp lq">Protocols h2 h2c http/1.1</span></pre><p id="941d" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">现在，启用HTTP/2的配置已经完成，重新启动服务器并验证HTTP请求使用HTTP/2。</p><ul class=""><li id="0af2" class="lr ls hi jm b jn jo jq jr jt lt jx lu kb lv kf lw lx ly lz bi translated">使用<code class="du le lf lg lh b"><a class="ae jj" href="https://javarevisited.blogspot.com/2017/03/10-examples-of-curl-command-in-unix-and-Linux.html" rel="noopener ugc nofollow" target="_blank">curl</a></code>命令应输出以下内容</li></ul><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="8eda" class="lm kh hi lh b fi ln lo l lp lq">$ curl -Iks --http2 <a class="ae jj" href="https://localhost:443" rel="noopener ugc nofollow" target="_blank">https://localhost:443</a><br/><strong class="lh hj">HTTP/2 </strong>200<br/>last-modified: Mon, 11 Jun 2007 18:53:14 GMT<br/>etag: "2e-432a5e4a73a80"<br/>accept-ranges: bytes<br/>content-length: 46<br/>content-type: text/html<br/>date: Thu, 14 Apr 2022 22:02:56 GMT<br/>server: Apache/2.4.53 (Win64) OpenSSL/1.1.1n</span></pre><ul class=""><li id="8fbd" class="lr ls hi jm b jn jo jq jr jt lt jx lu kb lv kf lw lx ly lz bi translated">确认可以使用的HTTP变体</li></ul><pre class="iy iz ja jb fd li lh lj lk aw ll bi"><span id="33f2" class="lm kh hi lh b fi ln lo l lp lq">$  curl -vso /dev/null --http2 <a class="ae jj" href="https://localhost:443" rel="noopener ugc nofollow" target="_blank">https://localhost:443</a><br/>*   Trying 127.0.0.1:443...<br/>* Connected to localhost (127.0.0.1) port 443 (#0)<br/>* ALPN, offering <strong class="lh hj">h2</strong><br/>* ALPN, offering <strong class="lh hj">http/1.1</strong></span></pre><ul class=""><li id="6877" class="lr ls hi jm b jn jo jq jr jt lt jx lu kb lv kf lw lx ly lz bi translated">此外，您还可以检查浏览器的开发人员工具，以确认在访问位于<a class="ae jj" href="https://localhost/" rel="noopener ugc nofollow" target="_blank"> https://localhost:443 </a>的网站时使用HTTP/2作为协议。下图是使用Chrome开发者工具</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><a href="http://www.java67.com/2017/10/how-to-test-restful-web-services-using.html"><div class="er es ma"><img src="../Images/b33bf5e622c0941c0c5db5972f429ffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g6UGAm6c3FsSyL0xMtec-w.png"/></div></a><p class="jf jg et er es jh ji bd b be z dx translated">如何在Chrome开发工具中看到协议:<a class="ae jj" href="https://stackoverflow.com/a/54164719" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/a/54164719</a></p></figure><h1 id="a0cc" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">参考</h1><ul class=""><li id="db00" class="lr ls hi jm b jn ky jq kz jt mb jx mc kb md kf lw lx ly lz bi translated"><a class="ae jj" href="https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-apache-for-centos-7#step-2-creating-a-new-certificate" rel="noopener ugc nofollow" target="_blank">创建SSL证书</a></li><li id="1587" class="lr ls hi jm b jn me jq mf jt mg jx mh kb mi kf lw lx ly lz bi translated"><a class="ae jj" href="https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-apache-for-centos-7#step-3-setting-up-the-certificate" rel="noopener ugc nofollow" target="_blank">在Apache上配置SSL</a></li><li id="2c2d" class="lr ls hi jm b jn me jq mf jt mg jx mh kb mi kf lw lx ly lz bi translated"><a class="ae jj" rel="noopener" href="/tech-learnings/how-to-configure-apache-reverse-proxy-with-http-2-ebc87c1c7bcb">在Apache上启用HTTP/2</a></li><li id="1897" class="lr ls hi jm b jn me jq mf jt mg jx mh kb mi kf lw lx ly lz bi translated"><a class="ae jj" href="https://www.digitalocean.com/community/tutorials/http-1-1-vs-http-2-what-s-the-difference" rel="noopener ugc nofollow" target="_blank"> HTTP/1.1 vs HTTP/2:有什么区别？</a></li><li id="f0ae" class="lr ls hi jm b jn me jq mf jt mg jx mh kb mi kf lw lx ly lz bi translated"><a class="ae jj" href="https://www.collectiveray.com/what-is-http2" rel="noopener ugc nofollow" target="_blank">什么是HTTP2？</a></li></ul></div></div>    
</body>
</html>