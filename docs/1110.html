<html>
<head>
<title>Configuration or AutoConfiguration?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">配置还是自动配置？</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/configuration-or-autoconfiguration-ddb75a7b1548?source=collection_archive---------2-----------------------#2021-03-30">https://medium.com/javarevisited/configuration-or-autoconfiguration-ddb75a7b1548?source=collection_archive---------2-----------------------#2021-03-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9c6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">了解Spring boot中配置和自动配置的区别！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/73084fd2f3ab34d3d0a01ed0ad15d302.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xD2mCk0DBjyV6PRLUqZ82A.jpeg"/></div></div><p class="jp jq et er es jr js bd b be z dx translated">照片由<a class="ae jt" href="https://unsplash.com/@grakozy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">格雷格·拉科齐</a>在<a class="ae jt" href="https://unsplash.com/s/photos/magic?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="4911" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">春靴是关于魔法的。您将依赖项添加到类路径中，所有的东西就可以组合在一起工作了。它为你提供了一张画布。开箱即用的配置是固执己见的，并且会做出默认的配置选择，同时，如果您想要做出自己的配置选择，这些观点和配置将是第一个让出您的方式的。</p><p id="4d0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种神奇很大程度上是因为<a class="ae jt" href="https://docs.spring.io/spring-boot/docs/1.4.1.RELEASE/reference/html/using-boot-auto-configuration.html" rel="noopener ugc nofollow" target="_blank">自动配置</a>。除了以下两个不同之处，自动配置类与常规配置类非常相似:</p><ul class=""><li id="3f09" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">自动配置类最后运行(意味着在所有常规的非自动配置类之后)，而配置类的运行顺序是不确定的(除非我们使用像<code class="du kd ke kf kg b">@Ordered</code>这样的排序注释)</li><li id="d4d5" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">要声明一个类为<code class="du kd ke kf kg b">AutoConfiguration </code>，它们需要在<code class="du kd ke kf kg b">spring.factories</code>文件中指定。一个例子可以在<a class="ae jt" href="https://github.com/spring-projects/spring-boot/blob/v2.1.8.RELEASE/spring-boot-project/spring-boot-autoconfigure/src/main/resources/META-INF/spring.factories#L20" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</li></ul><p id="b22b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我相信您正在考虑什么时候应该选择自动配置类还是配置类。很棒的问题！就个人而言，我喜欢在以下情况下使用自动配置:</p><ul class=""><li id="b696" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">bean的创建依赖于其他bean的存在。换句话说，如果你正在考虑使用<code class="du kd ke kf kg b">@ConditionalOnBean</code>或者<code class="du kd ke kf kg b">@ConditionalOnMissingBean</code>注释。</li><li id="e9b4" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">您的配置依赖于其他自动配置。对于自动配置类，您可以使用<code class="du kd ke kf kg b">@AutoConfigureAfter</code>或<code class="du kd ke kf kg b">@AutoConfigureBefore</code>注释来控制beans的创建顺序。</li></ul><p id="a8b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一些例子(并做一些日志记录来理解beans创建的顺序):</p><h2 id="3d03" class="km kn hi bd ko kp kq kr ks kt ku kv kw iq kx ky kz iu la lb lc iy ld le lf lg bi translated">仅使用<code class="du kd ke kf kg b">@Configuration</code>的Beans</h2><p id="bfa7" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">让我们举一些非常非常简单的例子。考虑两个实用程序类:<code class="du kd ke kf kg b">StringUtils</code>和<code class="du kd ke kf kg b">ObjectUtils</code>:</p><pre class="je jf jg jh fd lm kg ln lo aw lp bi"><span id="c3e7" class="km kn hi kg b fi lq lr l ls lt">class StringUtils {</span><span id="52da" class="km kn hi kg b fi lu lr l ls lt">    fun isBlank(value: String): Boolean {</span><span id="979c" class="km kn hi kg b fi lu lr l ls lt">      // Implementation here</span><span id="b963" class="km kn hi kg b fi lu lr l ls lt">    }</span><span id="fbd3" class="km kn hi kg b fi lu lr l ls lt">    // Other utility methods will go here</span><span id="f4ce" class="km kn hi kg b fi lu lr l ls lt">}</span><span id="a50b" class="km kn hi kg b fi lu lr l ls lt">class ObjectUtils {</span><span id="30a6" class="km kn hi kg b fi lu lr l ls lt">    fun isNull(value: Object?): Boolean {</span><span id="b789" class="km kn hi kg b fi lu lr l ls lt">      // Implementation here</span><span id="b381" class="km kn hi kg b fi lu lr l ls lt">    }</span><span id="7afc" class="km kn hi kg b fi lu lr l ls lt">    // Other utility methods will go here</span><span id="d290" class="km kn hi kg b fi lu lr l ls lt">}</span></pre><p id="36fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将创建一个<code class="du kd ke kf kg b">StringUtilsConfiguration</code>类:</p><pre class="je jf jg jh fd lm kg ln lo aw lp bi"><span id="6cd5" class="km kn hi kg b fi lq lr l ls lt">@Configuration<br/>class StringUtilsConfiguration {</span><span id="44d1" class="km kn hi kg b fi lu lr l ls lt">    @Bean<br/>    fun stringUtils(): StringUtils {<br/>        logger.info("Running StringUtilsConfiguration")</span><span id="0483" class="km kn hi kg b fi lu lr l ls lt">        return StringUtils()<br/>    }</span><span id="379f" class="km kn hi kg b fi lu lr l ls lt">    companion object {</span><span id="24b8" class="km kn hi kg b fi lu lr l ls lt">       private val logger = Logger.getLogger(this.<em class="lv">javaClass</em>.<em class="lv">name</em>)<br/>    }</span><span id="1475" class="km kn hi kg b fi lu lr l ls lt">}</span></pre><p id="edd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有一个<code class="du kd ke kf kg b">ObjectUtilsConfiguration</code>类:</p><pre class="je jf jg jh fd lm kg ln lo aw lp bi"><span id="af66" class="km kn hi kg b fi lq lr l ls lt">@Configuration<br/>class ObjectUtilsConfiguration {</span><span id="3934" class="km kn hi kg b fi lu lr l ls lt">    @Bean<br/>    fun objectUtils(): ObjectUtils {<br/>        logger.info("Running ObjectUtilsConfiguration")</span><span id="8943" class="km kn hi kg b fi lu lr l ls lt">        ObjectUtils()<br/>    }</span><span id="d571" class="km kn hi kg b fi lu lr l ls lt">    companion object {</span><span id="2b2d" class="km kn hi kg b fi lu lr l ls lt">        private val logger = Logger.getLogger(this.<em class="lv">javaClass</em>.<em class="lv">name</em>)<br/>    }</span><span id="444c" class="km kn hi kg b fi lu lr l ls lt">}</span></pre><p id="211e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们要运行这个<a class="ae jt" href="https://javarevisited.blogspot.com/2018/05/the-springbootapplication-annotation-example-java-spring-boot.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> spring boot应用程序</strong> </a>，您应该会看到以下日志语句:</p><pre class="je jf jg jh fd lm kg ln lo aw lp bi"><span id="7427" class="km kn hi kg b fi lq lr l ls lt">Running ObjectUtilsConfiguration<br/>Running StringUtilsConfiguration</span></pre><p id="de5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了控制执行的顺序，我们可以使用<code class="du kd ke kf kg b">@Order</code>注释。但是当只有配置类时，这很容易。如果我们有许多配置类，或者如果我们需要根据其他bean是否存在来有条件地创建或不创建bean，那么排序就变得很困难。最后，如果我们想要提供默认值(例如:提供默认值)——输入自动配置。</p><h2 id="14e7" class="km kn hi bd ko kp kq kr ks kt ku kv kw iq kx ky kz iu la lb lc iy ld le lf lg bi translated">自动配置简介</h2><p id="0ece" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">如前所述，自动配置类是使Spring Boot如此有效的一个重要组成部分。我们可以在Spring boot的源代码中找到几个自动配置类。一些例子包括:<code class="du kd ke kf kg b">FlywayAutoConfiguration</code>、GsonAutoConfiguration、MailSenderAutoConfiguration等。</p><p id="53e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在很多这样的类中，你可能会看到某种形式的<code class="du kd ke kf kg b">@Conditionalxxx</code>注释。所以当这些条件满足时，这些类就会被执行。</p><p id="24cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从创建自动配置开始，为了简单起见，让我们将<code class="du kd ke kf kg b">StringUtilsConfiguration</code>类改为自动配置。我们需要做的唯一一件事是通过在<code class="du kd ke kf kg b">src/main/resource/META-INF</code>目录下创建一个<code class="du kd ke kf kg b">spring.factories</code>文件来将<code class="du kd ke kf kg b">StringUtilsConfiguration</code>注册为自动配置:</p><pre class="je jf jg jh fd lm kg ln lo aw lp bi"><span id="ea43" class="km kn hi kg b fi lq lr l ls lt">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\<br/>com.example.autoconfiguration.sample.ObjectUtilsConfiguration</span></pre><p id="d5a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我们运行这个应用程序，我们将会看到<code class="du kd ke kf kg b">ObjectUtilsConfiguration</code>类总是最后运行。</p><p id="6b3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当一个<a class="ae jt" href="https://www.java67.com/2018/05/difference-between-springbootapplication-vs-EnableAutoConfiguration-annotations-Spring-Boot.html" rel="noopener ugc nofollow" target="_blank">配置类</a>或者甚至仅仅是一个bean的创建依赖于其他bean的存在或不存在时，这一点确实很突出。<code class="du kd ke kf kg b">@ConditionalOnBean</code>是要使用的注释，但是从注释的文档来看:</p><blockquote class="lw lx ly"><p id="ecd1" class="if ig lv ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated"><code class="du kd ke kf kg b"><a class="ae jt" href="https://docs.spring.io/spring-framework/docs/5.3.2/javadoc-api/org/springframework/context/annotation/Conditional.html?is-external=true" rel="noopener ugc nofollow" target="_blank">@Conditional</a></code>仅当满足所有指定要求的beans已经包含在<code class="du kd ke kf kg b"><a class="ae jt" href="https://javarevisited.blogspot.com/2012/11/difference-between-beanfactory-vs-applicationcontext-spring-framework.html#axzz6CgkxY2DJ" rel="noopener ugc nofollow" target="_blank">BeanFactory</a></code>中时，才匹配。要使条件匹配，必须满足所有的要求，但是不一定要由同一个bean来满足。</p></blockquote><p id="8b24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如上所述，<code class="du kd ke kf kg b">@ConditionalOnBean</code>只查看BeanFactory的当前状态，而不查看bean是否会出现在应用程序中。因此，如果创建某个bean的类的配置依赖于另一个配置，那么一个选择是让您的配置成为自动配置，以确保它在所有其他非自动配置类之后运行。如果您的配置依赖于另一个自动配置，使用<code class="du kd ke kf kg b">@AutoConfigureAfter</code>或<code class="du kd ke kf kg b">@AutoConfigureBefore</code>会有所帮助。</p><h1 id="8080" class="mc kn hi bd ko md me mf ks mg mh mi kw mj mk ml kz mm mn mo lc mp mq mr lf ms bi translated">结论</h1><p id="674e" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">创建我们自己的类似于Spring boot的神奇代码来让事情“自动地”工作是非常非常容易的。但是最终会有一个点，知道和理解这两个选项之间的区别变得极其重要，以使这种魔力发挥作用。就<a class="ae jt" rel="noopener" href="/javarevisited/top-10-courses-to-learn-spring-boot-in-2020-best-of-lot-6ffce88a1b6e"> <strong class="ih hj"> Spring boot </strong> </a>而言，一个很好理解的话题就是自动配置！我希望我的博客帖子至少触及了表面:)</p></div></div>    
</body>
</html>