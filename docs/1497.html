<html>
<head>
<title>Securing Spring boot apps with Basic Auth and Keycloak</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用基本身份验证和密钥锁保护Spring boot应用</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/securing-spring-boot-apps-with-basic-auth-and-keycloak-649c9efeb9cd?source=collection_archive---------1-----------------------#2021-08-24">https://medium.com/javarevisited/securing-spring-boot-apps-with-basic-auth-and-keycloak-649c9efeb9cd?source=collection_archive---------1-----------------------#2021-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/85c07b01e79b079e6f5bcec47239f4d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-xc7TyBm2Bk6OR_DxFZFYQ.png"/></div></div></figure><p id="4594" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程中，我将介绍如何在基本认证的基础上将安全的Spring Boot应用程序与Keycloak集成在一起。这种集成在许多情况下可能会变得很方便。</p><p id="287d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我前段时间的一个任务就是这种情况，我们需要用基本授权来保护“<a class="ae jo" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html" rel="noopener ugc nofollow" target="_blank">致动器</a>”端点，以便<a class="ae jo" rel="noopener" href="/javarevisited/top-15-online-courses-to-learn-docker-kubernetes-and-aws-for-fullstack-developers-and-devops-d8cc4f16e773"> Kubernetes </a>能够与pod通信以获取健康、信息等指标。</p><p id="2e9b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同时，我们希望用keycloak保护其他端点，以便与服务进行正常交互。这有助于服务的松散耦合设计，因为如果keycloak服务器由于任何原因关闭，服务仍将运行。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="2a70" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">问题</h1><p id="97fd" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">为什么这种集成不能像预期的那样顺利工作的问题是两种安全机制相互重叠。过滤器<strong class="is hj">T5【KeycloakAuthenticationProcessingFilter.java】T6</strong>拦截每一个带有<a class="ae jo" href="https://javarevisited.blogspot.com/2018/01/how-http-basic-authentication-works-in.html" rel="noopener ugc nofollow" target="_blank"> HTTP授权头</a>的请求。因此，如果请求没有报头“Bearer: **** ”,它将被拒绝，并被重定向到keycloak进行身份验证，即使请求是用任何其他机制进行身份验证的，例如Basic-auth。</p><h1 id="c10d" class="jw jx hi bd jy jz la kb kc kd lb kf kg kh lc kj kk kl ld kn ko kp le kr ks kt bi translated">解决办法</h1><p id="3119" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">这里的解决思路是简单的在key cloak过滤器之前注册Basic-Auth <strong class="is hj"> <em class="kz">的过滤器。这可以使用<a class="ae jo" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/annotation/Order.html" rel="noopener ugc nofollow" target="_blank"> @order </a>注释表单spring轻松完成。它只允许我们根据需要安排配置的顺序。</em></strong></p><p id="3c41" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将从第一个配置类开始，这是基本的身份验证过滤器:</p><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="1aab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了使这个类尽可能方便，我们添加了这个“endPointMathcher ”,以便能够注册尽可能多的端点，以便在Basic-Auth下进行身份验证。它从配置文件(例如Yaml)中获取一个逗号分隔的列表，并对其进行匹配。</p><p id="dc7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我们将注册如下所示的Keycloak过滤器。此筛选器将用指定的客户端角色对任何其他端点进行身份验证。</p><figure class="lf lg lh li fd ij"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="baf8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们已经完成了java配置。然而，我们仍然需要创建keycloak所需的配置，例如，创建一个客户端并为其分配一个角色，然后根据此信息修改YAML/属性文件。这样，我们可以部署我们的服务，并且仍然能够更改任何配置，而不需要重新部署它。</p><p id="2db8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程的完整工作示例可以在<a class="ae jo" href="https://github.com/elmodeer/tutorials/tree/main/keycloak-basic-auth" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div></div>    
</body>
</html>