<html>
<head>
<title>Production Horrors — Handling Disasters: Public Debrief</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生产恐怖——处理灾难:公开汇报</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/production-horrors-handling-disasters-public-debrief-9fc8b57b127a?source=collection_archive---------3-----------------------#2021-10-28">https://medium.com/javarevisited/production-horrors-handling-disasters-public-debrief-9fc8b57b127a?source=collection_archive---------3-----------------------#2021-10-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/942c7b43e56b3669d8bfbab4d0716a80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XU4yxzMXfV8XPcPf0jzZWA.jpeg"/></div></div></figure><p id="a972" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">万圣节可能是开始这个新博客系列最合适的时间。我在这个博客中谈了很多理论，但是当你在生产灾难的第一线时，它会很快“变得真实”。人们通常认为生产灾难是崩溃或网站关闭，就像最近的脸书宕机。虽然这是一个有趣的话题，但许多这样的事情可能会被忽视，并像一堵砖墙一样击中你。</p><p id="2df8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">今天的恐怖故事是关于一个年轻的创业公司，因为缓存差点破产。我是这家公司的创始人，过去我写了很多关于这个的文章。已经过去几年了，虽然它仍然很痛，但我希望这一次我能以一种更超然的声音写作。</p><h1 id="a7b9" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">介绍</h1><p id="f56c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我在2012年初共同创立了<a class="ae jo" href="https://github.com/codenameone/CodenameOne" rel="noopener ugc nofollow" target="_blank">代号One </a>。该公司的SaaS部分是一个复杂的后端，协调构建服务器。这是2012年，没有集装箱/码头或任何类似的东西可供生产。当时PaaS相当大，App Engine也获得了一些支持。</p><p id="ddb1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为Codename One是一家Java商店，它需要快速升级以获得应用引擎，因为基础设施非常有意义。谷歌免费提供了一些计算资源，从而敲定了这笔交易。</p><p id="4a7d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当时App Engine没有提供<a class="ae jo" rel="noopener" href="/javarevisited/5-best-books-to-learn-sql-and-database-design-for-programmers-and-developers-1e7839df2f3e"> SQL </a>，只有数据存储。我们再次决定使用它，如果它足够好来运行谷歌，它足够好来运行我们的小产品。</p><p id="df34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们应该澄清一件重要的事情。App Engine当时有一个本地调试环境。但是你不能调试应用程序，因为它运行在云中。在Codename One的前2-3年，我们对App Engine非常满意。我甚至在JavaOne等的一次演讲中提倡它。</p><p id="4be7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后要知道的一件重要事情是，Codename One是一家自举公司。这是一个资金有限的开源框架。</p><h1 id="ec2b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">灾难来袭</h1><p id="a739" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">一个晴朗的日子，我们收到一封电子邮件，账单很高。这看起来很奇怪，但我们登录查看了一下。我们每月支付的金牌支持费用通常在70美元+ 400美元左右。此时的账单已经是4位数了。</p><p id="0c21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是歇斯底里发作的地方。我们没有那么多钱…</p><p id="4700" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，首要任务是减少我们拥有的每项资源，例如实例数量等。但这些都不是账单问题的原因。我们试图从谷歌的金牌支持团队获得帮助，但这是“无益的”(委婉地说)。谷歌的唯一建议是定义一个支出限额，从而有效地降低我们的服务。</p><p id="89b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">账单完全归因于声明中的一行:“应用引擎数据存储读取操作”。自然，我们希望了解这意味着什么，以及哪一部分代码正在执行所有这些读取…不幸的是，由于App Engine的构建方式(或大约在2015年构建)，没有办法知道这一点。</p><p id="4099" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">更糟糕的是，我们唯一的调试工具是日志，这很费钱。因此，为了解决支出增加的问题，我需要增加我们的支出。</p><p id="04fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">众所周知，App engine数据存储读取速度很慢。所以我们认为这是一个问题。Google提供了一个memcached实例，您应该在访问数据存储时使用它。据我所知，我们在任何经常用来缓存重要信息的地方都使用它。但似乎我们错过了一些点，新的应用引擎更新触发了这一点。</p><h1 id="41dd" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">解决</h1><p id="08b8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">不幸的是，在生产环境中部署新的更新是调试或修复它的唯一方法。但情况变得更糟了。</p><p id="6153" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Billing当时没有列出“实时”号码(我不确定现在是否会列出)。因此，我们不得不通过添加缓存层来猜测修复方法，然后重新部署，并等待一天，看看更改是否会影响计费。这实际上是最糟糕的情况，我们不得不等待24小时，看看计费是否受到修复的影响。</p><p id="21a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正因为如此，每一次修复的尝试都包含了对代码的许多不同的改进。直到今天，我们也不知道这个bug是什么，以及最终是什么修复了它。这完全有可能是谷歌解决的应用引擎中的一个错误。我们无从得知。</p><h1 id="029d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">汇报—吸取的经验教训</h1><h2 id="f1bf" class="ks jq hi bd jr kt ku kv jv kw kx ky jz jb kz la kd jf lb lc kh jj ld le kl lf bi translated">我们应该做什么</h2><p id="e76a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">这些年来，我一直在思考这个问题，首先，我们能做些什么来避免这个问题呢？</p><p id="e808" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，当我们第一次发现问题时，我们可以做些什么不同的事情？</p><p id="0761" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">单元测试？<br/> </strong>我们能编写单元测试来检测或重现问题吗？</p><p id="a6bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我真的不知道。我们使用JPA来抽象存储，我想我们可以模拟存储来查看访问是否被缓存。在我们有这个问题之前，这是一个非常小众的测试，我们可能不会写。</p><p id="56b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当<a class="ae jo" href="https://javarevisited.blogspot.com/2011/07/java-debugging-tutorial-example-tips.html#axzz6bYzaddcE" rel="noopener ugc nofollow" target="_blank">调试</a>这个的时候，我们试图通过测试或者在调试器中重现这个问题。我们无法重现这个问题。如果我们有更多的时间来调试这个问题并开发一个单元测试，我们也许能够在单元测试中重现它。但是我们在分秒必争地工作。一名医生试图修复一名流血的病人，没有时间进行复杂的测试。</p><p id="94fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为这个问题发生在我们的代码之外，即使我们有100%的测试覆盖率，我们也不会发现这个问题。因此，虽然单元测试确实是一个有价值的工具，但在这种情况下，我看不出它们事先会有什么帮助。</p><p id="a5bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">可观察性<br/> </strong>这确实凸显了可观察性的重要性和它的缺失。在这种情况下，我对谷歌最大的不满之一是:他们对数据存储读取访问收费。但是它们不能告诉我我从哪个数据存储中读取(哪个实体/表)。如果有一个大致的方向，指出问题发生在哪里，可以为我们节省数千美元。</p><p id="50b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可观察性工具是至关重要的，它们需要深入挖掘粒度的能力。</p><p id="a83f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">即时反馈<br/> </strong>这在其他情况下似乎是一种奢侈，但在这里我们看到了它的重要性。因为一个持续了几天的问题，测试/部署/等待周期实际上花费了我们数千美元。想象一下，如果我们是一家流量更大的公司，我们可能会损失数百万。</p><p id="924e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您遇到生产问题时，您需要您的工具来立即报告。你需要知道确切的问题，你需要知道你的解决方法是否有效。由于App Engine的性质，我们无法使用当时可用的一些工具。回想起来，我们需要更好的工具。</p><p id="889f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">本地调试<br/> </strong>有一个运动是<a class="ae jo" href="https://dev.to/garethmcc/why-local-development-for-serverless-is-an-anti-pattern-1d9b" rel="noopener ugc nofollow" target="_blank">反对本地调试的想法</a>(至少在无服务器中)。我明白他们的一些观点。例如，在这种情况下，本地调试没有重现问题。这给了我们错误的信心，以为事情会成功，但事实并非如此。</p><p id="91dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是我不确定我是否同意这个底线。我觉得本地调试应该更贴近生产。我仍然认为我们需要工具来<a class="ae jo" href="https://lightrun.com/" rel="noopener ugc nofollow" target="_blank">调试产品</a>，但是它们应该是对本地工作环境的补充。</p><p id="f44d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">支出限额<br/> </strong>直到今天我都不知道自己跳过支出限额的决定是否正确。我们是否应该让服务中断几天，让我们“想办法解决问题”？</p><p id="1ab8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我真的不知道。</p><h2 id="b426" class="ks jq hi bd jr kt ku kv jv kw kx ky jz jb kz la kd jf lb lc kh jj ld le kl lf bi translated">你有危险吗？</h2><p id="5550" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">你可能会认为自己没有风险。你不用App Engine，大概不用PaaS。</p><p id="ad86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，无服务器和第三方API也有类似的风险。这是一个非常普遍的问题，例如，有人甚至不小心用电子表格黑了自己。另一个团队获得了一个免费账户的72000美元账单</p><p id="083c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些故事到处都是。</p><p id="d043" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您选择使用此类服务，您必须定义一个消费限额。您还应该使用可观察性工具，并设置触发器，以便在发生任何变化时向您发出警告。</p><h1 id="e7b7" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">收场白</h1><p id="2e13" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">几年前，我见到了Light run的创始人。他们概述了他们对公司的愿景，公司实际上是一个生产调试器，可以安全地为我们提供即时反馈。我立刻想到了这个故事。</p><p id="1e4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那时候我能用这个工具做什么呢？</p><p id="7683" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我们感受到痛苦时，想法就有了意义，我深深地感受到了痛苦。这使得加入Lightrun的决定显而易见。所以我猜这个恐怖故事有一个美好的结局。</p><h1 id="f8c5" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="6a3c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">今天的恐怖故事是关于一个有前途的年轻自举公司，冒险进入一个似乎友好和有益健康的环境…却发现账单一夜之间突然翻转，并产生了巨额费用。</p><p id="3682" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可能是下一个，因为许多年轻的公司已经陷入了这个噩梦。</p><h1 id="838b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">讲述你的故事</h1><p id="e6ee" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">有没有有趣的生产灾难故事分享？</p><p id="f282" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">给我写信，地址是shaia (at) lightrun (dot) com。如果你想去掉你的名字/公司名称，我很乐意帮忙…我可以提供一个超级酷的Lightrun赠品盒作为奖励，我们这里的赠品是顶级的！</p><p id="41de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">期待收到你的来信。</p></div></div>    
</body>
</html>