<html>
<head>
<title>HiveMQ Cloud, part 4 — Sending sensor data from Raspberry Pi Pico W to HiveMQ Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HiveMQ云，第4部分—将传感器数据从Raspberry Pi Pico W发送到HiveMQ云</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/hivemq-cloud-part-4-sending-sensor-data-from-raspberry-pi-pico-w-to-hivemq-cloud-15c236651a69?source=collection_archive---------1-----------------------#2022-12-08">https://medium.com/javarevisited/hivemq-cloud-part-4-sending-sensor-data-from-raspberry-pi-pico-w-to-hivemq-cloud-15c236651a69?source=collection_archive---------1-----------------------#2022-12-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3aa4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">整整一年前，2021年12月，我发表了<a class="ae jd" href="https://webtechie.be/tags/hivemq/" rel="noopener ugc nofollow" target="_blank">三篇用Raspberry Pi、Raspberry Pi Pico和HiveMQ Cloud </a>进行MQTT消息传递的文章。2022年6月30日，树莓派发布了一款新产品，这就是本文的主题:<strong class="ih hj"> Pico W </strong>。是的，原版<strong class="ih hj"> Pico </strong>的新版本，但是有无线网络。新的主板售价为6美元，而原来的Pico为4美元。</p><p id="27a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们将重新编写去年12月文章的第三个项目，其中使用Pico、单独的Wi-Fi模块和距离传感器将数据发送到HiveMQ Cloud。我们现在可以通过使用新的Pico W来简化该项目，不再需要单独的Wi-Fi模块。</p><p id="9bfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个项目和前面三个部分的来源都是在GitHub 上可以找到的<a class="ae jd" href="https://github.com/FDelporte/HiveMQ-examples" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="21a0" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">关于HiveMQ云</h1><p id="053b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://www.hivemq.com/mqtt-cloud-broker/" rel="noopener ugc nofollow" target="_blank"> HiveMQ Cloud </a>是一项在线MQTT兼容服务，最多可对100台设备完全免费！即使对最热情的制造者来说，那也是一大堆微控制器或计算机！</p><p id="af07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在HiveMQ博客上，Kudzai Manditereza发表了一篇<a class="ae jd" href="https://www.hivemq.com/blog/iot-reading-sensor-data-raspberry-pi-pico-w-micropython-mqtt-node-red/" rel="noopener ugc nofollow" target="_blank">文章，也描述了如何使用Pico W </a>。</p><h1 id="0112" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">关于树莓派</h1><p id="60e3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">新款Pico W的外形与原来的Pico完全相同。由于板载LED的连接方式发生了变化，因此布线略有变化。您应该能够在大多数现有项目中切换到新版本，没有任何问题。</p><h1 id="c227" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">接线</h1><h1 id="837a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">试验板设置</h1><p id="4f95" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">拿一块试验板和一些电线来创建这个小测试设置。与之前的Pico和一个额外的Adafruit AirLift Wi-Fi相比，现在的设置简单多了。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/26c8610c280c5a87c5b51830bc585fbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OKxLLotp8zRD1QclTFBlRw.jpeg"/></div></div></figure><p id="f957" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唯一需要连接的部件是距离传感器。</p><h1 id="94e7" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">距离传感器</h1><p id="2e14" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">只需要4根线，为了简单起见，连接到前一篇文章中使用的相同引脚，但当然你可以自由使用其他的，只要你在代码中使用正确的数字。</p><ul class=""><li id="af17" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated"><strong class="ih hj"> Pico &gt; HC-SR04 </strong></li><li id="2122" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">VBUS &gt; Vcc</li><li id="d4d7" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">GND &gt; GND</li><li id="8fc3" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">GP16 &gt;回声</li><li id="02f3" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">GP17 &gt;触发器</li></ul><h1 id="bdbf" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">MicroPython项目</h1><p id="5c68" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在之前的Pico项目中，<a class="ae jd" href="https://circuitpython.org/" rel="noopener ugc nofollow" target="_blank"> CircuitPython </a>用于编写程序。不幸的是，当我开始这个项目将Pico W连接到HiveMQ Cloud时，CircuitPython还不支持Pico W的WiFi模块。GitHub 上的<a class="ae jd" href="https://github.com/adafruit/circuitpython/issues/6558" rel="noopener ugc nofollow" target="_blank">票现在似乎已经关闭并解决了，所以我让你来尝试一下。在这篇文章中，我们将使用</a><a class="ae jd" href="https://micropython.org/" rel="noopener ugc nofollow" target="_blank"> MicroPython </a>。</p><p id="e8bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lh">“MicroPython是Python 3编程语言的一个精简而高效的实现，它包括Python标准库的一个小子集，并针对在微控制器和受限环境中运行进行了优化。”</em>。</p><p id="e893" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了<strong class="ih hj">在Pico W </strong>上安装MicroPython，<a class="ae jd" href="https://www.raspberrypi.com/documentation/microcontrollers/micropython.html" rel="noopener ugc nofollow" target="_blank">按照Raspberry Pi </a>提供的步骤进行操作。</p><p id="e943" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如HiveMQ Cloud所要求的那样，建立安全连接是一个额外的挑战。最后，和大多数时候一样，只是找到正确的库和设置的问题。幸运的是，我得到了HiveMQ论坛<a class="ae jd" href="https://community.hivemq.com/t/getting-started-raspberry-pi-pico-w/1316" rel="noopener ugc nofollow" target="_blank">一些成员的支持，正如你在这个帖子</a>中看到的。</p><p id="4bbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">警告！如果您使用的是装有macOS Ventura的Apple电脑，连接到Pico可能会有问题。见<a class="ae jd" href="https://www.raspberrypi.com/news/the-ventura-problem/?mc_cid=54f69c07e7&amp;mc_eid=787c121758" rel="noopener ugc nofollow" target="_blank">这篇博文</a>了解更多信息。</p><h1 id="39ad" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">在Mac上安装Thonny IDE</h1><p id="34f6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我尝试了几种ide来编写Pico W，但是发现Thonny是最好的选择。它适用于Windows、Mac和Linux。在macOS上你可以很容易地用<code class="du li lj lk ll b">brew install --cask thonny</code>安装。安装后，请确保打开“查看&gt;文件”，并在屏幕右下角选择您的主板“MicroPython (RP2040)”，如您在截图中所见。</p><figure class="ki kj kk kl fd km er es paragraph-image"><a href="https://javarevisited.blogspot.com/2022/03/3-examples-to-parse-json-in-java-using.html"><div class="er es lm"><img src="../Images/c3b14d571202969392ba16d532f68a56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*go1p0e61RMynYNkjZEqOuA.png"/></div></a></figure><h1 id="06de" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">安装库</h1><p id="d969" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们的应用程序将使用两个库来最小化我们需要自己编写的代码。</p><p id="e18b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个给了我们一个MQTTClient。从MicroPython项目中的GitHub上可以找到的文件<a class="ae jd" href="https://github.com/micropython/micropython-lib/blob/master/micropython/umqtt.simple/umqtt/simple.py" rel="noopener ugc nofollow" target="_blank">中复制代码，在Thonny中创建新文件，并将其作为文件<code class="du li lj lk ll b">simple.py</code>保存到目录<code class="du li lj lk ll b">/lib/umqtt/</code>中的Pico W中。</a></p><p id="b639" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MicroPython提供的另一种安装库的方法是在Thonny中使用终端并运行以下两个命令:</p><pre class="ki kj kk kl fd ln ll lo bn lp lq bi"><span id="aa11" class="lr jf hi ll b be ls lt l lu lv">&gt;&gt;&gt; import upip<br/>&gt;&gt;&gt; upip.install('umqtt.simple')<br/>Installing to: /lib/<br/>Warning: micropython.org SSL certificate is not validated<br/>Installing umqtt.simple 1.3.4 from https://micropython.org/pi/umqtt.simple/umqtt.simple-1.3.4.tar.gz</span></pre><p id="541b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二个库帮助我们使用HC-SR04传感器进行距离测量。再次，从rsc1975 (Roberto) 的一个项目中复制GitHub的<a class="ae jd" href="https://github.com/rsc1975/micropython-hcsr04/blob/master/hcsr04.py" rel="noopener ugc nofollow" target="_blank">这段代码，在Thonny中创建一个新文件，并作为文件<code class="du li lj lk ll b">hcsr04.py</code>保存到目录<code class="du li lj lk ll b">/lib/hcsr04/</code>中的Pico W中。</a></p><h1 id="dda6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">秘密</h1><p id="861b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在Pico W的根目录下创建一个名为<code class="du li lj lk ll b">secrets.py</code>的文件，包含以下内容(这个文件与前一篇文章中使用的Pico文件相同)。</p><pre class="ki kj kk kl fd ln ll lo bn lp lq bi"><span id="051a" class="lr jf hi ll b be ls lt l lu lv">secrets = {<br/>   'ssid' : 'WIFI_NETWORK_NAME',<br/>   'password' : 'WIFI_PASSWORD',<br/>   'timezone' : 'Europe/Brussels',<br/>   'mqtt_username' : 'HIVEMQ_USERNAME',<br/>   'mqtt_key' : 'HIVEMQ_PASSWORD',<br/>   'broker' : 'YOUR_INSTANCE.hivemq.cloud',<br/>   'port' : 8883<br/>}</span></pre><h1 id="0d19" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">项目代码</h1><p id="84c2" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">最后一部分是实际的应用程序代码。在Pico W的根目录下创建一个名为<code class="du li lj lk ll b">main.py</code>的额外文件，内容如下:</p><pre class="ki kj kk kl fd ln ll lo bn lp lq bi"><span id="31ad" class="lr jf hi ll b be ls lt l lu lv">import time<br/>import secrets<br/>import network<br/>import ntptime<br/>import ussl<br/><br/>from machine import Pin<br/>from umqtt.simple import MQTTClient<br/>from hcsr04.hcsr04 import HCSR04<br/>from time import sleep<br/><br/># Blink the onboard LED to show startup<br/>led = Pin("LED", Pin.OUT)<br/>led.off()<br/>time.sleep_ms(50)<br/>led.on()<br/>time.sleep_ms(50)<br/>led.off()<br/>time.sleep_ms(50)<br/>led.on()<br/>time.sleep_ms(50)<br/>led.off()<br/><br/># Load the WiFi and HiveMQ Cloud credentials from secrets.py<br/>try:<br/>    from secrets import secrets<br/>except ImportError:<br/>    print("Error, secrets could not be read")<br/>    raise<br/><br/># Connect to WiFi<br/># Based on https://datasheets.raspberrypi.com/picow/connecting-to-the-internet-with-pico-w.pdf<br/>print('----------------------------------------------------------------------------------------------')<br/>print('Connecting to AP: ' + secrets["ssid"])<br/>wlan = network.WLAN(network.STA_IF)<br/>wlan.active(True)<br/>wlan.connect(secrets["ssid"], secrets["password"])<br/><br/># Wait for WiFi connection or failure<br/>connected = False<br/>attempt = 0<br/>while not connected and attempt &lt; 10:<br/>    attempt += 1<br/>    if wlan.status() &lt; 0 or wlan.status() &gt;= 3:<br/>        connected = True<br/>    if not connected:<br/>        print("Connection attempt failed: " + str(attempt))<br/>        time.sleep(1)<br/>    else:<br/>        print("Connected on attempt: " + str(attempt))<br/>        <br/>if not connected or wlan.ifconfig()[0] == "0.0.0.0":<br/>    # Blink LED to show there is a WiFi problem<br/>    print("Bad WiFi connection: " + wlan.ifconfig()[0])<br/>    while True:<br/>        # Endless loop as we don't have a WiFi connection<br/>        led.off()<br/>        time.sleep_ms(150)<br/>        led.on()<br/>        time.sleep_ms(150)<br/><br/># As we end up here, we now we have a WiFi connection<br/>print("WiFi status: " + str(wlan.ifconfig()))<br/>led.on()<br/><br/># To validate certificates, a valid time is required<br/># NTP is used to get the correct time<br/># https://en.wikipedia.org/wiki/Network_Time_Protocol<br/>print('----------------------------------------------------------------------------------------------')<br/>print('Connecting to NTP')<br/>ntptime.host = "de.pool.ntp.org"<br/>ntptime.settime()<br/>print('Current time: ' + str(time.localtime()))<br/><br/># Load the certificate for secure connection to HiveMQ Cloud<br/>print('----------------------------------------------------------------------------------------------')<br/>print('Loading CA Certificate')<br/>with open("/certs/hivemq-com-chain_2_only.der", 'rb') as f:<br/>    cacert = f.read()<br/>f.close()<br/>print('Obtained CA Certificate')<br/><br/># Connect to HiveMQ Cloud<br/># Based on https://www.tomshardware.com/how-to/send-and-receive-data-raspberry-pi-pico-w-mqtt<br/>print('----------------------------------------------------------------------------------------------')<br/>print("Connecting to " + secrets["broker"] + " as user " + secrets["mqtt_username"])<br/><br/># Use sslparams as defined below for a secure connection<br/># sslparams = {'server_side': False,<br/>#             'key': None,<br/>#             'cert': None,<br/>#             'cert_reqs': ussl.CERT_REQUIRED,<br/>#             'cadata': cacert,<br/>#             'server_hostname': secrets["broker"]}<br/><br/># When using the sslparams below, a connection can be made to HiveMQ Cloud, but it's not secure<br/>sslparams = {'server_hostname': secrets["broker"]}<br/><br/>mqtt_client = MQTTClient(client_id="picow",<br/>                    server=secrets["broker"],<br/>                    port=secrets["port"],<br/>                    user=secrets["mqtt_username"],<br/>                    password=secrets["mqtt_key"],<br/>                    keepalive=3600,<br/>                    ssl=True,<br/>                    ssl_params=sslparams) <br/>mqtt_client.connect()<br/>print('Connected to MQTT Broker: ' + secrets["broker"])<br/><br/># Send a test message to HiveMQ<br/>mqtt_client.publish('test', 'HelloWorld')<br/><br/># Continuously measure the distance and send the value to HiveMQ<br/># Based on https://randomnerdtutorials.com/micropython-hc-sr04-ultrasonic-esp32-esp8266/<br/>hcsr04 = HCSR04(trigger_pin=17, echo_pin=16, echo_timeout_us=10000)<br/>print("Starting the distance measurement")<br/>killed = False<br/>while not killed:<br/>    # Measure distance<br/>    distance = 0<br/>    try:<br/>        distance = hcsr04.distance_cm()<br/>    except Exception as e:<br/>        print("Distance measurement failure\n", e)<br/>        <br/>    # Send to HiveMQ Cloud<br/>    try:<br/>        json = "{\"value\": " + str(distance) + "}"<br/>        print("\tMessage for queue: " + json)<br/>        mqtt_client.publish("picow/distance", json)<br/>    except Exception as e:<br/>        print("\tMQTT publish Failed, retrying\n", e)<br/>        killed = True<br/>        continue<br/><br/>    # Sleep a second<br/>    time.sleep(1)</span></pre><p id="ef42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当使用Thonny中的“Run current script”按钮执行上述代码时，您应该得到以下输出，显示设备连接到Wi-Fi并开始发送数据。</p><pre class="ki kj kk kl fd ln ll lo bn lp lq bi"><span id="aef6" class="lr jf hi ll b be ls lt l lu lv">&gt;&gt;&gt; %Run -c $EDITOR_CONTENT<br/>----------------------------------------------------------------------------------------------<br/>Connecting to AP: ***<br/>Connected on attempt: 1<br/>WiFi status: ('172.16.1.88', '255.255.255.0', '172.16.1.1', '172.16.1.1')<br/>----------------------------------------------------------------------------------------------<br/>Connecting to NTP<br/>Current time: (2022, 9, 29, 16, 2, 20, 3, 272)<br/>----------------------------------------------------------------------------------------------<br/>Loading CA Certificate<br/>Obtained CA Certificate<br/>----------------------------------------------------------------------------------------------<br/>Connecting to ***.s1.eu.hivemq.cloud as user picow-user<br/>Connected to MQTT Broker: ***.s1.eu.hivemq.cloud<br/>Starting the distance measurement<br/>   Message for queue: {"value": 108.6254}<br/>   Message for queue: {"value": 107.732}<br/>   Message for queue: {"value": 14.10653}<br/>   Message for queue: {"value": 16.95876}</span></pre><h1 id="f63d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="3707" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">HiveMQ Cloud需要一个<a class="ae jd" rel="noopener" href="/javarevisited/best-https-ssl-and-tls-courses-for-beginners-4437661250b3"> TLS </a>(安全)连接，这对于这种小型电路板来说有点挑战性。但仍然可以很容易地建立连接，从那时起，可能性是无穷的，即使是6美元的小电路板。</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="306d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lh">最初发布于</em><a class="ae jd" href="https://webtechie.be/post/2022-12-07-sending-sensor-data-from-raspberry-pi-pico-w-to-hivemq-cloud/" rel="noopener ugc nofollow" target="_blank"><em class="lh">https://web techie . be</em></a><em class="lh">。</em></p></div></div>    
</body>
</html>