<html>
<head>
<title>Simple Digital Signature Validation on PDF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PDF上的简单数字签名验证</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/simple-digital-signature-validation-on-pdf-17a66c1bf8d2?source=collection_archive---------0-----------------------#2021-12-06">https://medium.com/javarevisited/simple-digital-signature-validation-on-pdf-17a66c1bf8d2?source=collection_archive---------0-----------------------#2021-12-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="c9d8" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated"><strong class="ak"> 1。简介</strong></h2><p id="2426" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke hb bi translated">基于维基百科，数字签名(DS)是一种验证数字消息或文档真实性的数学方案。它被用作不可否认的工具。</p><p id="d61b" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">PDF中的数字签名类型从消息摘要到另一种类型的签名(CMS高级电子签名或CAdES <em class="kk">)各不相同。</em>本文将详细介绍如何验证PDF文件中的数字签名。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="72b0" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">2.问题陈述</h2><ul class=""><li id="8e40" class="kl km hi jm b jn jo jr js ix kn jb ko jf kp ke kq kr ks kt bi translated">PDF上的数字签名验证</li><li id="2631" class="kl km hi jm b jn ku jr kv ix kw jb kx jf ky ke kq kr ks kt bi translated">类型签名:CAdES分离、PKCS7分离或ETSI。RFC3161</li></ul></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="16ec" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">3.PDF中的数字签名</h2><p id="861e" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke hb bi translated">当您在文本编辑器中打开PDF文件时，您会发现其中包含标签的结构，有点像xml文件。数字签名放在Sig类型标记(签名字典)中。尝试在PDF文件中找到这种标签/类型/签名。下面是一个例子:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es kz"><img src="../Images/86f2e6551005ff160e256f8a4deef87a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pz2EsLmxITDcZGMQAWFFGA.png"/></div></div><p class="ll lm et er es ln lo bd b be z dx translated">PDF中的数字签名示例</p></figure><p id="d334" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">在那里，您还可以看到一个过滤器和子过滤器标签。有关该标签中值的进一步解释，您可以查看PDF 32000–1:2008文档第12.8.1节。进一步深入Sig字典，您会发现一个Contents标记。该标记内是数字签名的Based64值。下面的例子显示了内容标签中的CAdES签名。还要注意ByteRange标记，我们也将在数字签名验证过程中使用它。</p><figure class="la lb lc ld fd le er es paragraph-image"><div class="er es lp"><img src="../Images/12d5ab12c7778cd3a866fb39d7c983ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*eNAvPALaCQtz8YWF-hH6HA.png"/></div><p class="ll lm et er es ln lo bd b be z dx translated">数字签名内容标签示例</p></figure></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="218b" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">4.数字签名验证</h2><p id="1ea2" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke hb bi translated">我们将重点关注PDF(/子过滤器类型ETSI)上的PAdES-B签名。CAdES.detached)。它基本上是使用CAdES-detached签名放入内容标签。下图描述了验证的步骤。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lq"><img src="../Images/4f8de255b71e3e7ff4435813de747145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iv6ar-CJd2teITS-gPnWGQ.png"/></div></div><p class="ll lm et er es ln lo bd b be z dx translated">PDF签名验证流程</p></figure><ol class=""><li id="498d" class="kl km hi jm b jn kf jr kg ix lr jb ls jf lt ke lu kr ks kt bi translated">将/Contents标记中的内容解析为CMS(加密消息语法)</li><li id="5f77" class="kl km hi jm b jn ku jr kv ix kw jb kx jf ky ke lu kr ks kt bi translated">验证CMS中的签名是否有效(使用signerInfo类型的证书，将其与CMS中的签名属性进行比较)</li><li id="9cc5" class="kl km hi jm b jn ku jr kv ix kw jb kx jf ky ke lu kr ks kt bi translated">如果有效，那么从CMS中的签名属性获取消息摘要。还要获取使用的摘要算法(SHA1、SHA256等)</li><li id="a8ab" class="kl km hi jm b jn ku jr kv ix kw jb kx jf ky ke lu kr ks kt bi translated">计算PDF中的实际消息摘要(使用第3条中的字节数和摘要算法)</li><li id="bc28" class="kl km hi jm b jn ku jr kv ix kw jb kx jf ky ke lu kr ks kt bi translated">比较数字(3)和数字(4)，如果有效，则数字签名值有效</li></ol><p id="40b0" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">需要注意的是，上述步骤没有处理数字证书验证、CRL检查或OCSP检查。我们将在另一篇文章中讨论这个问题。所以，让我们把上面的步骤分解成java代码。实际代码可以在我的<a class="ae lv" href="https://github.com/rsatrio/PDF-Signature-Check/" rel="noopener ugc nofollow" target="_blank"> github </a>中看到。我们将使用2个外部库:pdfbox和bouncycastle。</p><p id="7a52" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated"><strong class="jm hj"> 4.1解析CMS内容内部/内容标签</strong></p><p id="2a81" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">首先打开pdf，用这行代码获得签名:</p><figure class="la lb lc ld fd le"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="3fd1" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">然后获取签名中的/Contents标记:</p><pre class="la lb lc ld fd ly lz ma mb aw mc bi"><span id="966c" class="im in hi lz b fi md me l mf mg">//Get PKCS#7 Data<br/>        CMSSignedData signedData=new CMSSignedData(signature.getContents());</span></pre><p id="08e1" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated"><strong class="jm hj"> 4.2验证CMS签名有效</strong></p><p id="d2a0" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">首先，我们获得了CMS内部的signerInfo:</p><pre class="la lb lc ld fd ly lz ma mb aw mc bi"><span id="8467" class="im in hi lz b fi md me l mf mg">//Get SignerInfo<br/>SignerInformation signerInfo=signedData.getSignerInfos().iterator().next();</span></pre><p id="2e0f" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">然后，我们获得了CMS内部的公钥:</p><figure class="la lb lc ld fd le"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="c995" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">然后，我们获得了签名算法:</p><figure class="la lb lc ld fd le"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="5bf3" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">然后，我们检查CMS内部签名的有效性:</p><pre class="la lb lc ld fd ly lz ma mb aw mc bi"><span id="1f04" class="im in hi lz b fi md me l mf mg">Signature rsaSign=Signature.getInstance(encAlgo);       <br/>        rsaSign.initVerify(pubKey);<br/>        rsaSign.update(signerInfo.getEncodedSignedAttributes());<br/>        boolean cmsSignatureValid=rsaSign.verify(signerInfo.getSignature());</span></pre><p id="cc90" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated"><strong class="jm hj"> 4.3获取CMS内的消息摘要算法和消息摘要数据</strong></p><figure class="la lb lc ld fd le"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="8b37" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated"><strong class="jm hj"> 4.4计算PDF中的消息摘要</strong></p><p id="e5e7" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">首先，我们计算PDF上的字节数数据</p><figure class="la lb lc ld fd le"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="92f4" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">然后，我们在PDF上计算消息摘要</p><pre class="la lb lc ld fd ly lz ma mb aw mc bi"><span id="1ce1" class="im in hi lz b fi md me l mf mg">//Calculate MD in PDF<br/><br/>        String mdPdf=Base64.getEncoder().encodeToString(digest.digest(contentToSigned));</span></pre><p id="76fa" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated"><strong class="jm hj"> 4.5比较CMS中的信息摘要和PDF中的计算结果</strong></p><p id="a81b" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated">如果相同，则签名有效。另一方面，如果不相同，则签名无效。</p><pre class="la lb lc ld fd ly lz ma mb aw mc bi"><span id="2823" class="im in hi lz b fi md me l mf mg">if(mdPdf.equals(messageDigest)) {<br/>            logApp.info("Message Digest Signature ID {} is valid, data integrity is OK",signatureSID);<br/>        }<br/>        else    {<br/>            logApp.info("Message Digest Signature ID {} is invalid, data integrity is NOT OK",signatureSID);<br/>        }</span></pre></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h2 id="e8e2" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">5.评论</h2><p id="625e" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke hb bi translated">基本上，我们在这个博客中讨论的是一个非常简单的PDF文件中数字签名验证的例子。我们希望这个简单的例子足以成为理解验证如何工作以及PDF中的数字签名如何工作的起点。如果您有任何问题或建议，请在下面评论。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="90ee" class="pw-post-body-paragraph jk jl hi jm b jn kf jp jq jr kg jt ju ix kh jw jx jb ki jz ka jf kj kc kd ke hb bi translated"><strong class="jm hj"> 6。参考文献</strong></p><ul class=""><li id="6a32" class="kl km hi jm b jn kf jr kg ix lr jb ls jf lt ke kq kr ks kt bi translated"><a class="ae lv" href="http://www.adobe.com/go/pdfreference" rel="noopener ugc nofollow" target="_blank">www.adobe.com/go/pdfreference</a></li><li id="5e5d" class="kl km hi jm b jn ku jr kv ix kw jb kx jf ky ke kq kr ks kt bi translated"><a class="ae lv" href="https://github.com/rsatrio/PDF-Signature-Check/" rel="noopener ugc nofollow" target="_blank">https://github.com/rsatrio/PDF-Signature-Check/</a></li></ul></div></div>    
</body>
</html>