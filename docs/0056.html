<html>
<head>
<title>How to use Temporary files for Unit testing in Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Java 中使用临时文件进行单元测试</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/using-temporary-files-for-unit-testing-5e6e281e40db?source=collection_archive---------0-----------------------#2019-04-24">https://medium.com/javarevisited/using-temporary-files-for-unit-testing-5e6e281e40db?source=collection_archive---------0-----------------------#2019-04-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/4be160ed0063f56e49ec9d6c6df2853d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*KN4IiAnc6KYhb3wHaBQ8Tg.png"/></div></figure><p id="af6d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有时我们需要创建临时文件，并在单元测试中使用它们。通常，我喜欢这样。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="12d8" class="jt ju hi jp b fi jv jw l jx jy">@Test void testSome() {<br/>    File file;<br/>    try {<br/>        file = File.createTempFile("tmp", null);<br/>    } catch (IOException ioe) {<br/>        throw new RuntimeException(ioe);<br/>    }<br/>    //file.deleteOnExit(); // not recommended at all<br/>    try {<br/>        // do some with the file<br/>    } finally {<br/>        if (file.isFile() &amp;&amp; !file.delete()) {<br/>            // failed to delete the (existing) file<br/>        }<br/>    }<br/>}</span></pre><h1 id="999a" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">效用函数</h1><p id="b9ca" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">随着测试用例数量的增长，我们可以像这样使用实用方法。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="41f7" class="jt ju hi jp b fi jv jw l jx jy">static &lt;R&gt; applyTempFile(Function&lt;File, R&gt; function) {<br/>    File file;<br/>    try {<br/>        file = File.createTempFile("tmp", null);<br/>    } catch (IOException ioe) {<br/>        throw new RuntimeException(ioe);<br/>    }<br/>    try {<br/>        return function.apply(file);<br/>    } finally {<br/>        if (file.isFile() &amp;&amp; !file.delete()) {<br/>            // failed to delete the (existing) file<br/>        }<br/>    }<br/>}</span><span id="13fc" class="jt ju hi jp b fi lb jw l jx jy">static &lt;R, U&gt; applyTempFile(BiFunction&lt;File, U, R&gt; function,<br/>                            Supplier&lt;U&gt; supplier) {<br/>    return applyTempFile(f -&gt; function.apply(f, supplier.get()));<br/>}</span><span id="2b4b" class="jt ju hi jp b fi lb jw l jx jy">static void acceptTempFile(Consumer&lt;File&gt; consumer) {<br/>    applyTempFile(f -&gt; {<br/>        consumer.accept(f);<br/>        return null;<br/>    });<br/>}</span><span id="d536" class="jt ju hi jp b fi lb jw l jx jy">static &lt;U&gt; void acceptTempFile(BiConsumer&lt;File, U&gt; consumer,<br/>                               Supplier&lt;U&gt; supplier) {<br/>    acceptTempFile(f -&gt; consumer.accept(f, supplier.get()));<br/>}</span><span id="506b" class="jt ju hi jp b fi lb jw l jx jy">// TODO: add methods for java.nio.file.Path</span></pre><h1 id="b49f" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">参数解析器</h1><p id="2981" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">另一种方法是使用一个<code class="du lc ld le jp b"><a class="ae lf" href="https://junit.org/junit5/docs/current/api/org/junit/jupiter/api/extension/ParameterResolver.html" rel="noopener ugc nofollow" target="_blank">ParameterResolver</a></code>。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="d5a8" class="jt ju hi jp b fi jv jw l jx jy">class TemporaryFileParameterResolver implements ParameterResolver {</span><span id="b638" class="jt ju hi jp b fi lb jw l jx jy">    <a class="ae lf" href="http://twitter.com/Documented" rel="noopener ugc nofollow" target="_blank">@Documented</a><br/>    <a class="ae lf" href="http://twitter.com/Retention" rel="noopener ugc nofollow" target="_blank">@Retention</a>(RetentionPolicy.RUNTIME)<br/>    <a class="ae lf" href="http://twitter.com/Target" rel="noopener ugc nofollow" target="_blank">@Target</a>({ElementType.PARAMETER})<br/>    <a class="ae lf" href="http://twitter.com/interface" rel="noopener ugc nofollow" target="_blank">@interface</a> Temporary {<br/>        boolean deleteOnExit() default true;<br/>    }</span><span id="3a10" class="jt ju hi jp b fi lb jw l jx jy">    <a class="ae lf" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public boolean supportsParameter(<br/>            ParameterContext parameterContext,<br/>            ExtensionContext extensionContext)<br/>            throws ParameterResolutionException {<br/>        if (parameterContext.isAnnotated(Temporary.class)) {<br/>            Parameter parameter = parameterContext.getParameter();<br/>            Class&lt;?&gt; parameterType = parameter.getType();<br/>            return File.class == parameterType<br/>                   || Path.class == parameterType;<br/>        }<br/>        return false;<br/>    }</span><span id="1700" class="jt ju hi jp b fi lb jw l jx jy">    <a class="ae lf" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public Object resolveParameter(<br/>            ParameterContext parameterContext,<br/>            ExtensionContext extensionContext)<br/>            throws ParameterResolutionException {<br/>        Parameter parameter = parameterContext.getParameter();<br/>        Temporary temporary =<br/>            parameter.getAnnotation(Temporary.class);<br/>        Class&lt;?&gt; parameterType = parameter.getType();<br/>        if (File.class == parameterType) {<br/>            File file;<br/>            try {<br/>                file = File.createTempFile("tmp", null);<br/>            } catch (final IOException ioe) {<br/>                throw new ParameterResolutionException(ioe);<br/>            }<br/>            if (temporary.deleteOnExit()) {<br/>                file.deleteOnExit();<br/>            }<br/>            return file;<br/>        }<br/>        if (Path.class == parameterType) {<br/>            Path path;<br/>            try {<br/>                path = Files.createTempFile(null, null);<br/>            } catch (final IOException ioe) {<br/>                throw new ParameterResolutionException(<br/>                    "failed to create a temporary file", ioe);<br/>            }<br/>            if (temporary.deleteOnExit()) {<br/>                Runtime.getRuntime().addShutdownHook(<br/>                    new Thread(() -&gt; {<br/>                        try {<br/>                            Files.deleteIfExists(path);<br/>                        } catch (final IOException ioe) {<br/>                            throw new RuntimeException(ioe);<br/>                        }<br/>                    }));<br/>            }<br/>            return path;<br/>        }<br/>        throw new ParameterResolutionException(<br/>            "failed to resolve parameter for " + parameterContext);<br/>    }<br/>}</span></pre><p id="fd08" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们可以像这样使用 resolver 类。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="2c2f" class="jt ju hi jp b fi jv jw l jx jy">@ExtendWith({TemporaryFileParameterResolver.class})<br/>class SomeTest {</span><span id="e969" class="jt ju hi jp b fi lb jw l jx jy">    @Test void testWithFile(@Temporary File file) {<br/>    }</span><span id="f070" class="jt ju hi jp b fi lb jw l jx jy">    @Test void testWithPath(@Temporary Path path) {<br/>    }<br/>}</span></pre><h1 id="282f" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">小心<code class="du lc ld le jp b">deleteOnExit</code>和<code class="du lc ld le jp b">addShutdownHook</code></h1><p id="3c93" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">根据 JDK 的源代码，<code class="du lc ld le jp b">deleteOnExit</code>将文件的路径添加到一个<code class="du lc ld le jp b">Set</code>中，<code class="du lc ld le jp b">addShutdownHook</code>将<a class="ae lf" href="https://javarevisited.blogspot.com/2018/06/top-5-java-multithreading-and-concurrency-courses-experienced-programmers.html" rel="noopener ugc nofollow" target="_blank">线程</a>添加到一个<code class="du lc ld le jp b">Map</code>中，并在<a class="ae lf" href="https://javarevisited.blogspot.com/2019/04/top-5-courses-to-learn-jvm-internals.html" rel="noopener ugc nofollow" target="_blank"> JVM </a>关闭时清理它们。</p><p id="c0ca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这意味着过多的文件/引用可能会留在存储/内存中，直到一个干净的关闭过程。</p><p id="ab2a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就是为什么我首先在注释上添加了<code class="du lc ld le jp b">deleteOnExit</code>元素。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="6b2a" class="jt ju hi jp b fi jv jw l jx jy">@ExtendWith({TemporaryFileParameterResolver.class})<br/>class SomeExcessiveFileTest {</span><span id="c2c9" class="jt ju hi jp b fi lb jw l jx jy">    @RepeatedTest(1048576) <br/>    void test(@Temporary(deleteOnExit = false) File file) {<br/>        try {<br/>            // do some with the file<br/>        } finally {<br/>            if (file.isFile() &amp;&amp; !file.delete()) {<br/>            }<br/>        }<br/>    }</span><span id="20ce" class="jt ju hi jp b fi lb jw l jx jy">    @RepeatedTest(1048576)<br/>    void test(@Temporary(deleteOnExit = false) Path path) {<br/>        try {<br/>            // do some with the path<br/>        } finally {<br/>            boolean deleted = Files.deleteIfExists(path);<br/>        }<br/>    }<br/>}</span></pre><p id="1d15" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就是关于如何使用临时文件进行单元测试，以及如何在测试后进行清理，以便您的应用程序在新的测试中始终处于良好的状态。</p><p id="4a9f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你想学习更多关于 Java 单元测试的知识，这里有一些有用的资源。</p><ol class=""><li id="0a1c" class="lg lh hi io b ip iq it iu ix li jb lj jf lk jj ll lm ln lo bi translated"><a class="ae lf" href="https://click.linksynergy.com/deeplink?id=JVFxdTr9V80&amp;mid=39197&amp;murl=https%3A%2F%2Fwww.udemy.com%2Fjunit5-for-beginners%2F" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj">面向初学者的 Java 单元测试</strong> </a></li><li id="062a" class="lg lh hi io b ip lp it lq ix lr jb ls jf lt jj ll lm ln lo bi translated"><a class="ae lf" href="https://click.linksynergy.com/deeplink?id=JVFxdTr9V80&amp;mid=39197&amp;murl=https%3A%2F%2Fwww.udemy.com%2Fmockito-tutorial-with-junit-examples%2F" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj">用 JUnit&amp;mock ITO 30 步</strong> </a>学习单元测试</li><li id="632f" class="lg lh hi io b ip lp it lq ix lr jb ls jf lt jj ll lm ln lo bi translated"><a class="ae lf" href="https://pluralsight.pxf.io/c/1193463/424552/7490?u=https%3A%2F%2Fwww.pluralsight.com%2Fcourses%2Ftest-driven-development-java" rel="noopener ugc nofollow" target="_blank"><strong class="io hj">Java 测试驱动开发实践</strong> </a></li><li id="9064" class="lg lh hi io b ip lp it lq ix lr jb ls jf lt jj ll lm ln lo bi translated"><a class="ae lf" href="https://javarevisited.blogspot.com/2018/01/10-unit-testing-and-integration-tools-for-java-programmers.html" rel="noopener ugc nofollow" target="_blank"><strong class="io hj">Java 开发者应该知道的 10 个测试库</strong> </a></li><li id="791a" class="lg lh hi io b ip lp it lq ix lr jb ls jf lt jj ll lm ln lo bi translated"><a class="ae lf" href="https://javarevisited.blogspot.com/2019/04/top-5-junit-and-unit-testing-courses-java-programmers.html" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj">程序员前 5 名 JUnit 和单元测试课程</strong> </a></li></ol><h1 id="9316" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结束语</h1><p id="52f3" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">感谢您阅读本文。对于 Java 程序员来说，这是一个非常有用技巧。如果你喜欢这篇文章，那么请考虑以下我们在媒体上发表的文章。</p><p id="5f5a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你想在每篇新帖子上得到通知，别忘了在 Twitter 上关注<strong class="io hj"/><a class="ae lf" href="https://twitter.com/javarevisited" rel="noopener ugc nofollow" target="_blank"><strong class="io hj">javarevited</strong></a>！</p></div></div>    
</body>
</html>