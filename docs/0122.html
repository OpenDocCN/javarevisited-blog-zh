<html>
<head>
<title>Autoscaling with Kinesis stream</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kinesis流自动缩放</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/autoscaling-with-kinesis-stream-cogs-reduction-dfd87848ce9a?source=collection_archive---------1-----------------------#2019-09-12">https://medium.com/javarevisited/autoscaling-with-kinesis-stream-cogs-reduction-dfd87848ce9a?source=collection_archive---------1-----------------------#2019-09-12</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><figure class="hi hj fa fc hk hl es et paragraph-image"><div class="es et hh"><img src="../Images/a0785d3730c439d18ed05d17dbbcc5b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*-y41FB3oKZH4KbJz4fpedg.png"/></div></figure><div class=""/></div><div class="ab cl in io gq ip" role="separator"><span class="iq bw bk ir is it"/><span class="iq bw bk ir is it"/><span class="iq bw bk ir is"/></div><div class="hc hd he hf hg"><h1 id="4dcf" class="iu iv hq bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">问题陈述</h1><p id="4ab4" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">由于<a class="ae kq" rel="noopener" href="/javarevisited/top-10-courses-to-learn-amazon-web-services-aws-cloud-in-2020-best-and-free-317f10d7c21d"> AWS </a>不支持kinesis流的自动缩放，大多数时候我们要么过度供应碎片并支付更多费用，要么供应不足并影响性能。</p><h1 id="50d2" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">解决方案:</h1><p id="3254" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">使用云观察警报、SNS主题和Lambda的组合，我们可以实现kinesis流的自动缩放，通过它我们可以管理碎片数量，并在成本和性能之间达到正确的平衡。</p><h1 id="c513" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">解决方案概述:</h1><p id="f9dc" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">通过监控“腐败记录”来实现放大和缩小。流的“字节”度量:</p><ul class=""><li id="1568" class="kw kx hq ju b jv ky jz kz kd la kh lb kl lc kp ld le lf lg bi translated">在给定的2分钟滚动窗口内，一旦流的利用率超过其容量的80%,就会自动扩大(碎片加倍)。</li><li id="f634" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">在给定的5分钟滚动窗口内，一旦流的利用率不超过其容量的40%至少3次，就会自动缩减(将碎片减半)</li></ul><p id="099a" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated"><strong class="ju hr">注:</strong></p><p id="0776" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">我们也可以使用“IncomingBytes”或“IncomingRecords”来实现同样的功能。</p><p id="90c9" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">我们的纵向扩展速度非常快，因此不会影响性能，而横向扩展速度很慢，因此我们可以避免太多的纵向扩展和横向扩展操作。</p><h1 id="335d" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">实施细节:</h1><h1 id="aeaa" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">确定kinesis流的利用率百分比:</h1><p id="7b0b" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">假设:</p><p id="a8eb" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">有效负载大小= 100 KB</p><p id="7622" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">总记录数(每秒)= 500</p><p id="7dd2" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">AWS建议碎片计数= 49</p><p id="1bf0" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">为了确定其80%的利用率，我们执行以下操作:</p><p id="5164" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">2分钟内可写入的最大总字节数= (((100 * 500)*60)*2) = 6，000，000 KB</p><p id="95f3" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">其中的80%将= 4，800，000 KB</p><p id="bed3" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">同样，其中的40%将是2，400，000 KB</p><h1 id="7c64" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">超过尺寸范围</h1><p id="c75e" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">下图显示了我们执行横向扩展操作时的流程</p><figure class="lq lr ls lt fe hl es et paragraph-image"><a href="https://medium.com/javarevisited/top-5-aws-training-courses-to-crack-amazon-web-service-solutions-architect-associate-certification-3f4affa8f660?source=collection_home---4------0-----------------------"><div class="es et lp"><img src="../Images/2df91a13698489711d7b997f33145cda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uKjD0i5SdgTKlTmRhSc-3Q.png"/></div></a></figure><p id="3a21" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">“横向扩展警报”的配置为:</p><ul class=""><li id="a982" class="kw kx hq ju b jv ky jz kz kd la kh lb kl lc kp ld le lf lg bi translated">公制名称:腐败线。字节</li><li id="2c55" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">流名:ETL Kinesis流</li><li id="59c4" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">时长:2分钟</li><li id="1c4f" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">阈值&gt; = 4800000</li><li id="533a" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">数据点:1</li><li id="d010" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">统计:总和</li><li id="9c7a" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">操作:通知主题“缩放SNS主题”</li></ul><p id="5e29" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">因此，当我们达到80%的流容量时，会发生以下情况:</p><ul class=""><li id="ea54" class="kw kx hq ju b jv ky jz kz kd la kh lb kl lc kp ld le lf lg bi translated">将触发云监控警报“向外扩展警报”</li><li id="f9f1" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">通知被发送到SNS主题“扩展SNS主题”,这触发了“扩展lambda”</li><li id="7734" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">Lambda将缩放碎片数量=当前碎片* 2，并根据新的碎片计数将阈值更新为。那么，假设新的碎片计数是“98”</li><li id="9ec5" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">2分钟内可写入的最大字节数(100 KB * 1000条记录)= 12，000，000 KB</li><li id="4c4d" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">其中80%是960万KB</li><li id="50f1" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">其中的40%将是4，800，000 KB</li><li id="1fc6" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">将“横向扩展警报”从“警报”状态重置回“正常”状态</li></ul><h1 id="696a" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">放大</h1><p id="3db0" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">下图显示了我们在操作中进行称重时的流程</p><figure class="lq lr ls lt fe hl es et paragraph-image"><a href="https://javarevisited.blogspot.com/2020/05/top-5-amazon-web-services-aws-courses-for-beginners-and-experienced-programmers.html"><div class="es et lu"><img src="../Images/b6b93fc9fdfa3a5af48622076657619b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZqG-l__uqERUgfsFzow9Iw.png"/></div></a></figure><p id="9af6" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated"><strong class="ju hr">注:</strong></p><p id="18e9" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">计算15分钟间隔的40%值= (100*1000*15*60)*40/100 = 36，000，000</p><p id="a4a6" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">“报警秤”的配置为:</p><ul class=""><li id="8067" class="kw kx hq ju b jv ky jz kz kd la kh lb kl lc kp ld le lf lg bi translated">公制名称:腐败线。字节</li><li id="0ddb" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">流名:ETL Kinesis流</li><li id="b8e3" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">时间:15分钟</li><li id="24f4" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">阈值&lt; = 36000000</li><li id="a6f7" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">数据点:3</li><li id="711f" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">统计:总和</li><li id="3db3" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">操作:通知主题“在SNS主题中缩放”</li></ul><p id="97dc" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">因此，当我们仅利用40%的流容量时，会发生以下情况:</p><ul class=""><li id="b547" class="kw kx hq ju b jv ky jz kz kd la kh lb kl lc kp ld le lf lg bi translated">将触发云监控警报“秤入警报”</li><li id="3adc" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">通知被发送到SNS主题“在SNS主题中缩放”,这触发了“在lambda中缩放”</li><li id="1267" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">Lambda将缩放碎片数=当前碎片数/ 2，并根据新的碎片计数将阈值更新为。</li><li id="5a00" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">将“警报中的秤”从“警报”状态重置回“正常”状态</li></ul><h1 id="4f81" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">Lambda(横向扩展)</h1><p id="7146" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">附加的代码“Lambda.js”是用nodeJs编写的，只是为了演示，所以不是动态计算阈值，而是硬编码的，但相同的代码可以得到增强，以确定本文中提到的所有事情</p><h2 id="9f0b" class="lv iv hq bd iw lw lx ly ja lz ma mb je kd mc md ji kh me mf jm kl mg mh jq mi bi translated">环境变量:</h2><ul class=""><li id="5f1c" class="kw kx hq ju b jv jw jz ka kd mj kh mk kl ml kp ld le lf lg bi translated">ALARM_NAME = "横向扩展警报"</li><li id="4523" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">MAX_SHARDS = 100</li><li id="871e" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">MIN_SHARDS = 10</li><li id="27a6" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">STREAM_NAME = "ETL Kinesis stream "</li></ul><h2 id="4e0a" class="lv iv hq bd iw lw lx ly ja lz ma mb je kd mc md ji kh me mf jm kl mg mh jq mi bi translated">伪代码:</h2><ul class=""><li id="9bd6" class="kw kx hq ju b jv jw jz ka kd mj kh mk kl ml kp ld le lf lg bi translated">描述流，并且仅当流没有“更新”时才继续(如果先前的放大/缩小动作没有完成)</li><li id="a264" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">计算新的shardCount</li><li id="1289" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">使用“putMetricAlarm()”更新cloudwatch警报阈值</li><li id="aeb0" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">使用“updateShardCount()”更新碎片计数</li><li id="e735" class="kw kx hq ju b jv lh jz li kd lj kh lk kl ll kp ld le lf lg bi translated">使用“describeStream()”等待碎片放大或缩小操作完成(当前代码中未实现)，然后使用“setAlarmState()”将警报状态重置为“正常”状态</li></ul><h1 id="ffb7" class="iu iv hq bd iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr bi translated">COGS减少:</h1><p id="de33" class="pw-post-body-paragraph js jt hq ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hc bi translated">为了获得1000 TPS的记录大小为100KB的有效载荷，我们需要支付1223.62美元，通过这种方法，我们可以控制规模的扩大和缩小，这直接降低了这些AWS资源的成本</p><p id="1477" class="pw-post-body-paragraph js jt hq ju b jv ky jx jy jz kz kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp hc bi translated">我很乐意接受对这种方法的任何反馈或改进，感谢您的阅读。</p></div></div>    
</body>
</html>