<html>
<head>
<title>60x Performance Improvement &amp; Moving on fullstack — Building DDTJ Day 7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">60倍的性能提升和全面升级—构建DDTJ第7天</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/60x-performance-improvement-moving-on-fullstack-building-ddtj-day-7-1deec0dc932a?source=collection_archive---------3-----------------------#2021-12-28">https://medium.com/javarevisited/60x-performance-improvement-moving-on-fullstack-building-ddtj-day-7-1deec0dc932a?source=collection_archive---------3-----------------------#2021-12-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0d5812a8312ff4e73195512c4456060b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JhhJySGSDiFZhY-b59FnjA.png"/></div></div></figure><p id="2a65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">昨天<a class="ae jo" href="https://dev.to/codenameone/good-news-and-bad-news-pivot-and-turn-building-ddtj-day-6-1pl4" rel="noopener ugc nofollow" target="_blank">事情开始好转</a>，今天我完全康复了…</p><p id="2313" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">自周四以来，我一直有点情绪低落。这是每个重要项目中的一个自然阶段。它仍然很难，这是大多数人在开源项目中崩溃的地方。它不再“有趣”。但是坚持是很重要的。一旦我们有了一个你好的世界，能量就回来了，这是新的一天！</p><p id="92b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与此同时，我合并了两个公关。这个<a class="ae jo" href="https://github.com/ddtj/ddtj/pull/4" rel="noopener ugc nofollow" target="_blank">怪物PR </a>最终实现了所有的调试逻辑，所以我们可以收集我们需要的所有数据。然后<a class="ae jo" href="https://github.com/ddtj/ddtj/pull/5" rel="noopener ugc nofollow" target="_blank">我合并了一个小的补丁</a>，它提升了性能，稍后我会讨论。</p><p id="74b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">直到昨天，我仍然怀疑自己是否有能力交付我选择的架构。性能是否足够合理？</p><h1 id="96d7" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">60倍的改进</h1><p id="e9b6" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">昨天我想分享我对性能的怀疑，但我选择不这样做。我遇到过很多这样的情况，人们不停地谈论…他们肯定性能问题是由x引起的。然后他们以丢脸告终。</p><p id="7e33" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我的“猜测”实际上是正确的。我在没有任何状态保存代码的情况下测量了应用程序运行时。也就是说我们只是和JDI一起发布，没有其他的。性能几乎一样差，这意味着我的大部分代码运行良好。</p><p id="3644" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那么是什么原因导致了性能缓慢呢？</p><p id="6198" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在开发过程中，我必须删除对以下内容的调用:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="691f" class="lb jq hi kx b fi lc ld l le lf">methodEntryRequest.addClassFilter(filter);</span></pre><p id="6914" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">实际上，有很多电话。我尝试了很多东西，如排除过滤器等。</p><p id="eec4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我不得不删除它们的原因是它们不起作用！</p><h1 id="ab4e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">如果方法不“添加”,就不要将其命名为“添加”</h1><p id="cbf8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><a class="ae jo" href="https://docs.oracle.com/en/java/javase/11/docs/api/jdk.jdi/com/sun/jdi/request/MethodEntryRequest.html#addClassFilter(java.lang.String)" rel="noopener ugc nofollow" target="_blank"> addClassFilter </a> API其实应该命名为<code class="du lg lh li kx b">setClassFilter</code>。添加额外的过滤器会禁用该功能。不幸的是，JavaDoc中没有提到这一点。我选择的解决方法实际上非常简单，我创建了多个<code class="du lg lh li kx b">MethodEntryRequest</code>实例，并将每个实例绑定到不同的过滤器类型。</p><p id="42aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在它仅限于用户类过滤器和<code class="du lg lh li kx b">javax</code>包。为了证明概念，我可能会添加更多。为此，我们自然需要更多的配置选项。</p><p id="44a4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">添加一个简单的过滤器就完全不同了。它减少了虚拟机的网络开销，并实现了快速性能。也许如果我采用了代理方法(也就是“过程中”)，我会有更好的表现。可能需要重新评估未来。</p><p id="ec6a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有了这个小小的调整，现在项目生命的这个阶段的性能是可以接受的，所以我们可以继续了。</p><h1 id="e169" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">您在PR变更日志中看不到的内容</h1><p id="8ee5" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我进行了压缩和合并，所以在这个过程中我的很多修改都消失在日志中了。除非你去明确的公关和审查提交，你不会看到这一点。当我决定转而使用方法入口/出口时，我写了很多代码，结果都在剪辑室的地板上。</p><p id="3f1a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于这种类型的项目，这是开发人员需要处理的最困难的事情之一:沉没成本的谬误。我已经写了代码，我不能旋转。</p><p id="819b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">自然，这是有价值的。我不是在提倡一种yoyo发展战略。但是我们需要准备放弃工作，保持客观。</p><h1 id="016b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">我没怎么评论</h1><p id="b242" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">一些人私下向我指出，我写代码时没有注释。</p><p id="492d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我曾经注释了很多…事实上，我的代码比源代码有更多的注释行。正如你从我的博客中看到的，我喜欢写作，并且可以用键盘创作很多作品。阻碍因素不是时间，甚至不是努力。</p><p id="cffc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">问题是，评论变得陈旧，如果你写得太多，大多数人都不会看。我尽量让代码简单。如果需要评论，我会尽量简化。通过尽可能避免评论，我确保人们阅读真正重要的评论。</p><p id="39ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在构建公共API时有一个主要的例外，那就是JavaDoc。这一点很重要，应该一直完整地写下来。但是源代码中的注释经常被忽略。</p><h1 id="1e14" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">我需要清理测试</h1><p id="614c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">一段时间以来，我一直在追逐我的覆盖率故事，试图让每次公关的覆盖率达到80%。这很痛苦。不幸的是，这些测试有很多重复的代码和简单的黑客行为。</p><p id="1384" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我需要对这个东西做一次彻底的检查，但我想先把产品拿出来。我可能别无选择，因为我昨晚花了几个小时试图让覆盖率超过80%。</p><h1 id="3e3b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">在本地工作时，CI在服务器上失败</h1><p id="9bc9" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">前几天这让我抓狂。单元测试在本地完全通过，但在github操作中运行时无法工作。错误消息表明spring framework打包有些奇怪。一些完全没有意义的事情。</p><p id="545c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我试图隔离环境差异等等。原来这一条<a class="ae jo" href="https://github.com/ddtj/ddtj/blob/3af940425721155557d0b9253fb5a0fded970f3a/.github/workflows/build.yml#L43" rel="noopener ugc nofollow" target="_blank">小线</a>，确保java bin目录在路径中。这个小小的改变让测试通过了。我不知道我是怎么猜到的。我什么都试过了，直到成功。</p><h1 id="8e33" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">转到CLI和测试生成</h1><p id="1009" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我可以选择两个方向:</p><ul class=""><li id="4e8e" class="lj lk hi is b it iu ix iy jb ll jf lm jj ln jn lo lp lq lr bi translated">试着让Spring Boot运行代码</li><li id="107d" class="lj lk hi is b it ls ix lt jb lu jf lv jj lw jn lo lp lq lr bi translated">完成CLI并为hello world测试用例生成一个测试</li></ul><p id="eba1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我倾向于后者，无论何时你在新项目中遇到这样的问题，你也应该这样做。</p><p id="d01c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当创建项目时，我们需要先建立它的广度，而不是深度。我们至少需要一个所有东西协同工作的基本实现，这样我们才能理解移动的部分。所以我们可以接受第三方在项目中的帮助。广度有助于透视，它“证明”项目。深度在后面。</p><p id="53e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">考虑到这一点，我将注意力转向了CLI，并实现了所有当前仍未实现的功能。至此，我还有最后一项任务来完成概念验证…</p><h1 id="5962" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">生成测试</h1><p id="42b0" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">第一次测试我想把目标定得很低。但是它必须模拟一个要求这是一个“好的”有效测试的呼吁。这将是我今天的重点。</p><p id="d438" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我能让这个工作，我的下一个优先事项将是让这个运行在Spring Boot宠物诊所演示。我认为过滤spring代理会有一些挑战。可能还有其他问题。但如果我能在本周完成这两项任务，我会认为这是一个巨大的成功。</p><p id="36a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我正在设置第一个Freemarker生成的测试模板，一旦成功，我计划用Spring MVC来创建一个简单的代码生成器。那么它应该绑定到CLI。应该是比较简单的，著名的遗言…</p><h1 id="0b7f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">明天</h1><p id="b07c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我希望明天我们将有适当的源代码生成与Freemarker一起工作。我正在整合它，然后我会检查代码来生成测试。那么它应该绑定到CLI。越来越近了！</p><p id="805c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想了解这个系列和我从事的许多其他事情的最新进展，那么<a class="ae jo" href="https://twitter.com/debugagent" rel="noopener ugc nofollow" target="_blank">在twitter上关注我</a>。</p></div></div>    
</body>
</html>