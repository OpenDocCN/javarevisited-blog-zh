<html>
<head>
<title>Read/Write in different DB Instances | Java | Spring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在不同的数据库实例中读/写| Java | Spring</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/read-write-in-different-db-instances-java-spring-a43bf18a5c77?source=collection_archive---------1-----------------------#2022-05-19">https://medium.com/javarevisited/read-write-in-different-db-instances-java-spring-a43bf18a5c77?source=collection_archive---------1-----------------------#2022-05-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="1207" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">这篇博客将解释我如何根据需要将我的spring boot应用程序数据库调用路由到不同的DB实例</h2></div><p id="85a8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我有一个spring应用程序，它使用amazon Aurora DB集群作为数据源。</p><h2 id="c924" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><a class="ae ko" href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Overview.html" rel="noopener ugc nofollow" target="_blank">亚马逊极光数据库集群</a></h2><p id="2ba5" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">两种类型的数据库实例组成了一个Aurora数据库集群:</p><ul class=""><li id="6192" class="ku kv hi iz b ja jb jd je jg kw jk kx jo ky js kz la lb lc bi translated">主数据库实例—支持读写操作，并对群集卷执行所有数据修改。每个Aurora数据库集群都有一个主数据库实例。</li><li id="d50c" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js kz la lb lc bi translated">Aurora副本—连接到与主数据库实例相同的存储卷，并且仅支持读取操作。除了主数据库实例之外，每个Aurora数据库集群最多可以有15个Aurora副本。通过将Aurora副本放在单独的可用性区域来保持高可用性。如果主数据库实例变得不可用，Aurora会自动故障转移到Aurora副本。您可以指定Aurora副本的故障转移优先级。Aurora副本还可以从主数据库实例中卸载读取工作负载。</li></ul><p id="6836" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了利用Aurora的优势，我们必须将应用程序数据库调用路由到相关的实例。</p><p id="507a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用<a class="ae ko" rel="noopener" href="/javarevisited/top-10-free-courses-to-learn-spring-framework-for-java-developers-639db9348d25"> Spring </a>，我们可以将读取查询配置到一个数据库实例中，将其他查询配置到主实例中。</p><h2 id="69c3" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">Spring DB配置</h2><figure class="li lj lk ll fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="afd9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里，我们创建了两个数据源</p><ol class=""><li id="7150" class="ku kv hi iz b ja jb jd je jg kw jk kx jo ky js lp la lb lc bi translated">具有<strong class="iz hj"> db.master </strong>属性的读写配置bean</li><li id="8c6d" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js lp la lb lc bi translated">具有<strong class="iz hj"> db.slave </strong>属性的readonly配置</li></ol><p id="3dc4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们创建了两个<a class="ae ko" href="https://javarevisited.blogspot.com/2012/06/jdbc-database-connection-pool-in-spring.html" rel="noopener ugc nofollow" target="_blank">数据源</a>，但是，如何配置这些数据源来路由数据库连接呢？</p><p id="8c7c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我们将使用Spring事务设置。默认情况下，Spring事务是读写的，但是您可以通过<a class="ae ko" href="https://javarevisited.blogspot.com/2021/08/spring-transactional-example-how-to.html" rel="noopener ugc nofollow" target="_blank">@ Transactional annotation</a>的只读属性显式地将它们配置为在只读上下文中执行。</p><p id="1f22" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将创建一个管理事务生命周期的定制事务管理器。当创建一个新事务时，我们的<code class="du lq lr ls lt b">ReplicaAwareTransactionManager </code>是一个定制事务管理器。</p><h2 id="4979" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">ReplicaAwareTransactionManager</h2><figure class="li lj lk ll fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="ae70" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你看一下我们的<code class="du lq lr ls lt b">ReplicaAwareTransactionManager </code>实现，你可以清楚地说，它充当了spring事务管理器的代理。所有的工作都由spring事务管理器来完成。这里，我们所做的只是在调用get transaction方法时，根据事务定义在<code class="du lq lr ls lt b">TransactionRoutingSource</code>中设置一个参数。</p><pre class="li lj lk ll fd lu lt lv lw aw lx bi"><span id="7cfe" class="jt ju hi lt b fi ly lz l ma mb">public TransactionStatus getTransaction(TransactionDefinition definition) throws TransactionException {  <br/>          TransactionRoutingDataSource.setReadonlyDataSource(definition != null &amp;&amp; definition.isReadOnly()); </span><span id="6bbf" class="jt ju hi lt b fi mc lz l ma mb">return wrapped.getTransaction(definition);  </span><span id="2f3b" class="jt ju hi lt b fi mc lz l ma mb">}</span></pre><p id="a926" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，当在TrasactionManager上调用getTransaction时，我们告诉TransactionRoutingSource将其readOnly标志设置为true。让我们深入研究一下TransactionRoutingSource。为什么我们要这样设置…</p><h2 id="c99e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">TransactionRoutingSource</h2><figure class="li lj lk ll fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="67f1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">由于事务是由<a class="ae ko" href="https://javarevisited.blogspot.com/2020/04/difference-between-atomic-volatile-and-synchronized-in-java-multi-threading.html" rel="noopener ugc nofollow" target="_blank">线程</a>创建的，我们将基于线程保存数据源信息。这个TransactionRoutingSource在一个称为数据源的hashmap中包含主数据源和从数据源。</p><p id="f07e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">基于查找键将getConnection()调用路由到各种目标数据源之一的DataSource实现。后者通常(但不是必须)通过一些线程绑定的事务上下文来确定。当应用程序需要获得连接时，它将调用transactionRoutingSource中的查找键。TransactionRoutingSource current data source将由由TransactionManager控制的标志设置。currentDatasource将用于获取连接。</p><p id="4fa9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的主数据源是TransactionRoutingSource，它由主数据源和从数据源组成。</p><p id="9d16" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">TransactionRoutingSource将根据readOnly标志切换主数据源和从数据源。因此，当应用程序需要获取数据库连接时，它看起来就像currentLookUpKey。TransactionManager将根据事务定义更改此readOnlyFlag。因为默认的事务类型是readAndWrite，所以所有的<a class="ae ko" href="https://javarevisited.blogspot.com/2016/02/how-to-connect-to-microsoft-sql-server-from-Eclipse.html" rel="noopener ugc nofollow" target="_blank"> DB连接调用</a>都将转到主数据库。如果我们想指向从数据库，我们必须在@ TrasactionAnnotation中添加readOnly=true，如下所示。</p><pre class="li lj lk ll fd lu lt lv lw aw lx bi"><span id="6d56" class="jt ju hi lt b fi ly lz l ma mb">@Transaction(readOnly=true)</span></pre><p id="7119" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们用下图包装一下</p><figure class="li lj lk ll fd lm er es paragraph-image"><a href="https://www.java67.com/2013/02/how-to-connect-mysql-database-from-java.html"><div class="er es md"><img src="../Images/733cfe08e2017972b36100454debc204.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H5FALYO-ygs4gwzCDprJXg.jpeg"/></div></a></figure><p id="8b10" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当用户发起交易时。它有一个事务定义。</p><ol class=""><li id="2a0d" class="ku kv hi iz b ja jb jd je jg kw jk kx jo ky js lp la lb lc bi translated">该事务将通过getTrasaction调用启动。</li><li id="1d93" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js lp la lb lc bi translated">当调用此getTrasaction方法时，ReplicaAwareTransactionManager将设置调用TrasactionRoutingSource set readonly方法。这将基于事务定义只读标志而改变。</li><li id="ce20" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js lp la lb lc bi translated">当根据调用标志调用setReadOnly方法时，currentDatasource将被更改。<br/>真→将选择从属数据源<br/>假→将选择主数据源</li><li id="d388" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js lp la lb lc bi translated">现在将处理交易。为了获得数据库连接，应用程序将在数据源上查找currentLookupkey。</li><li id="0dec" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js lp la lb lc bi translated">对我们来说，我们的数据源是TransactionRoutingSource。</li><li id="8356" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js lp la lb lc bi translated">我们的数据源将为数据库连接提供相关的数据源。</li><li id="a1b5" class="ku kv hi iz b ja ld jd le jg lf jk lg jo lh js lp la lb lc bi translated">应用程序将使用我们的数据源提供的配置连接到数据库。</li></ol><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/javarevisited/21-spring-mvc-rest-interview-questions-answers-for-beginners-and-experienced-developers-21ad3d4c9b82"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">10大春季MVC + REST面试问题解答适合初学者和有经验的开发者</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">大家好。如果你正在准备Java和Spring面试或Spring认证，并经常寻找一些…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx me mj"/></div></div></a></div><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/javarevisited/top-10-free-courses-to-learn-spring-framework-for-java-developers-639db9348d25"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">2022年Java开发者学习Spring框架的10大免费课程</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">大家好，我最近分享了很多资源，如书籍和课程，当我公布了我的最佳…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="my l mu mv mw ms mx me mj"/></div></div></a></div><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/javarevisited/13-topics-you-should-prepare-for-your-next-spring-boot-interview-5f2993a04ff5"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">你应该为2022年的下一次Spring Boot面试准备的13个话题</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">你应该为下一次Java和Spring Boot面试准备的13个基本主题的列表和学习资源…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="mz l mu mv mw ms mx me mj"/></div></div></a></div></div></div>    
</body>
</html>