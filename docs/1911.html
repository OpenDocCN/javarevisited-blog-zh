<html>
<head>
<title>Kafka Customer → Get Specific Messages Only</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kafka客户→仅获取特定消息</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/kafka-customer-get-what-needs-only-45d95f9b1105?source=collection_archive---------0-----------------------#2022-01-29">https://medium.com/javarevisited/kafka-customer-get-what-needs-only-45d95f9b1105?source=collection_archive---------0-----------------------#2022-01-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if"><p id="6156" class="ig ih hi bd ii ij ik il im in io ip dx translated">这不是传统的spring Kafka消费者设置，在那里消费者积极地倾听特定的话题。Kafka客户可以从主题的指定偏移量检索消息。</p></blockquote><figure class="ir is it iu iv iw er es paragraph-image"><a href="https://javarevisited.blogspot.com/2018/04/top-5-apache-kafka-course-to-learn.html"><div class="er es iq"><img src="../Images/cabc600f1d769c5428d5b1a2190b2f29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOtgNpMKONHDChVYUATVzg.jpeg"/></div></a><p class="iz ja et er es jb jc bd b be z dx translated"><a class="ae jd" href="https://www.google.com/search?q=customer+in+shop&amp;sxsrf=APq-WBsg_E6hXNCFG260TkZk23CGEVWE7Q:1643427593917&amp;source=lnms&amp;tbm=isch&amp;sa=X&amp;ved=2ahUKEwix4svvhNb1AhVoSWwGHVDjAekQ_AUoAXoECAEQAw&amp;biw=1920&amp;bih=981&amp;dpr=1#imgrc=xD3SnYX7-8NpmM" rel="noopener ugc nofollow" target="_blank">https://www.google.com/search?q=customer+in+shop&amp;sxsrf = APq-WBsg _ e 6 hxncfg 260 tkzk 23 cgevwe 7 q:1643427593917&amp;source = lnms&amp;TBM = isch&amp;sa = X&amp;ved = 2 ahukewix4 svvhnb 1 ahvooswwghvdjaekq _ AUoAXoECAEQAw&amp;biw = 1920&amp;BIH = 981【T3</a></p></figure><h2 id="f55c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">为什么我们需要</h2><p id="848d" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ip hb bi translated">春天的卡夫卡有一个主动听话题的模式(<strong class="ke hj">卡夫卡听众</strong>)。这是我们大多数时候需要的。有些时候，我们不需要主动去听话题。</p><ul class=""><li id="edca" class="kw kx hi ke b kf ky kj kz jp la jt lb jx lc ip ld le lf lg bi translated">为了测试我们发给<a class="ae jd" rel="noopener" href="/javarevisited/top-10-apache-kafka-online-training-courses-and-certifications-621f3c13b38c">卡夫卡</a>的信息是否正确。</li><li id="7617" class="kw kx hi ke b kf lh kj li jp lj jt lk jx ll ip ld le lf lg bi translated">重试丢失的Kafka偏移消息。</li></ul><p id="1e77" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">所以在上面两种情况下，我们需要得到指定偏移量的消息。</p><h2 id="141f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">现有方法</h2><p id="c8f6" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ip hb bi translated">这可以通过<strong class="ke hj"> Kafka控制台消费者</strong>(https://Kafka-tutorials . confluent . io/Kafka-console-consumer-read-specific-offsets-partitions/confluent . html)实现。但是在spring Kafka中没有简便的方法，实际上也不难编码。</p><h2 id="6ce3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">春天的卡夫卡路</h2><p id="cdc1" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ip hb bi translated">我们必须用我们的实现来处理这个问题</p><p id="9885" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated"><strong class="ke hj"> <em class="lp">剧透预警</em> </strong></p><blockquote class="if"><p id="3de2" class="ig ih hi bd ii ij lq lr ls lt lu ip dx translated"><strong class="ak"> <em class="lv">我们没有做任何花哨的工作，我们只是利用春天的卡夫卡消费来获得特定的信息</em> </strong></p></blockquote><p id="c89f" class="pw-post-body-paragraph kc kd hi ke b kf lw kh ki kj lx kl km jp ly ko kp jt lz kr ks jx ma ku kv ip hb bi translated">我们使用现有的<code class="du mb mc md me b">SpringKafkaConsumerFactory</code>，并且我们还用Spring <code class="du mb mc md me b">AbstractConsumerSeekAware </code>抽象类扩展了我们的KafkaCustomer。我们使用Spring <code class="du mb mc md me b">AbstractConsumerSeekAware </code>来管理<code class="du mb mc md me b">ConsumerSeekAware</code>。侦听器的ConsumerSeekCallback s。它可以很容易地寻找任意主题/分区，而不必跟踪回调本身。</p><p id="0105" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">因为卡夫卡消费者不是线程安全的。我们为此添加了ReentrantLock。</p><h2 id="e506" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">KafkaCustomerImplementation</h2><p id="542a" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ip hb bi translated">首先，我们试着拿到锁。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="ca71" class="je jf hi me b fi mn mo l mp mq"><em class="lp">final boolean </em>isAvailable = reentrantLock.tryLock(lockTimeOut, TimeUnit.<strong class="me hj"><em class="lp">SECONDS</em></strong>);</span></pre><p id="5998" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">如果我们能够锁定，那么我们将<code class="du mb mc md me b">SpringKakfaConsumer </code>分配给一个特定的主题分区。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="9979" class="je jf hi me b fi mn mo l mp mq"><em class="lp">final Map</em>&lt;TopicPartition, Long&gt; topicOffsetMap = Collections.<em class="lp">singletonMap</em>(<em class="lp">new </em>TopicPartition(topic, partition), topicOffset);<br/>consumer.assign(topicOffsetMap.keySet());</span></pre><p id="278a" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">然后，我们在<code class="du mb mc md me b">SpringKafkaConsumer </code>需要查看主题的位置设置查找偏移量。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="2a53" class="je jf hi me b fi mn mo l mp mq">topicOffsetMap.forEach(consumer::seek);</span></pre><p id="a21a" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">我们恢复消费者投票。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="1eae" class="je jf hi me b fi mn mo l mp mq">consumer.resume(topicOffsetMap.keySet());<br/><em class="lp">final </em>ConsumerRecords&lt;K, V&gt; poll = consumer.poll(Duration.<em class="lp">ofSeconds</em>(maxPollSeconds));</span></pre><p id="7945" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">一旦<code class="du mb mc md me b">SpringKafkaConsumer </code>获得记录，我们验证偏移是否正确。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="b287" class="je jf hi me b fi mn mo l mp mq"><em class="lp">for </em>(ConsumerRecord&lt;K, V&gt; kvConsumerRecord : poll) {<br/>    <em class="lp">if </em>(kvConsumerRecord.offset() == topicOffset) {<br/>        consumerRecord = kvConsumerRecord;<br/>    }<br/>}</span></pre><p id="76f9" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">之后，我们以同步的方式提交消费者。我们暂停主题分区的消费者。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="b8d2" class="je jf hi me b fi mn mo l mp mq">consumer.commitSync();<br/>consumer.pause(topicOffsetMap.keySet());</span></pre><p id="27a4" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">一旦发生这种情况，我们释放锁。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="9922" class="je jf hi me b fi mn mo l mp mq">reentrantLock.unlock();</span></pre><p id="84f3" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">因此，我们将在KafkaCustomer的帮助下接收指定的抵销消费者记录。</p><h2 id="47a4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">关于代码的信息</h2><p id="49ac" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ip hb bi translated"><strong class="ke hj">Github<br/>T3【https://github.com/rcvaram/KafkaCustomer】T4</strong></p><p id="10b5" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated"><strong class="ke hj"> Maven知识库| </strong></p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="88ad" class="je jf hi me b fi mn mo l mp mq">&lt;dependency&gt;</span><span id="bb98" class="je jf hi me b fi mr mo l mp mq">&lt;groupId&gt;io.github.rcvaram&lt;/groupId&gt;</span><span id="ee8f" class="je jf hi me b fi mr mo l mp mq">&lt;artifactId&gt;KafkaCustomer&lt;/artifactId&gt;</span><span id="5f2b" class="je jf hi me b fi mr mo l mp mq">&lt;version&gt;1.0&lt;/version&gt;</span><span id="1945" class="je jf hi me b fi mr mo l mp mq">&lt;/dependency&gt;</span></pre><h2 id="3a53" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">如何使用</h2><p id="ce1d" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ip hb bi translated">在spring Kafka maven或Gradle项目中导入依赖项。</p><p id="6b8b" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">使用您的<code class="du mb mc md me b">SpringKafkaConsumerFactory </code>创建一个KafkaCustomer，如下所示。为了简单起见，我使用字符串类作为键和值类，你可以使用你的Kafka类。</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="eefb" class="je jf hi me b fi mn mo l mp mq">ConsumerFactory&lt;String, String&gt; consumerFactory;            <br/>KafkaCustomer&lt;String, String&gt; kafkaCustomer = new KafkaCustomer&lt;&gt;(consumerFactory, 1000, 5);</span></pre><p id="d69a" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">创建主题分区和偏移映射器</p><pre class="mf mg mh mi fd mj me mk ml aw mm bi"><span id="13bf" class="je jf hi me b fi mn mo l mp mq">TopicPartition topicPartitionZero = new TopicPartition("test",1);<br/> TopicPartition topicPartitionOne = new TopicPartition("test",0);<br/> Map&lt;TopicPartition, Long&gt; map= new HashMap();<br/> map.put(topicPartitionZero, 5);<br/> map.put(topicPartitionOne, 6);<br/> Map&lt;TopicPartition, ConsumerRecord&lt;String, String&gt;&gt; OffsetValueMapper = kafkaCustomer.get(map);</span></pre><p id="7173" class="pw-post-body-paragraph kc kd hi ke b kf ky kh ki kj kz kl km jp lm ko kp jt ln kr ks jx lo ku kv ip hb bi translated">现在，您可以使用offsetValueMapper来获取值。</p><h2 id="76ab" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">参考</h2><div class="ms mt ez fb mu mv"><a href="https://kafka-tutorials.confluent.io/kafka-console-consumer-read-specific-offsets-partitions/confluent.html" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="bd hj fi z dy na ea eb nb ed ef hh bi translated">如何使用Kafka控制台消费程序读取特定的偏移量和分区</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">供应Kafka集群本教程需要访问Apache Kafka集群，并且获得…</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">卡夫卡-tutorials.confluent.io</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj ix mv"/></div></div></a></div><div class="ms mt ez fb mu mv"><a href="https://docs.spring.io/spring-kafka/reference/html/#seek" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="bd hj fi z dy na ea eb nb ed ef hh bi translated">阿帕奇卡夫卡的春天</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">公共接口message listener {(1)void on message(consumer record data)；}公共接口…</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">docs.spring.io</p></div></div></div></a></div><div class="ms mt ez fb mu mv"><a rel="noopener follow" target="_blank" href="/javarevisited/top-10-apache-kafka-online-training-courses-and-certifications-621f3c13b38c"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="bd hj fi z dy na ea eb nb ed ef hh bi translated">2022年学习阿帕奇卡夫卡的十大课程</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">您可能听说过Apache Kafka，这是下一代大数据消息传递系统，可处理数十亿…</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">medium.com</p></div></div><div class="ne l"><div class="nk l ng nh ni ne nj ix mv"/></div></div></a></div></div></div>    
</body>
</html>