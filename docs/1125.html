<html>
<head>
<title>What is Java Instrumentation? Why is it needed?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是Java插装？为什么需要它？</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/what-is-java-instrumentation-why-is-it-needed-1f9aa467433?source=collection_archive---------1-----------------------#2021-04-06">https://medium.com/javarevisited/what-is-java-instrumentation-why-is-it-needed-1f9aa467433?source=collection_archive---------1-----------------------#2021-04-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8d5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码片段的简单解释</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/6554707a0159272c1f37fd1b81b65621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*MOmUS7CFhHGSRUTxlDVt_g.jpeg"/></div></figure><p id="ea23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">声明:这是一个过于简单的解释。请忽略小疏忽，谢谢。</p><p id="4292" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，什么是Java插装呢？</p><p id="9081" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能已经了解到这是一种向应用程序字节码添加额外字节码的方法。如果您想在应用程序执行时添加一些东西，而不实际接触应用程序代码，那么插装就是您想要做的。</p><p id="1b7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，它到底为什么重要，谁使用它呢？</p><p id="b3f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Java instrumentation主要由应用程序工具(如jaCoCO、Profilers)和监控工具(如Datadog、Instana等)使用。这些工具需要将它们自己附加到应用程序代码上，而不实际接触应用程序代码，因为它们没有你的应用程序代码来添加它们的功能。</p><p id="3ff2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想象一下，如果10个应用团队正在开发10个不同的<a class="ae jl" rel="noopener" href="/javarevisited/10-best-java-microservices-courses-with-spring-boot-and-spring-cloud-6d04556bdfed">微服务</a>，如果他们需要从这些微服务中提取精确的简单指标，而不需要监控工具，那么他们可以编写简单的代理来单独提取这些指标。如果变得复杂，那么使用监控工具比编写特定的代理代码更容易。</p><p id="8a4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，只有专家才能做的仪器仪表是不是很复杂？肯定没有。</p><p id="6797" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是否意味着您也应该为您的应用程序这样做？也没有。</p><p id="8d06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大多数时候，<a class="ae jl" rel="noopener" href="/javarevisited/top-10-online-courses-to-become-a-fullstack-web-developer-in-2020-d608a6b63232">应用程序开发人员</a>不需要担心插装，除非您有非常具体的企业级需求来更新应用程序代码，以便提取某些指标(或者一些其他的概要文件或任何需要的东西)。这种情况几乎从来没有过。</p><p id="1a34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是了解工具如何工作，自己开发一些工具总是很有趣的！</p><p id="fdf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们用一个简单的例子来看看它是如何工作的。在讨论细节之前，我想在这里指出，有两种方法可以实现插装。</p><ol class=""><li id="3536" class="jm jn hi ih b ii ij im in iq jo iu jp iy jq jc jr js jt ju bi translated">在JVM启动期间，当<a class="ae jl" href="https://javarevisited.blogspot.com/2012/12/how-classloader-works-in-java.html" rel="noopener ugc nofollow" target="_blank">类加载器</a>加载应用程序时，添加代理代码</li><li id="c489" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">在应用程序启动后添加代理代码</li></ol><p id="2ef4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我选择了选项1进行解释。</p><p id="0c54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于应用程序代码，让我们有一个简单的java类，它什么也不做，只打印当前时间并退出。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ka kb l"/></div></figure><p id="2b94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们对此进行编译，并将其与一个清单文件捆绑到一个jar中，我们将其命名为<em class="kc"> application.mf </em></p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="3594" class="ki kj hi ke b fi kk kl l km kn"><strong class="ke hj"><em class="kc">Main-Class</em></strong>: ApplicationBeingTransformed</span></pre><p id="4a83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要将这个简单的应用程序代码编译并捆绑到一个jar中，请执行下面的</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="6d13" class="ki kj hi ke b fi kk kl l km kn">javac ApplicationBeingTransformed.java</span><span id="22c6" class="ki kj hi ke b fi ko kl l km kn">jar cfm simpleApplication.jar application.mf ApplicationBeingTransformed.class</span></pre><p id="767c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们有一个名为simpleApplication.jar的jar。</p><p id="9071" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在将编写一个简单的代理类，在<code class="du kp kq kr ke b">ApplicationBeingTransformed </code>类中的方法退出时添加一个页脚。我将在这里使用<a class="ae jl" href="https://bytebuddy.net/#/" rel="noopener ugc nofollow" target="_blank"> ByteBuddy </a>来避免样板代码。ByteBuddy是一个出色的工具库。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ka kb l"/></div></figure><p id="9c44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码中，我所做的是</p><ol class=""><li id="cea7" class="jm jn hi ih b ii ij im in iq jo iu jp iy jq jc jr js jt ju bi translated">创建premain方法，这是jvm启动期间启动的代理的入口点</li><li id="cf07" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">创建一个简单的通知类，将SysOut语句(第31行)添加到方法代码的末尾。</li><li id="d574" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">将建议类连接到仪器类，作为第24行中的<a class="ae jl" href="https://docs.oracle.com/cd/E17802_01/j2se/j2se/1.5.0/jcp/beta1/apidiffs/java/lang/instrument/Instrumentation.html#addTransformer(java.lang.instrument.ClassFileTransformer)" rel="noopener ugc nofollow" target="_blank">变压器</a></li><li id="098c" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">当元素名称在第18行中有“ApplicationBeingTransformed”时，它将执行这种转换</li><li id="d217" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">这个建议只有当它是一个方法时才会被访问。方法也是一个名为“ApplicationBeingTransformed”的元素。</li></ol><p id="2f55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们用javac编译它，并用一个清单文件将它捆绑到jar中。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="55cd" class="ki kj hi ke b fi kk kl l km kn">javac -cp byte-buddy-1.10.22.jar;. SimpleInstru.java</span><span id="df08" class="ki kj hi ke b fi ko kl l km kn">jar cfm simpleInstrumentation.jar instru.mf SimpleInstru.class SimpleInstru\$TimeFooter.class</span></pre><p id="c319" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在有一个名为simpleInstrumentation.jar的代理jar。</p><p id="cc26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在jvm启动期间启动的代理代码中需要注意的一件重要事情是在清单文件中添加前置主类名。下面是我使用过的清单文件:</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="b80e" class="ki kj hi ke b fi kk kl l km kn"><strong class="ke hj"><em class="kc">Premain-Class</em></strong>: SimpleInstru<br/><strong class="ke hj"><em class="kc">Class-Path</em></strong>: byte-buddy-1.10.22.jar</span></pre><p id="6bd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们做了什么？</p><ol class=""><li id="c909" class="jm jn hi ih b ii ij im in iq jo iu jp iy jq jc jr js jt ju bi translated">我们已经创建了一个应用程序</li><li id="a360" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">我们已经创建了一个代理来向应用程序代码添加额外的一行代码</li></ol><p id="3138" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们现在执行并检查它看起来如何。我们有两个jar，simpleApplication.jar和simpleInstrumentation.jar</p><p id="2fe0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我没有使用过任何复杂的打包或构建工具。因此，我需要在将要执行的目录中使用byteBuddy jar(按照我声明的清单文件)。</p><p id="0ca0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与应用程序代码一起执行代理的命令。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="9cbd" class="ki kj hi ke b fi kk kl l km kn">java -javaagent:simpleInstrumentation.jar -jar simpleApplication.jar</span></pre><p id="4f5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，来自代理的额外一行代码被插入到应用程序代码中。我们可以从下面的执行中看到这一点:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ks"><img src="../Images/a099e89f106d9c369079020e6afe7f32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4S85yE-FS_OtDMBtaS8Dbg.png"/></div></div></figure><p id="981b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我在ApplicationBeingTransformed.java有另一个方法，这个页脚也会添加到那里。</p><p id="55ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，每当调用该类中的方法时，页脚消息也会打印在控制台中，因为该页脚现在是应用程序字节码的一部分。</p><p id="df47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里使用的代码可以在Github: <a class="ae jl" href="https://github.com/mrajaian/agent-static-load" rel="noopener ugc nofollow" target="_blank">作者的资源库</a>中找到</p></div></div>    
</body>
</html>