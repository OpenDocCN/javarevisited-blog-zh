<html>
<head>
<title>Spring Boot Testing — Testcontainers and Flyway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring Boot测试——测试容器和飞行路线</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/spring-boot-testing-testcontainers-and-flyway-df4a71376db4?source=collection_archive---------0-----------------------#2021-07-05">https://medium.com/javarevisited/spring-boot-testing-testcontainers-and-flyway-df4a71376db4?source=collection_archive---------0-----------------------#2021-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d41d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是Spring Boot测试文章系列的第二部分。代码片段取自这个<a class="ae jd" href="https://github.com/SimonHarmonicMinor/spring-boot-test-example" rel="noopener ugc nofollow" target="_blank">库</a>。您可以克隆它并运行测试，看看它是如何工作的。</p><h1 id="19d7" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">章</h1><ol class=""><li id="5998" class="kc kd hi ih b ii ke im kf iq kg iu kh iy ki jc kj kk kl km bi translated"><a class="ae jd" rel="noopener" href="/javarevisited/spring-boot-testing-data-and-services-bc8b4c62ee8f?source=friends_link&amp;sk=86148a772616274202776f4515c078e4"> Spring Boot测试—数据和服务</a></li><li id="c686" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated"><a class="ae jd" rel="noopener" href="/javarevisited/spring-boot-testing-testcontainers-and-flyway-df4a71376db4?source=friends_link&amp;sk=1d0ffcd36bb4265c2d0120520bc8a567"> Spring Boot测试—测试容器和飞行路线</a></li></ol><p id="0fd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们已经了解了如何使用H2数据库测试服务层(T7)和存储库层(T9)。这种测试有一些好处。例如，它们非常快，不需要在本地机器或CI/CD环境中进行复杂的配置。然而，H2不是通常在生产中运行的数据库。如果我们使用一个数据库的一些供应商特定的功能，H2可能不会帮助我们。因此，今天我们将讨论如何在真正的数据库服务器上运行测试用例。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es ks"><img src="../Images/d2b69c7e9c7fcb21031c78b39ba26ade.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*tUAPHM3wxIaqCFtj3VntTQ.jpeg"/></div></figure><h1 id="3a0c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">自动模式创建</h1><p id="d410" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">我们如何用真实的数据库运行测试？嗯，我们可以在本地创建一个新实例，并通过编辑<code class="du ld le lf lg b">src/test/resources/application.yml</code>来配置测试环境。它确实可以工作，但是它使得构建很难复制。每个从事该项目的开发人员都必须确保他们有两个独立的数据库。一个用于开发，另一个用于测试运行。此外，这使得在<a class="ae jd" rel="noopener" href="/javarevisited/7-best-courses-to-learn-jenkins-and-ci-cd-for-devops-engineers-and-software-developers-df2de8fe38f3?source=---------15------------------"> CI/CD </a>环境中执行构建成为一个真正的挑战。</p><p id="e12f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，<a class="ae jd" href="https://www.testcontainers.org/" rel="noopener ugc nofollow" target="_blank"> Testcontainers </a>来拯救我们了！它是一个Java库，在<a class="ae jd" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>容器中启动服务，运行测试，并最终销毁容器。您不需要担心任何事情，框架会完成工作。只要确保你已经安装了Docker，然后你就可以开始了。该库支持数十种不同的数据库和模块(<a class="ae jd" href="https://www.testcontainers.org/modules/databases/postgres/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>、<a class="ae jd" href="https://www.testcontainers.org/modules/databases/mysql/" rel="noopener ugc nofollow" target="_blank"> MySQL </a>、<a class="ae jd" href="https://www.testcontainers.org/modules/databases/mongodb/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>、<a class="ae jd" href="https://www.testcontainers.org/modules/kafka/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>、<a class="ae jd" href="https://www.testcontainers.org/modules/elasticsearch/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>、<a class="ae jd" href="https://www.testcontainers.org/modules/nginx/" rel="noopener ugc nofollow" target="_blank"> Nginx </a>、<a class="ae jd" href="https://www.testcontainers.org/modules/toxiproxy/" rel="noopener ugc nofollow" target="_blank"> Toxiproxy </a>以及许多其他数据库和模块)。即使你没有找到你需要的，你也可以使用<a class="ae jd" href="https://www.testcontainers.org/features/creating_container/" rel="noopener ugc nofollow" target="_blank">通用容器创建</a>。</p><p id="3b72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一步是添加所需的依赖项。</p><pre class="kt ku kv kw fd lh lg li lj aw lk bi"><span id="21f0" class="ll jf hi lg b fi lm ln l lo lp">testImplementation 'org.testcontainers:junit-jupiter'<br/>testImplementation 'org.testcontainers:postgresql'<br/>runtimeOnly 'org.postgresql:postgresql'</span></pre><p id="3b54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们需要在<code class="du ld le lf lg b">src/test/resources</code>中创建一个单独的配置文件。<a class="ae jd" rel="noopener" href="/javarevisited/top-10-courses-to-learn-spring-boot-in-2020-best-of-lot-6ffce88a1b6e?source=---------39------------------"> Spring Boot </a>能够通过<a class="ae jd" href="https://www.baeldung.com/spring-profiles" rel="noopener ugc nofollow" target="_blank">配置文件</a>区分不同的配置文件。配置文件名应该像<code class="du ld le lf lg b">application-PROFILE_NAME.yml</code>一样作为后缀。例如，名为<code class="du ld le lf lg b">application-test-containers.yml</code>的文件仅在<code class="du ld le lf lg b">test-containers</code>轮廓激活时应用。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">应用程序测试容器</p></figure><p id="a2b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你注意到JDBC连接字符串中的后缀<code class="du ld le lf lg b">tc</code>了吗？这就是伴随着<a class="ae jd" rel="noopener" href="/javarevisited/5-courses-to-learn-junit-and-mockito-in-2019-best-of-lot-f217d8b93688"> JUnit 5 </a>和测试容器结合而来的魔力。事情是你根本不需要任何程序化的配置！当<a class="ae jd" rel="noopener" href="/javarevisited/5-essential-frameworks-every-java-developer-should-learn-6ed83315f1fb">框架</a>发现<code class="du ld le lf lg b">url</code>包含<code class="du ld le lf lg b">tc</code>后缀时，它会在内部运行所有必要的Docker命令。你可以在这里找到更多的例子<a class="ae jd" href="https://www.testcontainers.org/modules/databases/jdbc/" rel="noopener ugc nofollow" target="_blank">。</a></p><blockquote class="lw lx ly"><p id="cfd6" class="if ig lz ih b ii ij ik il im in io ip ma ir is it mb iv iw ix mc iz ja jb jc hb bi translated">我们设置了<code class="du ld le lf lg b">spring.jpa.hibernate.ddl-auto=create</code>属性，这样数据库模式将根据实体类的定义自动创建。下一节将描述Flyway集成。</p></blockquote><p id="6d8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们再来看看<code class="du ld le lf lg b">PersonCreateService.createFamily</code>法及其H2检验。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">PersonCreateService:createfamly</p></figure><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">personcreateserviceimplspringboottest</p></figure><p id="e604" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们如何用test containers<a class="ae jd" rel="noopener" href="/javarevisited/7-best-free-postgresql-courses-for-beginners-to-learn-in-2021-3bf369d73794">PostgreSQL</a>实例运行测试？我们要做的就是添加两个注释。<code class="du ld le lf lg b">@AutoConfigureTestDatabase</code>虽然应该去掉。</p><ol class=""><li id="46f9" class="kc kd hi ih b ii ij im in iq md iu me iy mf jc kj kk kl km bi translated"><code class="du ld le lf lg b">@ActiveProfiles("test-containers")</code> —激活<code class="du ld le lf lg b">test-containers</code>配置文件，这样Spring可以读取之前描述的配置文件</li><li id="867c" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated"><code class="du ld le lf lg b">@Testcontainers</code> —告诉自动运行<a class="ae jd" rel="noopener" href="/javarevisited/10-free-courses-to-learn-docker-and-devops-for-frontend-developers-691ac7652cee?source=---------94------------------"> Docker </a> <a class="ae jd" href="https://www.testcontainers.org/modules/databases/jdbc/" rel="noopener ugc nofollow" target="_blank">中的PostgreSQL实例</a></li></ol><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">PersonCreateServiceImplTestContainers</p></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es mg"><img src="../Images/1d684d555b91c5a9574aa545c2767a6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bdks4oprHp5ftxGNHN3bpA.png"/></div></div><p class="ls lt et er es lu lv bd b be z dx translated">测试运行结果</p></figure><p id="7039" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看到了吗？小菜一碟！</p><h1 id="9c5e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">知识库测试</h1><p id="d27c" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">测试存储库层怎么样？让我们再看看H2的例子。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">PersonRepositoryDataJpaTest</p></figure><p id="eb0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">规则是一样的，但有一点点不同。<code class="du ld le lf lg b"><a class="ae jd" href="https://javarevisited.blogspot.com/2021/02/-spring-boot-testing-interview-questions-answers-java.html" rel="noopener ugc nofollow" target="_blank">@DataJpaTest</a></code>是用<code class="du ld le lf lg b">@AutoConfigureTestDatabase</code>本身标注的。默认情况下，该注释用H2实例替换任何数据源。因此，我们需要通过添加<code class="du ld le lf lg b">replace=Replace.NONE</code>属性来覆盖这种行为。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">PersonRepositoryTestContainers</p></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ml"><img src="../Images/16d82a1a8732af2466228777977f1efb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nzrTlRsN3Yi2e7LK7ZK9ow.png"/></div></div><p class="ls lt et er es lu lv bd b be z dx translated">试验结果</p></figure><p id="a57b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切仍然正常。</p><h1 id="a22b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">飞行路线整合</h1><p id="f0ee" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated"><a class="ae jd" href="https://martinfowler.com/articles/evodb.html" rel="noopener ugc nofollow" target="_blank">进化数据库设计</a>原理很久以前就已经描述过了。如今，使用实现这种模式的工具已经成为标准惯例。Flyway 和<a class="ae jd" href="https://www.liquibase.org/" rel="noopener ugc nofollow" target="_blank"> Liquibase </a>是Java世界中最流行的。我们将把Testcontainers与Flyway集成在一起。</p><p id="7897" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，需要飞行路径依赖。</p><pre class="kt ku kv kw fd lh lg li lj aw lk bi"><span id="1a42" class="ll jf hi lg b fi lm ln l lo lp">implementation "org.flywaydb:flyway-core"</span></pre><p id="acb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其次，需要禁用<code class="du ld le lf lg b">application-test-containers.yml</code>中的Flyway，因为会有一个单独的配置文件。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">禁用flyway的application-test-containers . yml</p></figure><p id="9849" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们要创建<code class="du ld le lf lg b">application-test-containers-flyway.yml</code>。该库提供了许多自动配置。所以，实际上，我们什么都不需要调。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">应用程序-测试-容器-飞行路线. yml</p></figure><p id="1691" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在是时候添加SQL迁移了。默认目录是<code class="du ld le lf lg b">resources/db/migration</code>。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">V1 _ _创建_个人_表格. sql</p></figure><p id="165f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们需要用<code class="du ld le lf lg b">test-containers-flyway</code>配置文件替换<code class="du ld le lf lg b">test-containers</code>配置文件。</p><figure class="kt ku kv kw fd kx"><div class="bz dy l di"><div class="lq lr l"/></div><p class="ls lt et er es lu lv bd b be z dx translated">PersonCreateServiceImplTestContainersFlyway</p></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es mm"><img src="../Images/a114e38d41d1099fb4f2cb5380214da9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x1JtMv_INCuLaQdxLcDQhg.png"/></div></div><p class="ls lt et er es lu lv bd b be z dx translated">Flyway模式创建的测试结果</p></figure><h1 id="01f2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">CI/CD测试正在运行</h1><p id="e706" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">尽管Testcontainers的目的是使测试易于运行，但在CI/CD环境构建中有一些注意事项。一些供应商透明地集成了Testcontainers。例如，<a class="ae jd" href="https://travis-ci.com/" rel="noopener ugc nofollow" target="_blank"> Travis-CI </a>发现了自动运行容器的需求，并在内部完成了这项工作。但是其他一些工具可能需要额外的配置，例如<a class="ae jd" rel="noopener" href="/javarevisited/top-10-free-courses-to-learn-jenkins-docker-and-kubernetes-for-devops-in-2020-best-of-lot-62a0541ffeb3?source=---------30----------------------------"> Jenkins </a>。</p><h2 id="d2b3" class="ll jf hi bd jg mn mo mp jk mq mr ms jo iq mt mu js iu mv mw jw iy mx my ka mz bi translated">Docker虫洞</h2><p id="bddb" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在CI运行期间，将整个应用程序构建打包到Docker映像中是一种常见的方法。Testcontainers可以处理它，并在主机Docker服务器上运行定义的容器。在这种情况下，我们需要将<code class="du ld le lf lg b">/var/run/docker.sock</code>绑定为一个卷。不仅如此，容器中的目录应该与容器启动时的目录相同。</p><p id="c76e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，这是一个使用<code class="du ld le lf lg b"><a class="ae jd" rel="noopener" href="/javarevisited/5-best-gradle-courses-and-books-to-learn-in-2021-93f49ce8ff8e">gradle</a></code>在CI环境中运行测试的假设命令。</p><pre class="kt ku kv kw fd lh lg li lj aw lk bi"><span id="bccf" class="ll jf hi lg b fi lm ln l lo lp">docker run -it   \<br/>           --rm  \<br/>           -v $PWD:$PWD \<br/>           -w $PWD  \<br/>           -v /var/run/docker.sock:/var/run/docker.sock gradle:7.1-jdk8 \<br/>           gradle test</span></pre><p id="8909" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在官方Testcontainers指南页面上找到更多信息。</p><h1 id="d290" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="e3a3" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">今天我们讨论了如何用Testcontainers和Flyway测试数据和服务层。下次我们将测试API(控制器)级别。如果您有任何问题或建议，请在下面留下您的评论。感谢阅读！</p></div></div>    
</body>
</html>