<html>
<head>
<title>The most easiest Spring Cloud tutorial ever| Chapter 4: Circuit Breaker (Hystrix) (Finchley Version)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有史以来最简单的春云教程|第四章:断路器(Hystrix)(芬奇利版)</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/the-most-easiest-springcloud-tutorial-ever-chapter-4-circuit-breaker-hystrix-finchley-version-680c3117fb9e?source=collection_archive---------0-----------------------#2022-05-02">https://medium.com/javarevisited/the-most-easiest-springcloud-tutorial-ever-chapter-4-circuit-breaker-hystrix-finchley-version-680c3117fb9e?source=collection_archive---------0-----------------------#2022-05-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2b957bc0aa6d91065cd7cd43328c2965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJG2xKdzdNbT-17DFVEraw.jpeg"/></div></div></figure><p id="ea83" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi jo translated"><span class="l jp jq jr bm js jt ju jv jw di">在</span>微服务架构中，按照业务逐一划分服务，服务之间可以互相调用(RPC)。在<a class="ae jx" rel="noopener" href="/javarevisited/5-best-courses-to-learn-spring-cloud-and-microservices-1ddea1af7012">春云</a>中，可以使用RestTemplate+Ribbon和Feign进行调用。为了保证其高可用性，通常在集群中部署单个服务。</p><p id="c5dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于网络原因或自身原因，无法保证服务100%可用。如果单个服务有问题，调用这个服务时会发生线程阻塞。此时，如果大量请求涌入，servlet容器的线程资源就会被消耗。，导致服务瘫痪。</p><p id="1194" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务之间的依赖性，故障会向整个微服务系统传播并造成灾难性的严重后果，这就是服务故障的“雪崩”效应。</p><p id="c03c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了解决这个问题，业界提出了断路器模型。</p><ol class=""><li id="d3b3" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn kd ke kf kg bi translated"><strong class="is hj">断路器简介</strong></li></ol><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="8453" class="kq kr hi km b fi ks kt l ku kv">Netflix has created a library called Hystrix that implements the circuit breaker pattern. In a microservice architecture it is common to have multiple layers of service calls.</span></pre><p id="f1f8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">网飞开源了Hystrix组件来实现断路器模式，而<a class="ae jx" rel="noopener" href="/hackernoon/top-5-spring-boot-and-spring-cloud-books-for-java-developers-75df155dcedc"> Spring Cloud </a>集成了这个组件。在微服务架构中，一个请求调用多个服务是很常见的，如下图所示:</p><figure class="kh ki kj kk fd ij er es paragraph-image"><a href="https://javarevisited.blogspot.com/2018/04/top-5-spring-cloud-courses-for-java.html"><div class="er es kw"><img src="../Images/a563874e2cd13ca48b9143deffa60627.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*CTYlPzRGSh4efMyM"/></div></a></figure><p id="e3c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果较低级别的服务出现故障，可能会导致级联故障。当对特定服务的呼叫的不可用性达到阈值(Hystric是5秒内20次)时，断路器将被打开。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><a href="https://javarevisited.blogspot.com/2018/02/top-5-spring-microservices-courses-with-spring-boot-and-spring-cloud.html"><div class="er es kw"><img src="../Images/2fd5007b23b58bbd478c3adaa5eb0f96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*qxOHO8ooseBEhF9L"/></div></a></figure><p id="863d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">断路器分闸后可以避免连锁故障，回退法可以直接返回定值。</p><p id="3d10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 2。准备工作</strong></p><p id="872e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文基于上一篇文章的项目，先启动上一篇文章的项目，启动eureka-server项目；启动service-hi项目，它的端口是8762。</p><p id="b97f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 3。使用色带中的断路器</strong></p><p id="1bb0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要转换serice-ribbon项目的代码，首先将spring-cloud-starter-网飞-hystrix的起始依赖项添加到pox.xml文件中:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f28c" class="kq kr hi km b fi ks kt l ku kv">&lt;dependency&gt;<br/>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;<br/>  &lt;/dependency&gt;</span></pre><p id="03d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将<a class="ae jx" href="https://www.java67.com/2018/12/top-5-spring-cloud-annotations-for-java.html" rel="noopener ugc nofollow" target="_blank"> @EnableHystrix注释</a>添加到程序的启动类ServiceRibbonApplication中，以启用Hystrix:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c76d" class="kq kr hi km b fi ks kt l ku kv"><a class="ae jx" href="http://twitter.com/SpringBootApplicatio" rel="noopener ugc nofollow" target="_blank">@SpringBootApplicatio</a>n<br/><a class="ae jx" href="http://twitter.com/EnableEurekaClient" rel="noopener ugc nofollow" target="_blank">@EnableEurekaClient</a><br/><a class="ae jx" href="http://twitter.com/EnableDiscoveryClien" rel="noopener ugc nofollow" target="_blank">@EnableDiscoveryClien</a>t<br/><a class="ae jx" href="http://twitter.com/EnableHystrix" rel="noopener ugc nofollow" target="_blank">@EnableHystrix</a><br/>public class ServiceRibbonApplication {</span><span id="bcbc" class="kq kr hi km b fi kx kt l ku kv">public static void main(String[] args) {<br/>        SpringApplication.run( ServiceRibbonApplication.class, args );<br/>    }</span><span id="a5e6" class="kq kr hi km b fi kx kt l ku kv"><a class="ae jx" href="http://twitter.com/Bean" rel="noopener ugc nofollow" target="_blank">@Bean</a><br/>    <a class="ae jx" href="http://twitter.com/LoadBalanced" rel="noopener ugc nofollow" target="_blank">@LoadBalanced</a><br/>    RestTemplate restTemplate() {<br/>        return new RestTemplate();<br/>    }</span><span id="e497" class="kq kr hi km b fi kx kt l ku kv">}</span></pre><p id="7677" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">修改HelloService类，将<a class="ae jx" href="http://twitter.com/HystrixCommand" rel="noopener ugc nofollow" target="_blank"> @HystrixCommand </a>批注添加到hiService方法中。此注释为此方法创建了断路器的功能，并指定了fallbackMethod断路器方法。断路器方法直接返回一个字符串，字符串是“hi，”+name+“，对不起，错误！”，代码如下:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="101a" class="kq kr hi km b fi ks kt l ku kv"><a class="ae jx" href="http://twitter.com/Service" rel="noopener ugc nofollow" target="_blank">@Service</a><br/>public class HelloService {</span><span id="d586" class="kq kr hi km b fi kx kt l ku kv"><a class="ae jx" href="http://twitter.com/Autowired" rel="noopener ugc nofollow" target="_blank">@Autowired</a><br/>    RestTemplate restTemplate;</span><span id="9a9e" class="kq kr hi km b fi kx kt l ku kv"><a class="ae jx" href="http://twitter.com/HystrixCommand" rel="noopener ugc nofollow" target="_blank">@HystrixCommand</a>(fallbackMethod = "hiError")<br/>    public String hiService(String name) {<br/>        return restTemplate.getForObject("<a class="ae jx" href="http://SERVICE-HI/hi?name=" rel="noopener ugc nofollow" target="_blank">http://SERVICE-HI/hi?name=</a>"+name,String.class);<br/>    }</span><span id="2908" class="kq kr hi km b fi kx kt l ku kv">public String hiError(String name) {<br/>        return "hi,"+name+",sorry,error!";<br/>    }</span><span id="94cf" class="kq kr hi km b fi kx kt l ku kv">}</span></pre><p id="05ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">开始:服务丝带项目，当我们访问<a class="ae jx" href="http://localhost:8764/hi?name=forezp" rel="noopener ugc nofollow" target="_blank"> http://localhost:8764/hi？name=forezp </a>，浏览器显示:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7765" class="kq kr hi km b fi ks kt l ku kv"><em class="ky">hi forezp,i am from port:8762</em></span></pre><p id="854c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，关闭service-hi项目。当我们访问<a class="ae jx" href="http://localhost:8764/hi?name=forezp" rel="noopener ugc nofollow" target="_blank"> http://localhost:8764/hi？同样，浏览器将显示:</a></p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="831b" class="kq kr hi km b fi ks kt l ku kv">hi ,forezp,orry,error!</span></pre><p id="6322" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这意味着当service-hi项目不可用时，service-ribbon调用service-hi API时，会快速失败，直接返回一组字符串，而不是等待响应超时，很好地控制了容器。线程被阻止。</p><p id="9e98" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 4。在佯装中使用断路器</strong></p><p id="a944" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Feign自带断路器，D版<a class="ae jx" href="https://www.java67.com/2021/01/spring-cloud-interview-questions-with-answers-java.html" rel="noopener ugc nofollow" target="_blank">春云后，</a>默认不开启。您需要在配置文件中配置它。要打开它，请将以下代码添加到配置文件中:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d4d8" class="kq kr hi km b fi ks kt l ku kv"><em class="ky">feign.hystrix.enabled=true</em></span></pre><p id="7b6f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要基于service-feign项目进行转换，您只需将指定的fallback类添加到FeignClient的ScheduleServiceHi接口的注释中:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c7d1" class="kq kr hi km b fi ks kt l ku kv"><a class="ae jx" href="http://twitter.com/FeignClient" rel="noopener ugc nofollow" target="_blank">@FeignClient</a>(value = "service-hi",fallback = SchedualServiceHiHystric.class)<br/>public interface SchedualServiceHi {<br/>    <a class="ae jx" href="http://twitter.com/RequestMapping" rel="noopener ugc nofollow" target="_blank">@RequestMapping</a>(value = "/hi",method = RequestMethod.GET)<br/>    String sayHiFromClientOne(<a class="ae jx" href="http://twitter.com/RequestParam" rel="noopener ugc nofollow" target="_blank">@RequestParam</a>(value = "name") String name);<br/>}</span></pre><p id="0e0d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ScheduleServiceHiHystric需要实现ScheduleServiceHi接口，并将其注入Ioc容器。代码如下:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9c26" class="kq kr hi km b fi ks kt l ku kv"><a class="ae jx" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a><br/>public class SchedualServiceHiHystric implements SchedualServiceHi {<br/>    <a class="ae jx" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public String sayHiFromClientOne(String name) {<br/>        return "sorry "+name;<br/>    }<br/>}</span></pre><p id="ac99" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">启动四个servcie-feign项目，打开浏览器<a class="ae jx" href="http://localhost:8765/hi?name=forezp" rel="noopener ugc nofollow" target="_blank"> http://localhost:8765/hi？name=forezp </a>，注意此时service-hi项目没有启动，网页显示:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a0f0" class="kq kr hi km b fi ks kt l ku kv"><em class="ky">sorry forezp</em></span></pre><p id="a26c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打开service-hi项目，再次访问，浏览器显示:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="becc" class="kq kr hi km b fi ks kt l ku kv">hi forezp,i am from port:8762</span></pre><p id="9e59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这证明断路器是工作的。</p></div></div>    
</body>
</html>