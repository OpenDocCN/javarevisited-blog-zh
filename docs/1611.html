<html>
<head>
<title>Booking System with Pessimistic Locks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有悲观锁的预订系统</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/booking-system-with-pessimistic-locks-4ec107e4bd5?source=collection_archive---------0-----------------------#2021-10-03">https://medium.com/javarevisited/booking-system-with-pessimistic-locks-4ec107e4bd5?source=collection_archive---------0-----------------------#2021-10-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c2ee60508470f3d7563b5c7497f41b4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DBjZadgKYHvu2l9s"/></div></div><p class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@jeshoots?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">JESHOOTS.COM</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="3fa7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建订票系统有一个共同的任务:在电影院买票，在飞机上选择座位等。本文将研究如何基于RDBMS或键值存储构建这样一个系统。我将使用<a class="ae iu" rel="noopener" href="/javarevisited/7-best-free-postgresql-courses-for-beginners-to-learn-in-2021-3bf369d73794"> PostgreSQL </a>作为关系数据库的示例，使用Apache Ignite作为键值存储。</p><p id="db20" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">值得注意的是，我们将考虑不允许超售的情况。作为一项规则，飞机票出售，允许超售(他们可以出售比飞机上的座位更多的机票)，因为乘客经常取消机票。但是当我们预定特定的座位时，我们希望我们是唯一的持有者。</p><h1 id="763d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">悲观锁还是乐观锁</h1><p id="a741" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">首先，让我们弄清楚我们应该使用哪种锁机制。<br/>大多数任务都假设我们有这样一个流程:</p><ol class=""><li id="5fcd" class="kw kx hi ix b iy iz jc jd jg ky jk kz jo la js lb lc ld le bi translated">用户看到具有可用和预订座位的电影院的方案。</li><li id="c1e2" class="kw kx hi ix b iy lf jc lg jg lh jk li jo lj js lb lc ld le bi translated">用户选择所需的地点，并向服务器发送请求。</li><li id="8589" class="kw kx hi ix b iy lf jc lg jg lh jk li jo lj js lb lc ld le bi translated">位置被保留5-15分钟，在此期间用户必须付款。</li><li id="2849" class="kw kx hi ix b iy lf jc lg jg lh jk li jo lj js lb lc ld le bi translated">如果支付成功，座位被视为已购买。</li></ol><p id="e7d6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦我们描述了流程，如何行动就变得更清楚了。我们不能在等待付费时使用乐观锁定，因为这将意味着几个用户可能有时间为座位付费，但只有他们中的第一个会得到它。但是对于最初的预订，我们可以使用任何锁。</p><h1 id="8b66" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">预订一个座位</h1><p id="6516" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">首先，让我们看一下只预订一个座位的情况，因为它稍微简单一些。重点是将状态与特定的对象字段(或表列)同步。为此我们来定义一下<code class="du lk ll lm ln b">lock_until</code>。</p><p id="3263" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">数据库结构的一部分将如下所示:</p><figure class="lp lq lr ls fd ij er es paragraph-image"><a href="https://www.java67.com/2016/09/sql-5-best-books-to-learn-and-master.html"><div class="er es lo"><img src="../Images/84483dfbc72a96ad8ff5dc0664886560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*TBDZyj2TvZvsnhHW3RrXaw.png"/></div></a></figure><p id="20a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在那篇文章的<a class="ae iu" rel="noopener" href="/javarevisited/spring-transactional-mistakes-everyone-did-31418e5a6d6b">中，我展示了如何使用select-for-update(悲观锁)来更新实体，所以现在让我们使用版本控制(乐观锁)。</a></p><p id="612a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新语句如下所示:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="2e70" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">实际的业务逻辑是这样的:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div><p class="iq ir et er es is it bd b be z dx translated">使用PostgreSQL保留</p></figure><p id="ade7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在键值存储的情况下，唯一的区别是使用<code class="du lk ll lm ln b">replace</code>而不是update。</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div><p class="iq ir et er es is it bd b be z dx translated">使用Apache Ignite保留</p></figure><p id="d7de" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当付款完成后，我们显式重置<code class="du lk ll lm ln b">lock_until</code>并更新状态。</p><h1 id="6c0f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">预订许多座位</h1><p id="d945" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">通常我们不得不创建一个服务来预订不是一个，而是几个座位。因此，如果并发请求重叠了几个席位，我们需要决定如何处理冲突。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><a href="https://javarevisited.blogspot.com/2017/02/top-6-sql-query-interview-questions-and-answers.html"><div class="er es lv"><img src="../Images/5febcaa41235eb455829aec47305f267.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*cHSa_-IFyW04hcQchtNJ3A.png"/></div></a><p class="iq ir et er es is it bd b be z dx translated">两个用户都不满意</p></figure><p id="34bd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们什么都不做，可能会出现第一个请求成功预订了3个席位中的2个的情况，第二个请求也是如此。结果两个用户都不满意。不太可能，他们只会买两个座位。</p><p id="755e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果其中一个请求会彻底失败，而第二个请求会成功，这对我们来说就更好了。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><a href="https://javarevisited.blogspot.com/2021/05/sql-and-database-phone-interview-questions.html#axzz6vwaADRSO"><div class="er es lv"><img src="../Images/598354244f2ddbcffd4de1f955ebc088.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*YpiIS3P8zckqsdMz2XHvpg.png"/></div></a><p class="iq ir et er es is it bd b be z dx translated">只有一个用户不满意</p></figure><p id="15b5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我们可以对<a class="ae iu" rel="noopener" href="/hackernoon/top-5-sql-and-database-courses-to-learn-online-48424533ac61">关系数据库</a>使用<strong class="ix hj">表</strong>锁，但它不是键值存储的选项。此外，表锁会降低所有其他影院会话的整体性能。</p><p id="4f15" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">相反，我们也可以对<code class="du lk ll lm ln b">cinema_sessions</code>表使用<code class="du lk ll lm ln b">lock_until</code>方法。对于保留操作处理，我们最多只需要锁定10-15秒。</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="lt lu l"/></div><p class="iq ir et er es is it bd b be z dx translated">使用Apache Ignite锁定CinemaSession</p></figure><p id="560c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在只有一个用户可以同时预订一组座位。一旦完成，我们立即释放特定影院会话的锁。另外，不同的电影时段不会相互影响。</p><p id="8ce5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可能喜欢的其他<strong class="ix hj"> Java并发和多线程文章和资源</strong></p><div class="lw lx ez fb ly lz"><a rel="noopener follow" target="_blank" href="/javarevisited/8-best-multithreading-and-concurrency-courses-for-experienced-java-developers-8acfd3b25094"><div class="ma ab dw"><div class="mb ab mc cl cj md"><h2 class="bd hj fi z dy me ea eb mf ed ef hh bi translated">2021年10大最佳Java多线程和并发课程</h2><div class="mg l"><h3 class="bd b fi z dy me ea eb mf ed ef dx translated">这些是学习Java中多线程和并发的最佳课程。1是免费的</h3></div><div class="mh l"><p class="bd b fp z dy me ea eb mf ed ef dx translated">medium.com</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn io lz"/></div></div></a></div><div class="lw lx ez fb ly lz"><a rel="noopener follow" target="_blank" href="/javarevisited/6-multithreading-and-concurrency-books-every-java-programmer-should-read-b6a08d2aae54"><div class="ma ab dw"><div class="mb ab mc cl cj md"><h2 class="bd hj fi z dy me ea eb mf ed ef hh bi translated">每个Java程序员都应该阅读的6本多线程和并发性书籍</h2><div class="mg l"><h3 class="bd b fi z dy me ea eb mf ed ef dx translated">伙计们，你们可能知道书籍对于学习新事物是必不可少的，尽管身处电子时代…</h3></div><div class="mh l"><p class="bd b fp z dy me ea eb mf ed ef dx translated">medium.com</p></div></div><div class="mi l"><div class="mo l mk ml mm mi mn io lz"/></div></div></a></div><div class="lw lx ez fb ly lz"><a href="https://javarevisited.blogspot.com/2014/07/top-50-java-multithreading-interview-questions-answers.html#axzz6hX6XfwBD" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab dw"><div class="mb ab mc cl cj md"><h2 class="bd hj fi z dy me ea eb mf ed ef hh bi translated">经验丰富的50个Java线程面试问题答案</h2><div class="mg l"><h3 class="bd b fi z dy me ea eb mf ed ef dx translated">你去参加任何一个Java面试，无论是大四还是大三，无论是有经验的还是大一新生，你肯定会看到一些来自…</h3></div><div class="mh l"><p class="bd b fp z dy me ea eb mf ed ef dx translated">javarevisited.blogspot.com</p></div></div><div class="mi l"><div class="mp l mk ml mm mi mn io lz"/></div></div></a></div></div></div>    
</body>
</html>