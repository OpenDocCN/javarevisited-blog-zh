<html>
<head>
<title>System Interaction Design of Sponsored SMS systems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">赞助短信系统的系统交互设计</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/system-interaction-design-of-sponsored-sms-systems-fe2cab03a6f7?source=collection_archive---------2-----------------------#2021-07-11">https://medium.com/javarevisited/system-interaction-design-of-sponsored-sms-systems-fe2cab03a6f7?source=collection_archive---------2-----------------------#2021-07-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="d308" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">关于如何构建这些消息传递系统的案例研究</h2></div><p id="2b2d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在过去的几年里，创业世界到处都是关于消息服务提供商的消息，如<a class="ae jt" href="https://venturebeat.com/2016/07/14/line-starts-trading-on-nyse-at-42-up-33-from-ipo-price/" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj"/></a><a class="ae jt" href="https://www.cnbc.com/2016/06/23/twilio-ipo.html" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">Twilio</strong></a><strong class="iz hj"/>等。以十亿美元的估值在美国上市，这一趋势中最新的一个是<a class="ae jt" href="https://messagebird.com/en/" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj"> MessageBird </strong> </a>。</p><p id="16ad" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这种趋势现在已经在印度出现，印度本土的信息服务提供商如<a class="ae jt" href="https://www.routemobile.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj"> Route Mobile </strong> </a>已经上市，很少有其他公司如<a class="ae jt" href="http://www.gupshup.io" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj"> SMS Gupshup </strong> </a>也在排队搭上IPO的顺风车。</p><h1 id="6365" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">短信服务有什么特别之处？</h1><p id="06d7" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">嗯，这是这些交付服务处理的规模，虽然消息数据大小很小(只有160个字符，只有几千字节)，但数量至少在每天1亿+百万的规模，每月至少转化为30到40亿条消息。</p><h2 id="d073" class="kr jv hi bd jw ks kt ku ka kv kw kx ke jg ky kz kg jk la lb ki jo lc ld kk le bi translated">那么如何建立这样的系统呢？</h2><p id="e548" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">好了，这是本博客讨论的主题，所以不再浪费时间，让我们深入到我的赞助短信系统的系统交互设计的案例研究中去。</p><h1 id="d101" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">系统交互设计</h1><p id="07a8" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated"><strong class="iz hj">设计注意事项</strong></p><ul class=""><li id="71a5" class="lf lg hi iz b ja jb jd je jg lh jk li jo lj js lk ll lm ln bi translated">必须快速，延迟非常低，即在几秒钟内</li><li id="f660" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">每天处理至少2亿封邮件</li><li id="bc5d" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">对于事务性消息传递，必须无损且可靠</li><li id="02d1" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">处理流量突发(短期促销流量)</li><li id="96e4" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">低成本的基础设施最好能够自动扩展。</li><li id="b0f8" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">支持邮件过滤/垃圾邮件检测/清理。</li><li id="ef96" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">支持进出流量的各种协议</li><li id="b62d" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">具有粒度级实时跟踪和报告的能力</li></ul><p id="a6a3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以上是Twilio这样的赞助商消息系统的几个需求，应该是<strong class="iz hj">高度分布式、</strong> <a class="ae jt" rel="noopener" href="/javarevisited/5-best-courses-to-learn-spring-cloud-and-microservices-1ddea1af7012"> <strong class="iz hj">微服务化、</strong> </a> <strong class="iz hj">、负载均衡、启用缓存、支持文件存储的系统</strong>。我们可能不得不构建我们的定制解决方案，但是我不会深入探究那些库/解决方案的实现(稍后会写一篇博客)。</p><p id="88f4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">基本流程是:</strong></p><h2 id="2d44" class="kr jv hi bd jw ks kt ku ka kv kw kx ke jg ky kz kg jk la lb ki jo lc ld kk le bi translated"><strong class="ak">用户</strong> → <strong class="ak">赞助短信系统</strong> → <strong class="ak">运营商</strong></h2><p id="2341" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">首先，谁是这个系统的<strong class="iz hj">用户</strong>，答案是使用促销&amp;交易信息的企业，即<strong class="iz hj">银行、电子商务门户、促销活动者</strong>等。<strong class="iz hj">运营商</strong>是移动服务提供商，如<strong class="iz hj"> Airtel、沃达丰、Reliance Jio </strong>等。下面的系统图作为将要出现的信息的实际表示:</p><figure class="lu lv lw lx fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lt"><img src="../Images/582518b6f5d3bd15924c07bc7027a22e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6s0ZvkN6eJ5NIxA6FsuC_w.png"/></div></div><p class="mf mg et er es mh mi bd b be z dx translated">赞助短信系统交互流程</p></figure><h1 id="7410" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">对赞助短信系统的思考</h1><p id="ae7e" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">赞助短信系统提供多种方式发送160个字符的短信，一种是使用由<strong class="iz hj"> SMPP MsgListener服务</strong>支持的<strong class="iz hj"> SMPP协议</strong>(在此处<a class="ae jt" href="https://smpp.org/" rel="noopener ugc nofollow" target="_blank">了解更多信息</a>，第二种可能是将文件上传到他们的<strong class="iz hj">门户网站(或基于批准/定制的解决方案</strong>)。</p><p id="4e89" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是我相信90%的信息是通过HTTP直接提交到FrontAPI组件上的，因为赞助商系统通常与不同的商业软件集成在一起。向FrontAPI的提交可以通过<strong class="iz hj">同步</strong> API(接受请求进行基本的真实性检查并返回响应)或<strong class="iz hj">异步</strong> API(只接受请求并在稍后的时间点处理它)来完成。</p><p id="210c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">FrontAPI之后的其他系统必须是<strong class="iz hj">异步的</strong>，否则将需要太多的机器，这可以通过<strong class="iz hj">分布式队列(如</strong> Redis-Based/RabbitMq等)或c<strong class="iz hj">custom asynchronous file Based队列</strong>(针对对象存储进行了优化，因为Java有时会造成混乱的序列化)来处理，然后再进行处理。</p><blockquote class="mj mk ml"><p id="eda0" class="ix iy mm iz b ja jb ij jc jd je im jf mn jh ji jj mo jl jm jn mp jp jq jr js hb bi translated">(更多关于定制的<strong class="iz hj">基于异步文件的队列</strong>在我接下来的博客中)</p></blockquote><p id="032b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://www.java67.com/2015/12/producer-consumer-solution-using-blocking-queue-java.html" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj"/></a><strong class="iz hj">、LMAX干扰器等。，及其多线程变体</strong>应被实现以实现高性能并提取基础设施的完整汁液。</p><p id="3716" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> DB调用必须绝对为零</strong>才能达到规模，因为对<a class="ae jt" rel="noopener" href="/javarevisited/top-10-free-courses-to-learn-microsoft-sql-server-and-oracle-database-in-2020-6708afcf4ad7"> DB </a>的写入应该与MQ(消息队列)异步发生。表中的数据应该遵循直写式缓存实现，使用<strong class="iz hj"> Redis </strong>或<strong class="iz hj"> Memcached </strong>层。</p><p id="6d49" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">还有一个<strong class="iz hj">接近实时(NRT)的报告仪表板</strong>，用于跟踪通过所有应用程序的每条赞助短信的进度。这可以通过使用诸如<strong class="iz hj"> Scribe </strong>之类的传输器将事件发送到另一个称为<strong class="iz hj">事件处理器</strong>的系统来实现。这里需要注意的一点是<strong class="iz hj">该系统的规模几乎是原来的10倍，因为1条短信会生成10个不同的事件，所以每天至少会提供10亿个事件的报告和分析。</strong></p><h1 id="866f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated"><strong class="ak">角色&amp;各组成部分的职责</strong></h1><p id="af97" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated"><strong class="iz hj"> FrontAPI </strong>应该做的(注意它必须以毫秒为单位返回响应)</p><ul class=""><li id="2aa0" class="lf lg hi iz b ja jb jd je jg lh jk li jo lj js lk ll lm ln bi translated">短信模板匹配</li><li id="9858" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">输入验证等</li><li id="3cf2" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">避免数据库调用帐户真实性，</li><li id="fabc" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">消息模板匹配，</li><li id="bfe4" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">应该使用分布式缓存</li><li id="38ea" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">将消息异步传递给<strong class="iz hj">短信引擎</strong>组件。</li></ul><p id="ae73" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> WebHook服务</strong>是另一个出站组件，收集用户的输入响应(例如<strong class="iz hj"> Kaun Banega Crorepati — </strong>印度版的<a class="ae jt" href="https://www.youtube.com/channel/UCKSxNv7X_ewMbXgs134rCJA" rel="noopener ugc nofollow" target="_blank">谁想成为百万富翁</a>用户发送了他们对4位短代码的回复)，然后通过配置的URL转发给公司。</p><p id="3900" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">短信引擎(</strong>基本上是系统的心脏):</p><ul class=""><li id="fac1" class="lf lg hi iz b ja jb jd je jg lh jk li jo lj js lk ll lm ln bi translated">促销和交易流量分叉、转移和分配到<strong class="iz hj"> orchestrator </strong>实例</li><li id="536d" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">对例如<strong class="iz hj"> NV </strong>(号码验证)<strong class="iz hj"> NCPR </strong>(全国用户偏好寄存器(<a class="ae jt" href="https://en.wikipedia.org/wiki/Telecom_Regulatory_Authority_of_India" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">【TRAI</strong></a>)<strong class="iz hj"/>(移动号码携带)<strong class="iz hj"> BlockNo服务</strong>等应用各种擦洗逻辑。。</li><li id="40a7" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">过滤垃圾邮件/计划邮件，并将它们移动到相应的<strong class="iz hj">垃圾邮件容器/计划容器</strong>组件</li></ul><p id="578c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> SchedulerHolder </strong>组件任务是存储消息，直到预定日期&amp;那天应用相同的清理规则，因为清理数据每天和每周都会发生变化。</p><p id="52f0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> SpamHolder </strong>是包含针对用户的反对或垃圾内容的促销消息的控制组件，有一个文字引擎逻辑，用于将这些消息标记为垃圾消息，并将此类活动通知客户关系团队。</p><p id="7dfc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> Orchestrator </strong>是一个分发器组件，它根据帐户的配置在服务器之间异步接收和分发繁重的流量。</p><p id="6281" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> MessageDispatcher </strong>是发送逻辑处理器，它有各种贪婪算法来选择发送哪个运营商，由于有些在印度特定地区更便宜，有些发送成本高但有保证，所以这个组件有实现的算法，如<a class="ae jt" href="https://medium.datadriveninvestor.com/leaky-bucket-algorithm-for-flow-control-6ba600bfee10" rel="noopener ugc nofollow" target="_blank">漏桶</a>，基于成本的优化，发送&amp;时间参数。</p><div class="mq mr ez fb ms mt"><a href="https://medium.datadriveninvestor.com/leaky-bucket-algorithm-for-flow-control-6ba600bfee10" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hj fi z dy my ea eb mz ed ef hh bi translated">流量控制的漏桶算法</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">接受大量请求并以恒定速率提供服务的经济高效的解决方案。</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">medium.datadriveninvestor.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh md mt"/></div></div></a></div><p id="80ac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">日志记录</strong>组件异步接收&amp;并将所有传出的消息存储在表/文件中(二进制或拼花格式)以便协调。这充当了<strong class="iz hj">对账</strong>组件的一个输入源，该组件的工作是为每个客户创建使用和计费报告。</p><p id="d1c5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">消息发送者:</strong></p><ul class=""><li id="0e22" class="lf lg hi iz b ja jb jd je jg lh jk li jo lj js lk ll lm ln bi translated">将消息提交给操作员SMSC</li><li id="ef72" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">收集SMPP提交的来自操作员SMSC的响应(他们处理SMPP的消息)</li><li id="f787" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">标识是否要重试消息。</li><li id="96b8" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">从操作员SMSC处收集交货报告，并将其传递给<strong class="iz hj">交货报告系统</strong>进行进一步处理。</li><li id="51fe" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">这也将传入的响应发送到<strong class="iz hj"> Web Hook消息接收器</strong>服务，该服务又转发到<strong class="iz hj"> Web hook服务</strong>，该服务将响应转发到客户的已配置URL。</li></ul><p id="cca3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> SMSRetryCallback系统:</strong>这是一个重试系统，由于第一次尝试失败，它会将SMS的属性重置给另一个运营商，以便从不同运营商SMSC的<strong class="iz hj"> MessageDispatcher </strong>再次重试。</p><p id="9598" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">交付报告(DR)系统:</strong></p><p id="9fd8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个微服务应该处理交付报告，并保存到数据库/文件中，还应该一起缓存。缓存的灾难恢复将加速由<strong class="iz hj">msg reconcilization</strong>组件完成的协调过程。</p><p id="713f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">事件处理者</strong>的职责应该是</p><ul class=""><li id="164f" class="lf lg hi iz b ja jb jd je jg lh jk li jo lj js lk ll lm ln bi translated">为每条消息提供<strong class="iz hj">近乎实时的跟踪(NRT) </strong></li><li id="e11f" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">系统内部故障的亲密技术支持团队</li><li id="09b4" class="lf lg hi iz b ja lo jd lp jg lq jk lr jo ls js lk ll lm ln bi translated">提供一个仓储系统，以获取报告并根据区域、周期、时间、操作员等分析趋势。</li></ul></div><div class="ab cl ni nj gp nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="hb hc hd he hf"><p id="6e18" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">有趣的阅读</strong></p><ul class=""><li id="f3c9" class="lf lg hi iz b ja jb jd je jg lh jk li jo lj js lk ll lm ln bi translated">系统分析论文:【https://arxiv.org/ftp/arxiv/papers/1408/1408.1201.pdf T2】</li></ul></div><div class="ab cl ni nj gp nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="hb hc hd he hf"><p id="cf14" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有问题吗？建议？评论？</p><p id="ddce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下一步是什么？<a class="ae jt" rel="noopener" href="/@vaibhav0109"> <strong class="iz hj">在Medium上关注我</strong> </a>成为第一个阅读我的故事的人。</p></div></div>    
</body>
</html>