<html>
<head>
<title>Run CPU or memory-intensive operations using kubernetes job</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 kubernetes 作业运行 CPU 或内存密集型操作</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/run-cpu-or-memory-intensive-operations-using-kubernetes-job-f086ba832ba7?source=collection_archive---------0-----------------------#2019-09-24">https://medium.com/javarevisited/run-cpu-or-memory-intensive-operations-using-kubernetes-job-f086ba832ba7?source=collection_archive---------0-----------------------#2019-09-24</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><figure class="hi hj fa fc hk hl es et paragraph-image"><div class="es et hh"><img src="../Images/379f48661f7a883a83c651861018bc5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:418/format:webp/1*Vwz3H34tEt4AWsxQrs-uXg.png"/></div></figure><div class=""/><p id="e494" class="pw-post-body-paragraph in io hq ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hc bi translated">外部 web 应用程序或服务器 pod</p><h2 id="8891" class="jl jm hq bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">问题陈述:</h2><p id="75ad" class="pw-post-body-paragraph in io hq ip b iq kg is it iu kh iw ix iy ki ja jb jc kj je jf jg kk ji jj jk hc bi translated">如果您在 kubernetes pod 中运行一个 web 应用程序，您可能会遇到的一个常见用例或需求是运行一些内存密集型操作，这是并行运行的用户流的一部分，支持多个请求。部分要求是确保正在运行的 web 应用程序不受此操作的影响</p><h2 id="6033" class="jl jm hq bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">使用案例:</h2><p id="b016" class="pw-post-body-paragraph in io hq ip b iq kg is it iu kh iw ix iy ki ja jb jc kj je jf jg kk ji jj jk hc bi translated">比方说，你有一个新的需求或功能请求，从用户那里接受一个个人资料图片，生成 4 个不同版本的 thubmail (XS，M &amp; L)流的一部分。用户可以上传大小从 100 到 200 MB 不等的原始图像。这个特性应该支持每秒 50 个并行请求</p><h2 id="3a73" class="jl jm hq bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">使用 java 线程:</h2><p id="cb97" class="pw-post-body-paragraph in io hq ip b iq kg is it iu kh iw ix iy ki ja jb jc kj je jf jg kk ji jj jk hc bi translated">解决这个问题的简单方法是使用 java 线程，流程如下:</p><ul class=""><li id="f63f" class="kl km hq ip b iq ir iu iv iy kn jc ko jg kp jk kq kr ks kt bi translated">用户通过浏览器将原始图像上传到服务器</li><li id="64da" class="kl km hq ip b iq ku iu kv iy kw jc kx jg ky jk kq kr ks kt bi translated">J2EE 应用程序用原始图像作为参数为每个请求旋转一个新线程</li><li id="bc28" class="kl km hq ip b iq ku iu kv iy kw jc kx jg ky jk kq kr ks kt bi translated">该线程将负责生成所需的缩略图，并将其保存在所有窗格都可以访问的共享位置</li></ul><blockquote class="kz la lb"><p id="1fb8" class="in io lc ip b iq ir is it iu iv iw ix ld iz ja jb le jd je jf lf jh ji jj jk hc bi translated"><strong class="ip hr">该方法的问题/议题</strong></p></blockquote><ul class=""><li id="98db" class="kl km hq ip b iq ir iu iv iy kn jc ko jg kp jk kq kr ks kt bi translated">处理 50 个请求，每个请求处理大约 100 MB 的图像，很快就会导致<a class="ae lg" href="http://javarevisited.blogspot.sg/2011/09/javalangoutofmemoryerror-permgen-space.html#axzz5DmwFLA1K" rel="noopener ugc nofollow" target="_blank">内存不足</a>错误，最终导致 pod 崩溃</li><li id="1ee0" class="kl km hq ip b iq ku iu kv iy kw jc kx jg ky jk kq kr ks kt bi translated">肯定不可扩展。如果每秒的请求数量增加，唯一的扩展方式是垂直扩展或添加更多的 web 应用程序单元(如果我们只是为了处理缩略图生成而这样做，而网站不需要这样做，则不需要这样做)</li></ul><h2 id="add4" class="jl jm hq bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">使用 Kubernetes 作业:</h2><p id="3453" class="pw-post-body-paragraph in io hq ip b iq kg is it iu kh iw ix iy ki ja jb jc kj je jf jg kk ji jj jk hc bi translated">使用 kubernetes job 将是解决此流程问题的更好方式:</p><ul class=""><li id="fd72" class="kl km hq ip b iq ir iu iv iy kn jc ko jg kp jk kq kr ks kt bi translated">用户通过浏览器将原始图像上传到服务器</li><li id="7f9e" class="kl km hq ip b iq ku iu kv iy kw jc kx jg ky jk kq kr ks kt bi translated">J2EE 应用程序创建一个<a class="ae lg" href="https://javarevisited.blogspot.com/2019/01/top-5-free-kubernetes-courses-for-DevOps-Engineer.html" rel="noopener ugc nofollow" target="_blank"> kubernetes 作业</a>，并提供原始图像作为作业处理程序的参数</li><li id="09d9" class="kl km hq ip b iq ku iu kv iy kw jc kx jg ky jk kq kr ks kt bi translated">处理完成后，作业会将图像写入共享位置，供所有 pod 访问</li></ul><blockquote class="kz la lb"><p id="146a" class="in io lc ip b iq ir is it iu iv iw ix ld iz ja jb le jd je jf lf jh ji jj jk hc bi translated"><strong class="ip hr">这种方法的优势</strong></p></blockquote><ul class=""><li id="b0f2" class="kl km hq ip b iq ir iu iv iy kn jc ko jg kp jk kq kr ks kt bi translated">现在，缩略图处理被移出了 web 应用程序窗格，因此 web 应用程序可以在窗格中运行，而没有任何内存问题或限制。</li><li id="282f" class="kl km hq ip b iq ku iu kv iy kw jc kx jg ky jk kq kr ks kt bi translated">更容易扩展，因为应用程序处理的缩略图请求的数量与 kubernetes 集群中的可用资源成正比。如果我们想要扩大规模，我们可以在更精细的级别添加更多资源。</li></ul><h2 id="9372" class="jl jm hq bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">编写 kubernetes 作业(使用 java)</h2><pre class="lh li lj lk fe ll lm ln lo aw lp bi"><span id="7b16" class="jl jm hq lm b fj lq lr l ls lt">final KubernetesClient client = new DefaultKubernetesClient();<br/>Map&lt;String, String&gt; labelMap = new HashMap&lt;String, String&gt;();<br/> jobLabelsMap.put(“app”, “label”);</span><span id="87bb" class="jl jm hq lm b fj lu lr l ls lt">String compilerImage = “&lt;&lt;Docker Image for Compiler &gt;&gt;”;</span><span id="e63f" class="jl jm hq lm b fj lu lr l ls lt">String jobName = “thubmailGeneratorContainer”;</span><span id="9bff" class="jl jm hq lm b fj lu lr l ls lt">// Delete any pre-existing jobs with the same name. Cascade to created pods<br/> client.batch().jobs().inNamespace(“applicationNameSpace”).withName(jobName).cascading(true).delete();<br/> final Job job = new JobBuilder()<br/> .withApiVersion(“image/v1”) // API version<br/> .withNewMetadata()<br/> .withName(jobName)<br/> .withLabels(labelMap) // Labels<br/> .endMetadata()<br/> .editOrNewSpec()<br/> .editOrNewTemplate()<br/> .withNewMetadata()<br/> .withLabels(labelMap)<br/> .endMetadata()<br/> .editOrNewSpec()<br/> .withRestartPolicy(“OnFailure”)<br/> .addNewContainer()<br/> .withName(jobName) // Job Name<br/> .withImage(compilerImage) // Docker image<br/> .withImagePullPolicy(“Always”)<br/> .endEnv()<br/> .withNewResources()<br/> .addToRequests(“cpu”, new Quantity(“1”)) // CPU<br/> .addToRequests(“memory”, new Quantity(“1Gi”)) // Memory<br/> .addToLimits(“cpu”, new Quantity(“2”)) // CPU limit<br/> .addToLimits(“memory”, new Quantity(“2Gi”)) // Memory limit<br/> .endResources()<br/> .addToCommand(0, “java”)<br/> .addToCommand(1, “-jar”)<br/> .addToCommand(2, “/tmp/thumbGenerate.jar”) // Jar for thumbnail generation<br/> .addToCommand(3, “&lt;&lt;Path Of Image RAW File &gt;&gt;”)<br/> .endContainer()<br/> .withRestartPolicy(“Never”)<br/> .endSpec()<br/> .endTemplate()<br/> .endSpec()<br/> .build();</span><span id="f7df" class="jl jm hq lm b fj lu lr l ls lt">client.batch().jobs().inNamespace(“applicationNameSpace”).create(job); // Run Job</span></pre><p id="046a" class="pw-post-body-paragraph in io hq ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hc bi translated">感谢您的阅读，如果您对这种方法或解决方案有任何意见，请随时联系我</p></div></div>    
</body>
</html>