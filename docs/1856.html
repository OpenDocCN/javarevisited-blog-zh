<html>
<head>
<title>First Mocked Unit Test Generated by DDTJ — Building DDTJ Day 9</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DDTJ生成的第一个模拟单元测试—构建DDTJ第9天</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/first-mocked-unit-test-generated-by-ddtj-building-ddtj-day-9-df16fc66acf4?source=collection_archive---------1-----------------------#2021-12-31">https://medium.com/javarevisited/first-mocked-unit-test-generated-by-ddtj-building-ddtj-day-9-df16fc66acf4?source=collection_archive---------1-----------------------#2021-12-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0d5812a8312ff4e73195512c4456060b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JhhJySGSDiFZhY-b59FnjA.png"/></div></div></figure><p id="9921" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">昨天<a class="ae jo" href="https://dev.to/codenameone/build-issues-code-generation-and-depth-vs-breadth-first-building-ddtj-day-8-2242" rel="noopener ugc nofollow" target="_blank">我遇到了一些阻碍</a>，但是我很高兴地告诉大家，这些都已经过去了。我们终于有了历史上第一个由DDT生成的测试！</p><p id="602e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我想宣布胜利，但前面的路还很长，结果在这一点上“令人印象深刻”。我们已经生成了代码，但是它仍然不能马上编译，至少对于POJOs来说，它没有注入模拟(尽管它创建了模拟)。我认为这些都是可以克服的问题，我们可以向前迈进。</p><p id="fed5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是我有点超前了。让我们来谈谈代码现在发生了什么…或者至少在<a class="ae jo" href="https://github.com/ddtj/ddtj/pull/8" rel="noopener ugc nofollow" target="_blank">当前的PR </a>中，它仍然在等待更多的测试覆盖。</p><p id="a4d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我正在运行一个超级简单的应用程序:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="e6bf" class="jy jz hi ju b fi ka kb l kc kd">public class BasicApp {<br/>   private BasicDependency dependency = new BasicDependency();<br/>   public static void main(String[] args) throws InterruptedException {<br/>       new BasicApp().run();<br/>   }</span><span id="8c7e" class="jy jz hi ju b fi ke kb l kc kd">   public void run() throws InterruptedException {<br/>       System.out.println("This is the first testable method");<br/>       System.out.println(dependency.otherMethod("This prints three", 3));<br/>   }<br/>}</span></pre><p id="b58c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它调用:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="4aed" class="jy jz hi ju b fi ka kb l kc kd">public class BasicDependency {<br/>   public String otherMethod(String key, int counter) throws InterruptedException {<br/>       System.out.println("otherMethod");<br/>       return key + " " + counter;<br/>   }<br/>}</span></pre><p id="359a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了对此生成测试，我使用了以下过程:</p><h1 id="4c8c" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">运行后端服务器</h1><p id="a99e" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">服务器进程从应用程序收集执行数据:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="090b" class="jy jz hi ju b fi ka kb l kc kd">java -jar target/Backend-0.0.5-SNAPSHOT.jar</span></pre><h1 id="1551" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">运行应用程序</h1><p id="042e" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">下一步是让服务器运行/调试应用程序。这用类似下面的内容替换了标准的java命令行:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="9b28" class="jy jz hi ju b fi ka kb l kc kd">java -jar target/CLI-0.0.5-SNAPSHOT-shaded.jar -run dev.ddtj.backend.testdata.BasicApp -classpath Backend/target/test-classes</span></pre><p id="d1be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，这个命令是异步的，因为它运行在后端服务器上下文中。</p><h1 id="544e" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">找到并生成测试</h1><p id="6e22" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">首先，我们需要列出我们要插装的类:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="489c" class="jy jz hi ju b fi ka kb l kc kd">java -jar target/CLI-0.0.5-SNAPSHOT-shaded.jar -c</span></pre><p id="2beb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它打印出:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="b2b2" class="jy jz hi ju b fi ka kb l kc kd">Class Name                                                  | Method Count    | Execution Count<br/>----------                                                  | ------------    | ---------------<br/>dev.ddtj.backend.testdata.BasicDependency                   | 1               | 1<br/>dev.ddtj.backend.testdata.BasicApp                          | 2               | 2</span></pre><p id="a277" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们需要查看我们可以在特定类中测试的方法:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="4862" class="jy jz hi ju b fi ka kb l kc kd">java -jar target/CLI-0.0.5-SNAPSHOT-shaded.jar -m dev.ddtj.backend.testdata.BasicApp</span></pre><p id="f8be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它打印出:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="7016" class="jy jz hi ju b fi ka kb l kc kd">Method Name                                                 | Total Execution<br/>-----------                                                 | ---------------<br/>main([Ljava/lang/String;)V                                  | 1<br/>run()V                                                      | 1</span></pre><p id="69f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们需要找到可用的测试。当我们有一个测试时，它似乎是多余的，但当我们有更多测试时，它是有意义的:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="07d0" class="jy jz hi ju b fi ka kb l kc kd">java -jar target/CLI-0.0.5-SNAPSHOT-shaded.jar -t "dev.ddtj.backend.testdata.BasicApp.run()V"</span></pre><p id="cfc4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打印输出:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="6069" class="jy jz hi ju b fi ka kb l kc kd">Test ID                                 | Test Hour of the Day<br/>-------                                 | --------------------<br/>JuZlJX5ERAKXZQR8CpYgiA--7               | Thu Dec 30 08:31:25 IST 2021</span></pre><p id="0730" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在可以根据这些结果生成一个测试:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="a159" class="jy jz hi ju b fi ka kb l kc kd">java -jar target/CLI-0.0.5-SNAPSHOT-shaded.jar -g "dev.ddtj.backend.testdata.BasicApp,run()V,JuZlJX5ERAKXZQR8CpYgiA--7"</span></pre><p id="adae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它打印出:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="a917" class="jy jz hi ju b fi ka kb l kc kd">/**<br/> * Generated by &lt;a href="https://github.com/ddtj/ddtj/"&gt;ddtj&lt;/a&gt;<br/> */<br/>package dev.ddtj.backend.testdata.test;</span><span id="30dd" class="jy jz hi ju b fi ke kb l kc kd">import org.junit.jupiter.api.Test;<br/>import org.junit.jupiter.api.extension.ExtendWith;<br/>import org.mockito.Mock;<br/>import org.mockito.Mockito;<br/>import org.mockito.junit.jupiter.MockitoExtension;<br/>import dev.ddtj.backend.testdata.BasicApp;<br/>import dev.ddtj.backend.testdata.BasicDependency;</span><span id="4c98" class="jy jz hi ju b fi ke kb l kc kd">@ExtendWith(MockitoExtension.class)<br/>class BasicAppTests {<br/>    @Test<br/>    void runTest() {<br/>        BasicDependency BasicDependencyMock = Mockito.mock(BasicDependency.class);<br/>        Mockito.lenient().when(BasicDependencyMock.otherMethod("This prints three", 3)).thenReturn("This prints three 3");<br/>        BasicApp myObjectInstance =  new BasicApp();<br/>        myObjectInstance.run();<br/>    }<br/>}</span></pre><h1 id="777a" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">什么不起作用？</h1><p id="de27" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">上面的代码有几个问题。首先，我们不检测被检查的异常，所以这段代码不能编译。</p><p id="693a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为一个短期的解决方法，我在测试方法中添加了一个“<a class="ae jo" href="https://javarevisited.blogspot.com/2012/02/difference-between-throw-and-throws-in.html" rel="noopener ugc nofollow" target="_blank">throws Exception”</a>。这确保了它能正确编译，并如预期的那样失败。</p><p id="b13a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">更大的问题是模拟没有正确绑定。我预料到了这一点，因为我没有为此编写代码，而且技术上也没有办法绑定这个模拟。我希望在“真实世界”的代码上进行测试时，这将更加合理。</p><p id="7e7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">代码没有使用<code class="du lh li lj ju b">@Mock</code>或<code class="du lh li lj ju b">@InjectMocks</code>注释。我认为这是我可以改进的地方。我希望有多种风格的测试生成来支持各种个人品味。</p><p id="2b4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为没有调用mock，所以测试会失败，但是我添加了“宽松的”()调用作为短期解决方法，这样我们就可以继续了。</p><h1 id="bcb1" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">什么在起作用？</h1><p id="3fce" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">我很高兴它正确地生成了模拟代码并实现了模拟。</p><p id="8672" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对象的创建和依赖包含了许多令人毛骨悚然的代码，但是现在它正在整合起来，我认为基础非常好。</p><p id="102d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我对数据收集代码和基本架构非常满意。现在的关键挑战是对此进行微调和扩展，以便它能够正确地用于更多“真实世界”的工作负载。</p><p id="6d47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我想下周我会在我的事后博客文章中更详细地讨论这个问题。我想我需要一些时间来看看一切是如何结合在一起的。</p><h1 id="d436" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">明天</h1><p id="8c20" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">现在我面临着两大挑战:</p><ol class=""><li id="5415" class="lk ll hi is b it iu ix iy jb lm jf ln jj lo jn lp lq lr ls bi translated">合并PR——这很难，尤其是测试我写的所有代码</li><li id="898f" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated">根据用例进行扩展和改进</li></ol><p id="b846" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个阶段，我很高兴我完成了基本目标。但是，我想建立一个适当的MVP，所以我希望我可以得到一个现实世界的应用程序运行。我认为像网络界面这样的蓝天计划要等到这个阶段之后。</p><p id="db8f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想了解这个系列和我从事的许多其他事情的最新进展，那么<a class="ae jo" href="https://twitter.com/debugagent" rel="noopener ugc nofollow" target="_blank">在twitter上关注我</a>。</p></div></div>    
</body>
</html>