<html>
<head>
<title>Choosing the right JDBC Connection Pool…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">选择正确的JDBC连接池…</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/choosing-the-right-jdbc-connection-pool-c9ef90588d55?source=collection_archive---------1-----------------------#2021-10-20">https://medium.com/javarevisited/choosing-the-right-jdbc-connection-pool-c9ef90588d55?source=collection_archive---------1-----------------------#2021-10-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="60f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提高应用程序的性能，而不真正改变任何东西。</p><h1 id="d19f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">为什么我们需要连接池？</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/f6a992627330d698d99d79da4d4388e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3C6pOIXlS0A_Mb9_.png"/></div></div><p class="kn ko et er es kp kq bd b be z dx translated"><a class="ae kr" href="https://developpaper.com/spring-boot-integrates-connection-pool/" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="c54b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建与数据库系统的连接是一项昂贵且耗时的操作，如果您运行的平台经历了大规模的用户一遍又一遍地构建和清除数据库连接，这是完全不可行的。为了理解为什么创建一个连接如此昂贵，让我们来看看涉及到哪些步骤:</p><ol class=""><li id="5b08" class="ks kt hi ih b ii ij im in iq ku iu kv iy kw jc kx ky kz la bi translated">打开与数据库的连接</li><li id="4be2" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">在建立连接之前对用户进行身份验证</li><li id="9980" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">创建用于读/写数据的TCP套接字</li><li id="feab" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">通过套接字发送/接收数据</li><li id="a6cc" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">关闭连接</li><li id="8c0e" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">关闭TCP套接字</li></ol><p id="f8ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连接池就是用来解决这个问题的，它提前创建一个可重用的连接池来提高应用程序的性能。每当应用程序启动时，数据库都会创建一个连接池。这些连接由池连接管理器管理。后者负责管理连接的生命周期。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><a href="https://javarevisited.blogspot.com/2020/05/10-jdbctemplate-examples-in-spring.html#axzz6oawwFfxd"><div class="er es lg"><img src="../Images/e7fb1a574243565b617574b75640e488.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*9g-jWQriVBWKDlUa.jpg"/></div></a><p class="kn ko et er es kp kq bd b be z dx translated"><a class="ae kr" href="https://ejbvn.wordpress.com/category/week-2-entity-beans-and-message-driven-beans/day-09-using-jdbc-to-connect-to-a-database/" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="bcb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每当客户端请求连接时，连接池管理器从可用连接池中取出一个连接，并将该直接链接返回给客户端。池管理器还会一直监听活动连接上的所有事件，对于任何关闭事件，它都会执行一个伪关闭，即获取连接并将其放回池中。</p><h1 id="6e42" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">JDBC连接池框架</h1><p id="72a2" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">有许多可供企业使用的连接池框架。这也意味着为您的应用程序选择哪个连接池框架会更加混乱。</p><blockquote class="lm ln lo"><p id="0c90" class="if ig lp ih b ii ij ik il im in io ip lq ir is it lr iv iw ix ls iz ja jb jc hb bi translated">TL；DR:如果你不想花很多时间来找出哪个连接池最适合你的服务，你可以选择<a class="ae kr" href="https://github.com/brettwooldridge/HikariCP" rel="noopener ugc nofollow" target="_blank"> HikariCP </a>，它提供了最佳的功能平衡，并声称在几个基准测试中性能最佳。</p></blockquote><h2 id="ed35" class="lt je hi bd jf lu lv lw jj lx ly lz jn iq ma mb jr iu mc md jv iy me mf jz mg bi translated">从一个好的连接池框架中你需要什么？</h2><p id="b293" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated"><strong class="ih hj">可靠性</strong></p><ol class=""><li id="9b00" class="ks kt hi ih b ii ij im in iq ku iu kv iy kw jc kx ky kz la bi translated">易于配置。</li><li id="97a6" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">小心图书馆里的窃听器。</li><li id="2bfd" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">特别注意死锁问题，一些连接池配置不正确时会导致死锁。</li></ol><p id="ca83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">性能</strong></p><ol class=""><li id="095d" class="ks kt hi ih b ii ij im in iq ku iu kv iy kw jc kx ky kz la bi translated">网上会有大量的测试结果，但是你应该特别注意设置和测试环境。</li><li id="b3fa" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">测试结果在很大程度上依赖于配置设置，适用于它们的可能不适用于您的服务。</li></ol><p id="540d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">社区&amp;支持</strong></p><ol class=""><li id="de65" class="ks kt hi ih b ii ij im in iq ku iu kv iy kw jc kx ky kz la bi translated">有据可查。</li><li id="9836" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">大型活跃社区基地。</li><li id="ea4f" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">广泛使用。</li></ol><p id="1c5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然有很多框架可供选择，如C3P0，阿帕奇DBCP，BoneCp，Vibur等。然而，最受欢迎的选择是<strong class="ih hj">雄猫JDBC </strong> &amp; <strong class="ih hj"> HikariCP。</strong></p><p id="742d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> HikariCP🚀</strong></p><p id="f43e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">光(发音为Hi-Kaa-lee)翻译过来就是“光”，因其超轻的性质而得名(<em class="lp">只有130kb】)它是由Brett Wooldridge开发的。有趣的<a class="ae kr" href="https://blog.jooq.org/jooq-tuesdays-brett-wooldridge-shows-what-it-takes-to-write-the-fastest-java-connection-pool/" rel="noopener ugc nofollow" target="_blank">阅读关于Brett Wooldridge如何写“最快的连接池”的</a>。如今，光是大多数公司的首选，它的网站声称在几项测试中它比其他框架更好。他们的网站提供了许多测试结果和不同的池分析。以下是HikariCP的一些优点:</em></p><ol class=""><li id="b331" class="ks kt hi ih b ii ij im in iq ku iu kv iy kw jc kx ky kz la bi translated">设计为无死锁</li><li id="d09d" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">可以自己检测连接泄漏。</li><li id="8803" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">为所有配置属性提供良好的默认值。是的，这是一个很大的优势，其他框架就不一样了。</li><li id="266e" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">在不使大量配置的用户不堪重负和大量功能配置之间找到完美的平衡。</li><li id="0fdf" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">超轻型(<em class="lp">仅130Kb】</em></li><li id="81be" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">伟大的基准测试<a class="ae kr" href="https://github.com/brettwooldridge/HikariCP-benchmark" rel="noopener ugc nofollow" target="_blank">结果。</a></li><li id="154f" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">更少的错误</li></ol><h2 id="00f2" class="lt je hi bd jf lu lv lw jj lx ly lz jn iq ma mb jr iu mc md jv iy me mf jz mg bi translated"><strong class="ak">为什么这么快？</strong></h2><figure class="kc kd ke kf fd kg er es paragraph-image"><a href="https://javarevisited.blogspot.com/2012/06/jdbc-database-connection-pool-in-spring.html#axzz6ggCCT42g"><div class="er es mh"><img src="../Images/20a6c49aaddba6f3cbe92a0e8bcd0717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5n1ARCm14o16cpDI"/></div></a><p class="kn ko et er es kp kq bd b be z dx translated">JMH微基准测试结果:来源</p></figure><ol class=""><li id="914c" class="ks kt hi ih b ii ij im in iq ku iu kv iy kw jc kx ky kz la bi translated">字节码级优化:编译后的字节码占用空间最小，这意味着CPU可以加载更多的程序缓存</li><li id="38c9" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">很多微优化:库减少了很多代码，比如<em class="lp">语句代理</em>只有100行代码</li><li id="cd3d" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">集合框架:明智地使用集合框架，尽可能使用更快的实现。例如<em class="lp"> FastList </em>而不是<em class="lp"> ArrayList。</em></li><li id="3a25" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">自定义实现:<em class="lp"> ConcurrentBag，</em>一种用于并发读/写的自定义集合类型提供了高度的并发性、极低的延迟和最小化的错误共享发生率。</li></ol><h1 id="4e9a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">选择合适的泳池大小？</h1><blockquote class="lm ln lo"><p id="895b" class="if ig lp ih b ii ij ik il im in io ip lq ir is it lr iv iw ix ls iz ja jb jc hb bi translated">人们声称仅通过调整池大小就可以实现10到20倍的性能提升！</p></blockquote><p id="a8b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于您应该为应用程序连接池设置什么值，没有直接的答案，但是，在您开始摆弄它之前，您应该知道一些基础知识。主要的想法是，你应该有足够的连接，以便使用所有可用的资源，但不要超过。</p><p id="ec76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设在您的后端系统中，任何时候都有1000个并发事务发生，那么为了获得最佳响应时间，连接池的值应该是多少？1000对，这样每个事务都可以得到一个连接，你可以在最短的时间内满足所有的请求，对吗？<strong class="ih hj">不！</strong></p><figure class="kc kd ke kf fd kg er es paragraph-image"><a href="https://www.java67.com/2018/02/5-free-servlet-jsp-and-jdbc-online-courses-for-java-developers.html"><div class="er es mi"><img src="../Images/4069d9c69eb7c9d1f5c3a73f4d5305d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*umGbdWI-HHFNz5AH"/></div></a><p class="kn ko et er es kp kq bd b be z dx translated">约翰·安维克在<a class="ae kr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="bc37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了理解这一点，我们必须再次重温基础知识，每当计算机CPU处理多个线程时，实际执行仍然是顺序的(<em class="lp">假设1个核心机器</em>)多个执行实际上是由于线程调度，操作系统切换上下文并将另一个线程的代码交给CPU处理，循环继续。上下文切换越多，对整体性能的影响就越大。概括地说，如果您有<strong class="ih hj"> N+1 </strong>个线程运行在一个<strong class="ih hj"> N </strong>核心机器上，那么您基本上是在损失性能而不是获得性能！[<em class="lp">这是在实际场景中的过度简化，通常情况下不会这样，因为线程等待一些资源等原因T13</em></p><h2 id="a9f8" class="lt je hi bd jf lu lv lw jj lx ly lz jn iq ma mb jr iu mc md jv iy me mf jz mg bi translated">所以对于N个核心机器，池大小应该是N，对吗？</h2><p id="d9b3" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">不，我们不能忽视<strong class="ih hj">磁盘</strong> &amp; <strong class="ih hj">网络。</strong>任何数据库系统上的数据都是物理存储在磁盘上的(现在大多是SSD)。由于内部执行的各种活动，以物理方式写入数据会有时间成本(磁盘不会为每次插入存储数据，它必须寻找正确的索引，然后写入)。这称为I/O等待时间，在此期间，线程基本上处于阻塞状态，等待I/O发生，因此，如果我们配置的线程比机器内核多，我们就可以完成更多的工作。同样的概念也适用于网络，如果你阻塞了网络带宽，它将导致你的应用程序线程阻塞。</p><h2 id="0fb7" class="lt je hi bd jf lu lv lw jj lx ly lz jn iq ma mb jr iu mc md jv iy me mf jz mg bi translated">公式</h2><p id="d6ca" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">没有直接的公式，但是，这可能会给你一些数字开始:</p><pre class="kc kd ke kf fd mj mk ml mm aw mn bi"><span id="eb05" class="lt je hi mk b fi mo mp l mq mr">connections = ((2 * core_count) + no_of_disks)</span></pre><p id="8727" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如果您有一台4核机器和1个硬盘，这意味着您可以从值9开始，然后尝试看看什么最适合您的应用程序。请注意，您的池大小要求可能不遵循此公式，对于具有大量I/O阻塞的服务，起始值将远远高于9，这是为了避免大池值。</p><blockquote class="lm ln lo"><p id="9924" class="if ig lp ih b ii ij ik il im in io ip lq ir is it lr iv iw ix ls iz ja jb jc hb bi translated"><em class="hi">注意:固态硬盘现在被广泛使用，虽然固态硬盘没有可用的公式，但是你应该知道这个数字总是小于从上述公式得出的no。为什么？固态硬盘更快——意味着更快的寻道/读/写时间，因此线程阻塞的时间更少</em></p></blockquote><p id="ace1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查是否应该减少连接数的一个方法是检查<code class="du ms mt mu mk b">pg_stat_activity</code>如果你的大多数连接花费了更多的空闲时间，那么这就是应该减少池大小的线索。</p><p id="2318" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">虽然想法是保持最小的连接，但在生产服务器上开始的一般池值是100，然后根据测试更改它</em></p><blockquote class="lm ln lo"><p id="ef3c" class="if ig lp ih b ii ij ik il im in io ip lq ir is it lr iv iw ix ls iz ja jb jc hb bi translated">注意:池化框架有<strong class="ih hj">最小</strong>和<strong class="ih hj">最大</strong>连接，您的实际连接在任意点从最小到最大值集之间变化，它不是一个单一的值</p></blockquote><h1 id="1770" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="939f" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">创建到数据库的连接开销很大，会影响应用程序的性能。连接池可以通过提前准备连接来帮助实现这一点，连接保持活动状态，并且可以在连接池中反复重用。连接池有多种JDBC框架，最流行的选择是Tomcat JDBC和HikariCP。无论您选择什么样的框架，正确配置属性都是很重要的，(HikariCP的一大优点是它为可选配置提供了很好的默认值)。当决定连接池的大小时，一旦超过了服务器一直忙碌的点，添加更多的连接实际上会降低性能，因为上下文切换中的所有开销。</p></div><div class="ab cl mv mw gp mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="hb hc hd he hf"><p id="f9ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你需要更多的帮助，请随时联系我。请务必关注所有新的更新。谢谢你的阅读。干杯🍺</p></div></div>    
</body>
</html>