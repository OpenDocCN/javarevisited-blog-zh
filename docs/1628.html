<html>
<head>
<title>Retry Pattern!— Fail Safe Strategy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">重试模式！—故障安全策略</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/retry-pattern-fail-safe-strategy-2244f6bd247c?source=collection_archive---------0-----------------------#2021-10-09">https://medium.com/javarevisited/retry-pattern-fail-safe-strategy-2244f6bd247c?source=collection_archive---------0-----------------------#2021-10-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/9883fb4a6d9b9e4dc2ae9cd366057251.png" data-original-src="https://miro.medium.com/v2/resize:fit:524/format:webp/1*lRBHHeTXDX5jv0bFjwRAwQ.png"/></div></figure></div><div class="ab cl im in gp io" role="separator"><span class="ip bw bk iq ir is"/><span class="ip bw bk iq ir is"/><span class="ip bw bk iq ir"/></div><div class="hb hc hd he hf"><p id="c1e7" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><strong class="iv hj">重新设计！</strong></p><p id="0765" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">重试设计是任何应用程序的关键用例，因此应用程序是容错的。</p><p id="ec3a" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">应用程序可能会遇到许多问题，其中可能会出现暂时的失败。再次执行相同的操作通常可以解决错误。再次执行那些重复任务的操作，使得应用程序没有任何问题地工作，<strong class="iv hj">就是重试机制。</strong></p><p id="b030" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">不可用的服务、不可达的网络、无法完成操作都是我们需要重新设计的例子。</p><p id="7061" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><strong class="iv hj">重试设计模式:</strong></p><p id="2395" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><em class="jr">连续重试</em>:如果操作失败，我们再次尝试立即执行相同的操作</p><p id="d1c8" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><em class="jr">间隔一段时间后重试</em>:如果操作失败，我们将在间隔一段时间后执行相同的操作。</p><p id="28bd" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><em class="jr">停止并返回</em>:如果任何操作失败，我们将重试相同的操作。然而，问题是要到什么时候？—因此，我们使用一个整数计数器变量，以便多次尝试操作，如果在多次尝试后仍抛出错误，则我们抛出一个用户定义的错误，以便用户知道该错误。</p><p id="88b7" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><strong class="iv hj">这个例子是在Java 8中</strong></p><p id="4719" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><strong class="iv hj">文件创建(故障安全):</strong></p><p id="ebb0" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">注意:下面的代码不是最好的设计，但是很容易理解。所以在博客的最后，我提供了设计良好的代码。</p><p id="3ec2" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">我们正在尝试创建文件。如果操作不成功，我们将再次尝试，直到重试变量(即5)为止。这里的操作是创建一个文件，但是在您的情况下它可以是任何东西，比如数据库连接。</p><p id="6d6c" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">在下面的代码中，我们试图在try块中创建一个目录，但是如果失败，我们将在catch块中再次尝试。我们使用了一个while循环，这样我们可以多次尝试这个操作。最后，我们使用了一个if块，这是一个验证检查，以查看即使在所有尝试之后，目录是否仍未创建。如果是，那么我们抛出一个错误。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="1423" class="kb kc hi jx b fi kd ke l kf kg">import java.io.IOException;<br/>import java.nio.file.Files;<br/>import java.nio.file.Paths;<br/><br/><br/>public class App {<br/>    public static void main(String[] args) throws IOException {<br/>        <em class="jr">dirCreation</em>();<br/>    }<br/><br/>    static void dirCreation() throws IOException{<br/>        String directoryPath = "/temporary/blogs/";<br/>        try {<br/>            Files.<em class="jr">createDirectories</em>(Paths.<em class="jr">get</em>(directoryPath));<br/>        } catch (Exception e) {<br/>            int retry = 5;<br/>            while(!Files.<em class="jr">exists</em>(Paths.<em class="jr">get</em>(directoryPath)) <br/>                     &amp;&amp;  retry!=0) {<br/>                retry--;<br/>                Files.<em class="jr">createDirectories</em>(Paths.<em class="jr">get</em>(directoryPath));<br/>            }<br/>            if(!Files.<em class="jr">exists</em>(Paths.<em class="jr">get</em>(directoryPath))) {<br/>                throw new IOException();<br/>            }<br/>        }<br/>    }<br/><br/>}</span></pre><p id="8b92" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">上述设计的问题是，我们的业务逻辑在catch块中也是可用的；这是不应该的。另一个问题是上述逻辑不可重用。如果我们想使用上面的逻辑来重试数据库连接，我们就必须重新编写逻辑。</p><p id="0f8e" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><strong class="iv hj">因此，下面的方法将为重试逻辑使用不同的类，我们将把我们的业务用例作为lambda(代码作为函数)传递给重试类。因此，使用这种方法，我们可以为任何目的使用相同的RetryLogic类。</strong></p><p id="9ccd" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">接受lambdas的功能接口-</p><p id="7fda" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">RetryImplementation.java</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="5c2b" class="kb kc hi jx b fi kd ke l kf kg">import java.io.IOException;<br/><br/>@FunctionalInterface<br/>public interface RetryImplementation {<br/>    Boolean run() throws IOException;<br/>}</span></pre><p id="ff7d" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">这里有两个变量。一个retryAttempts，表示重试的次数；两次重试之间的时间间隔。retryImpl()采用核心方法，该方法将被容错并重试多次。它接受一个方法实现。</p><p id="5fd6" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">RetryLogic.java</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="77c7" class="kb kc hi jx b fi kd ke l kf kg">import java.io.IOException;<br/><br/>public class RetryLogic {<br/><br/>    int retryAttempts;<br/>    final long TIME_TO_WAIT;<br/><br/>    RetryLogic(int retryAttempts, long timeToWait) {<br/>        this.retryAttempts = retryAttempts;<br/>        this.TIME_TO_WAIT = timeToWait;<br/>    }<br/><br/>    public void retryImpl(RetryImplementation retryImplementation) throws IOException {<br/>        if (shouldRetry()) {<br/>            retryAttempts--;<br/>            retryImplementation.run();<br/>            waitBeforeNextRetry();<br/>        } else {<br/><br/>            throw new IOException();<br/>        }<br/><br/>    }<br/>    public boolean shouldRetry() {<br/>        return retryAttempts &gt; 0;<br/>    }<br/>    public void waitBeforeNextRetry() {<br/>        try {<br/>            Thread.<em class="jr">sleep</em>(TIME_TO_WAIT);<br/>        } catch (Exception e) {<br/>        }<br/>    }<br/>}</span></pre><p id="7e7e" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">在下面的代码中，我们将重试逻辑作为lambda(Java 8)传递给retryImpl。代码是通用的，因为您可以传递自己的用例，如数据库连接重试或任何需要故障安全容错的代码。</p><p id="fa52" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">App.java</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="c0db" class="kb kc hi jx b fi kd ke l kf kg">import java.io.IOException;<br/><br/><br/>public class App {<br/>    static String <em class="jr">directoryPath </em>= "/temporary/blogs";<br/>    static RetryLogic <em class="jr">retryLogic </em>= new RetryLogic(5, 2000);<br/>    public static void main(String[] args) throws IOException {<br/>        <em class="jr">dirCreation</em>();<br/><br/>    }<br/><br/>    static void dirCreation() throws IOException {<br/>        try {<br/>            Files.createDirectories(Paths.get(directoryPath));<br/>            <br/>        } catch (Exception e) {<br/>                <em class="jr">retryLogic</em>.retryImpl(<strong class="jx hj">() -&gt; {<br/>                    try {<br/>                        <em class="jr">dirCreation</em>();<br/>                    } finally {<br/><br/>                    }<br/>                    return null;<br/>                })</strong>;<br/>        }<br/>    }<br/>}</span></pre><p id="43b2" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated"><strong class="iv hj">结论</strong></p><p id="20b6" class="pw-post-body-paragraph it iu hi iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq hb bi translated">所有的掌声和关注都受到高度赞赏。干杯！</p></div></div>    
</body>
</html>