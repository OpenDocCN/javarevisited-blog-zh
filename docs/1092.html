<html>
<head>
<title>Monitoring your REST api with Prometheus et Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Prometheus et Grafana监控您的REST api</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/monitoring-your-rest-api-with-prometheus-et-grafana-6b909a7b0c69?source=collection_archive---------0-----------------------#2021-03-22">https://medium.com/javarevisited/monitoring-your-rest-api-with-prometheus-et-grafana-6b909a7b0c69?source=collection_archive---------0-----------------------#2021-03-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3eff1cc534471677f745cbedfcb53d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sPh4Js8NUp-y-7D0gtl3Hg.jpeg"/></div></div></figure><p id="56b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<a class="ae jo" rel="noopener" href="/javarevisited/building-a-simple-rest-api-with-springboot-3f2e4b123ebb">构建了</a>、<a class="ae jo" rel="noopener" href="/javarevisited/securing-your-rest-api-with-springsecurity-8ba440fe7b58">保护了</a>、<a class="ae jo" rel="noopener" href="/javarevisited/documenting-your-api-with-swagger-c27a94104135">记录了</a>我们的API之后，我们现在将学习如何监控它。为此，我们将使用<a class="ae jo" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>和<a class="ae jo" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank">格拉法纳</a>:</p><ul class=""><li id="fb6b" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">普罗米修斯公司<strong class="is hj">将负责收集API指标</strong></li><li id="1149" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj"> Grafana </strong>将在面板中显示，以帮助可视化指标</li></ul></div><div class="ab cl kd ke gp kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="hb hc hd he hf"><h1 id="44f7" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">你需要什么</h1><p id="18eb" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">如果你遵循了之前的教程，你只需要<a class="ae jo" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">安装docker </a>来托管我们的prometheus和grafana。<br/>如果您需要运行API，您可以使用以下两个选项:</p><ul class=""><li id="d4cb" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">拉<a class="ae jo" href="https://github.com/ErwanLT/HumanCloningFacilities" rel="noopener ugc nofollow" target="_blank">本库</a>分支主</li><li id="47e2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">用<a class="ae jo" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring initializr </a>创建一个快速启动项目</li><li id="387d" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">安装docker</li></ul><h1 id="afe7" class="kk kl hi bd km kn ln kp kq kr lo kt ku kv lp kx ky kz lq lb lc ld lr lf lg lh bi translated">导入Grafana和Prometheus图像</h1><p id="7de2" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">要将grafana和Prometheus添加到您的docker本地注册表，请访问docker-hub进行搜索:</p><ul class=""><li id="3e9c" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><a class="ae jo" href="https://hub.docker.com/r/grafana/grafana/" rel="noopener ugc nofollow" target="_blank">格拉夫纳</a></li><li id="20ad" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://hub.docker.com/r/prom/prometheus" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a></li></ul><p id="aff0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，使用命令行拉动。</p><p id="85d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通常情况下，您应该在docker CLI中看到类似这样的内容。</p><figure class="lt lu lv lw fd ij er es paragraph-image"><a href="https://www.java67.com/2018/02/5-free-docker-courses-for-java-and-DevOps-engineers.html"><div class="er es ls"><img src="../Images/f75bdd1626c3a2c75f52c21a5e969393.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9VMVIh0WwLeJz_HCBb9g9w.png"/></div></a></figure><p id="3532" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以直接在<a class="ae jo" href="https://javarevisited.blogspot.com/2020/11/why-devops-engineer-learn-docker-kubernetes.html#axzz6dXsEfLvJ" rel="noopener ugc nofollow" target="_blank">容器</a>中运行Grafana，但是普罗米修斯将需要进一步的配置。</p><h1 id="4d61" class="kk kl hi bd km kn ln kp kq kr lo kt ku kv lp kx ky kz lq lb lc ld lr lf lg lh bi translated">将我们的指标导出到普罗米修斯</h1><p id="88f0" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">首先，为了导出我们的API指标，我们需要向pom.xml添加一些新的依赖项</p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="1f68" class="mc kl hi ly b fi md me l mf mg">&lt;!-- Spring boot actuator to expose metrics endpoint --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;!-- Micormeter core dependecy  --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;<br/>    &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;!-- Micrometer Prometheus registry  --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;<br/>    &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</span></pre><h2 id="349f" class="mc kl hi bd km mh mi mj kq mk ml mm ku jb mn mo ky jf mp mq lc jj mr ms lg mt bi translated">执行器</h2><p id="342c" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">第一个依赖项让我们知道一些关于我们正在运行的应用程序的有用信息。要读取它们，我们只需要启动我们的应用程序，然后转到http://localhost:8080/actuator。</p><figure class="lt lu lv lw fd ij er es paragraph-image"><a href="https://www.java67.com/2021/02/spring-boot-actuator-interview-questions-answers-java.html"><div class="er es mu"><img src="../Images/9bb0570b1c04e886ffb710b3666eb8d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*__DHb1rkwogmMKCBa-IaCg.png"/></div></a></figure><h2 id="5237" class="mc kl hi bd km mh mi mj kq mk ml mm ku jb mn mo ky jf mp mq lc jj mr ms lg mt bi translated">普罗米修斯</h2><p id="bacb" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">正如你在上面的捕获中看到的，在第三个依赖项中，我们的执行器中有一个普罗米修斯部分。<br/>如果我点击该链接，我会看到代表我的应用指标的值列表，例如:</p><ul class=""><li id="5bac" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">jvm信息</li><li id="5eb2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">端点上的http请求状态</li><li id="6cbc" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">记录事件</li><li id="a8a2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi">…</li></ul><p id="3bc9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">既然我们向/prometheus端点公开了我们的指标，我们需要配置prometheus服务器来收集它们。</p><h2 id="79e2" class="mc kl hi bd km mh mi mj kq mk ml mm ku jb mn mo ky jf mp mq lc jj mr ms lg mt bi translated">配置文件</h2><p id="1e86" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">我们需要配置prometheus从端点收集数据，为此我们需要覆盖prometheus.yml文件。</p><p id="02c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先我们需要创建一个prometheus.yml文件。</p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="70d0" class="mc kl hi ly b fi md me l mf mg">global:<br/>  scrape_interval:     15s <br/>  evaluation_interval: 15s <br/><br/>rule_files:<br/><em class="mv"># - "first_rules.yml"<br/># - "second_rules.yml"<br/><br/></em>scrape_configs:<br/>  - job_name: 'prometheus'<br/>    static_configs:<br/>      - targets: ['127.0.0.1:9090']<br/><br/>  - job_name: 'spring-actuator'<br/>    metrics_path: '/actuator/prometheus'<br/>    scrape_interval: 5s<br/>    static_configs:<br/>      - targets: ['XXXXXX:8080']</span></pre><p id="f529" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用你的IP地址替换XXXXXXX，因为prometheus将在一个<a class="ae jo" rel="noopener" href="/javarevisited/10-free-courses-to-learn-docker-and-devops-for-frontend-developers-691ac7652cee?source=---------94------------------"> docker容器</a>中运行，他不知道localhost。</p><p id="ffc9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其次，我们将创建一个docker文件，用新的配置文件myApp.dockerfile运行prometheus</p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="ce39" class="mc kl hi ly b fi md me l mf mg">FROM prom/prometheus<br/>ADD prometheus.yml /etc/prometheus/prometheus.yml</span></pre><p id="416e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用该文件，我们指定docker创建prometheus映像的副本，并将我们新创建的prometheus.yml添加到正确的目录中。</p><p id="82dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">既然我们在prometheus上收集了我们的指标，现在我们可以在Grafana中配置我们的数据源。</p><h1 id="3c51" class="kk kl hi bd km kn ln kp kq kr lo kt ku kv lp kx ky kz lq lb lc ld lr lf lg lh bi translated">配置Grafana</h1><h2 id="38e8" class="mc kl hi bd km mh mi mj kq mk ml mm ku jb mn mo ky jf mp mq lc jj mr ms lg mt bi translated">注册</h2><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/d92be6c296d8a30a154dc5a1f2351906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hxAO_LEab1MIRAipnzTwMw.png"/></div></div></figure><p id="8177" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当你在你的容器上访问你的Grafana，你到达一个登录页面，通过这个页面你可以使用默认的凭证<strong class="is hj"> admin/admin。</strong></p><h2 id="277b" class="mc kl hi bd km mh mi mj kq mk ml mm ku jb mn mo ky jf mp mq lc jj mr ms lg mt bi translated">配置数据源</h2><p id="2140" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">在左边的导航栏中，当您单击齿轮图标时，会显示一个名为datasource的子菜单，单击它。</p><p id="1bcc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，我们希望将之前配置的Prometheus添加为数据源。</p><p id="4f43" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在可能的数据源列表中，选择Prometheus。</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/fb217b43ecd3025542741b4045a064e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ea5bnwcmtbE8oCkHvBl1bQ.png"/></div></div></figure><p id="01ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在URL输入中，输入您的prometheus容器ip地址。<br/>你可以测试你的连接，如果有效你可以继续下一步，如果有错误，你可以阅读grafana文档找到连接的方法。</p><h2 id="c0e2" class="mc kl hi bd km mh mi mj kq mk ml mm ku jb mn mo ky jf mp mq lc jj mr ms lg mt bi translated">创建仪表板</h2><p id="ba44" class="pw-post-body-paragraph iq ir hi is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn hb bi translated">现在我们已经登录到Grafana，我们可以制作一些仪表板来显示我们的指标</p><figure class="lt lu lv lw fd ij er es paragraph-image"><a href="https://javarevisited.blogspot.com/2021/02/-spring-boot-testing-interview-questions-answers-java.html"><div class="er es my"><img src="../Images/3864094bef1a986ef5e3a9581fc0cf5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CCgFIJi53M4bOUXPIT1tCA.png"/></div></a></figure><p id="9ef7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，我创建了4个请求，通过状态代码显示对我的API端点的HTTP请求的数量。</p></div><div class="ab cl kd ke gp kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="hb hc hd he hf"><p id="a6a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢您的阅读时间，和以前一样，本教程中使用的代码可以在<a class="ae jo" href="https://github.com/ErwanLT/HumanCloningFacilities" rel="noopener ugc nofollow" target="_blank"> this Github repository </a>，branch monitoring中找到。</p></div></div>    
</body>
</html>