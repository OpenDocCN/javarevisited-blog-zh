<html>
<head>
<title>Introduction to Java 8 Parallel Stream — Java2Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Java 8 并行流简介— Java2Blog</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/java-8-parallel-stream-java2blog-e1254e593763?source=collection_archive---------0-----------------------#2019-04-23">https://medium.com/javarevisited/java-8-parallel-stream-java2blog-e1254e593763?source=collection_archive---------0-----------------------#2019-04-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><a href="https://click.linksynergy.com/fs-bin/click?id=JVFxdTr9V80&amp;subid=0&amp;offerid=323058.1&amp;type=10&amp;tmpid=14538&amp;RD_PARM1=https%3A%2F%2Fwww.udemy.com%2Fjava-the-complete-java-developer-course%2F"><div class="er es if"><img src="../Images/974226db427375612da29caecc6f18f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gzcesnqXZC4TVVk8.png"/></div></a></figure><p id="35a2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这篇文章中，我们将会看到 java 中的并行流。</p><p id="925b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://java2blog.com/java-8-tutorial/" rel="noopener ugc nofollow" target="_blank"> Java 8 </a>引入了并行流的概念来做并行处理。由于廉价的硬件成本，现在我们有许多 CPU 核心，并行处理可以用来更快地执行操作。</p><p id="7ca5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们借助一个简单的例子来理解</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="1dcd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当您运行上面的程序时，您将得到下面的输出</p><blockquote class="jr js jt"><p id="316c" class="im in ju io b ip iq ir is it iu iv iw jv iy iz ja jw jc jd je jx jg jh ji jj hb bi translated">= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =<br/>使用顺序流<br/>= = = = = = = = = = = = = = = = = = = = =<br/>1 主<br/> 2 主<br/> 3 主<br/> 4 主<br/> 5 主<br/> 6 主<br/> 7 主<br/> 8 主<br/> 9 主<br/>9 主<br/>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = T17</p></blockquote><p id="1dee" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您注意到输出，主线程正在处理顺序流的所有工作。它等待当前迭代完成，然后处理下一个迭代。</p><p id="357b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在<a class="ae jk" href="http://www.java67.com/2018/10/java-8-stream-and-functional-programming-interview-questions-answers.html" rel="noopener ugc nofollow" target="_blank">并行流</a>的情况下，同时产生 4 个线程，它在内部使用 Fork 和 Join pool 来创建和管理线程。并行流通过静态<code class="du jy jz ka kb b">ForkJoinPool.commonPool()</code>方法创建<code class="du jy jz ka kb b">ForkJoinPool</code>实例。</p><p id="82d4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">并行流利用所有可用的 CPU 内核，并行处理任务。如果任务数量超过核心数量，则剩余任务会等待当前运行的任务完成。</p><h1 id="b7de" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">并行流很酷，所以你应该一直使用它吗？</h1><p id="a080" class="pw-post-body-paragraph im in hi io b ip la ir is it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj hb bi translated"><strong class="io hj">一个大大的不！！</strong> <br/>将顺序<a class="ae jk" href="https://java2blog.com/java-8-stream-filter-examples/" rel="noopener ugc nofollow" target="_blank">流</a>转换成并行流，只需添加即可。并行，并不意味着你应该总是使用它。使用并行流时，您需要考虑许多因素，否则您会受到并行流的负面影响。</p><p id="bf9d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">并行流比<a class="ae jk" href="http://www.java67.com/2014/04/java-8-stream-examples-and-tutorial.html" rel="noopener ugc nofollow" target="_blank">顺序流</a>有更高的开销，并且需要大量时间在线程之间进行协调。<br/>当且仅当以下条件成立时，您才需要考虑并行流:</p><ul class=""><li id="25b6" class="lf lg hi io b ip iq it iu ix lh jb li jf lj jj lk ll lm ln bi translated">您有一个大型数据集要处理。</li><li id="a16a" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">正如你所知道的，Java 使用<a class="ae jk" href="http://javarevisited.blogspot.sg/2016/12/difference-between-executor-framework-and-ForkJoinPool-in-Java.html" rel="noopener ugc nofollow" target="_blank"> ForkJoinPool </a>来实现并行性，ForkJoinPool 派生源代码流并提交执行，所以你的源代码流应该是可拆分的。<br/>例如:<br/> <a class="ae jk" href="https://javarevisited.blogspot.com/2011/05/example-of-arraylist-in-java-tutorial.html" rel="noopener ugc nofollow" target="_blank"> ArrayList </a>非常容易拆分，因为我们可以通过它的索引找到一个中间元素并将其拆分，但 LinkedList 很难拆分，并且在大多数情况下执行得不是很好。</li><li id="6b3a" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">你实际上正遭受性能问题的困扰。</li><li id="c112" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">您需要确保线程之间的所有共享资源都需要正确同步，否则可能会产生意想不到的结果。</li></ul><p id="d54c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">测量平行度的最简单公式是“NQ”模型，如 Brian Goetz 在他的演示中所提供的。</p><p id="a775" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> NQ 模式</strong>:</p><pre class="jl jm jn jo fd lt kb lu lv aw lw bi"><span id="370c" class="lx kd hi kb b fi ly lz l ma mb">N x Q &gt;10000</span></pre><p id="ac8d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">其中，<br/> N =数据集中的项目数<br/> Q =每个项目的工作量</p><p id="faa0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这意味着如果你有大量的数据集和较少的工作(例如:Sum)，并行性可以帮助你更快地运行程序，反之亦然。因此，如果你有更少的数据集和更多的工作(做一些计算工作)，那么并行性也可以帮助你更快地获得结果。</p><p id="8fca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们借助另一个例子来看看。</p><p id="d5a7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本例中，我们将了解在并行流和顺序流的情况下，当您执行长时间计算时，CPU 的表现。我们正在做一些 arbit 计算，让 CPU 忙起来。</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="541e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当您运行上面的程序时，您将得到下面的输出。</p><blockquote class="jr js jt"><p id="59b2" class="im in ju io b ip iq ir is it iu iv iw jv iy iz ja jw jc jd je jx jg jh ji jj hb bi translated">117612733 <br/>完成时间:6 分钟</p></blockquote><p id="1958" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">但是我们对这里的输出不感兴趣，而是当执行上述操作时 CPU 的行为如何。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/10d888cebe040e1fe16c0e3339de09a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/0*vlMlGT17dqStvNsd.png"/></div></figure><p id="8bd6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如您所见，在顺序流的情况下，CPU 没有得到充分利用。</p><p id="53fb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们在第 16 行编号处进行更改，并使流平行，然后再次运行程序。</p><pre class="jl jm jn jo fd lt kb lu lv aw lw bi"><span id="31d0" class="lx kd hi kb b fi ly lz l ma mb">long sum=data.stream()<br/>				.parallel()<br/>				.map(i -&gt;(int)Math.sqrt(i))<br/>				.map(number-&gt;performComputation(number))<br/>				.reduce(0,Integer::sum);</span></pre><p id="e1de" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当您并行运行 Stream 时，您将得到低于输出的结果。</p><blockquote class="jr js jt"><p id="6afe" class="im in ju io b ip iq ir is it iu iv iw jv iy iz ja jw jc jd je jx jg jh ji jj hb bi translated">117612733 <br/>完成时间:3 分钟</p></blockquote><p id="9e21" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们检查使用并行流运行程序时的 CPU 历史。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><a href="https://medium.com/javarevisited/top-5-java-online-courses-for-beginners-best-of-lot-1e1e240a758"><div class="er es if"><img src="../Images/974226db427375612da29caecc6f18f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gzcesnqXZC4TVVk8.png"/></div></a></figure><p id="e0b5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如您所见，并行流使用了所有 4 个 CPU 内核来执行计算。</p><p id="cada" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就是 java 中并行流的全部内容。</p><p id="bb82" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可能也喜欢阅读 Java 8 教程</p><ol class=""><li id="639b" class="lf lg hi io b ip iq it iu ix lh jb li jf lj jj md ll lm ln bi translated"><a class="ae jk" href="https://java2blog.com/java-8-tutorial/" rel="noopener ugc nofollow" target="_blank"> Java 8 教程</a></li><li id="dcd6" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj md ll lm ln bi translated"><a class="ae jk" href="https://java2blog.com/java-8-interview-questions-answers/" rel="noopener ugc nofollow" target="_blank"> Java 8 面试问题</a></li><li id="1107" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj md ll lm ln bi translated"><a class="ae jk" href="https://java2blog.com/lambda-expressions-in-java-8/" rel="noopener ugc nofollow" target="_blank">Java 8 中的 Lambda 表达式</a></li><li id="31f1" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj md ll lm ln bi translated"><a class="ae jk" href="https://java2blog.com/core-java-tutorial-for-beginners-experienced/" rel="noopener ugc nofollow" target="_blank">核心 java 教程</a></li><li id="c99d" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj md ll lm ln bi translated"><a class="ae jk" href="http://javarevisited.blogspot.sg/2016/10/best-books-to-learn-java-8.html" rel="noopener ugc nofollow" target="_blank">从零开始学习 Java 8 的 5 本书</a></li><li id="89a1" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj md ll lm ln bi translated"><a class="ae jk" href="https://javarevisited.blogspot.com/2018/08/top-5-free-java-8-and-9-courses-for-programmers.html" rel="noopener ugc nofollow" target="_blank">学习 Java 8 及更高版本的 5 门免费课程</a></li></ol><div class="me mf ez fb mg mh"><a href="https://javarevisited.blogspot.com/2019/10/the-java-developer-roadmap.html#123" rel="noopener  ugc nofollow" target="_blank"><div class="mi ab dw"><div class="mj ab mk cl cj ml"><h2 class="bd hj fi z dy mm ea eb mn ed ef hh bi translated">2021 年 Java 开发者路线图</h2><div class="mo l"><h3 class="bd b fi z dy mm ea eb mn ed ef dx translated">大家好，首先祝大家 2020 新年快乐。我已经分享了很多成为网络的路线图…</h3></div><div class="mp l"><p class="bd b fp z dy mm ea eb mn ed ef dx translated">javarevisited.blogspot.com</p></div></div><div class="mq l"><div class="mr l ms mt mu mq mv ik mh"/></div></div></a></div><div class="me mf ez fb mg mh"><a rel="noopener follow" target="_blank" href="/javarevisited/what-java-programmers-should-learn-in-2020-648050533c83"><div class="mi ab dw"><div class="mj ab mk cl cj ml"><h2 class="bd hj fi z dy mm ea eb mn ed ef hh bi translated">2021 年 Java 程序员该学什么？</h2><div class="mo l"><h3 class="bd b fi z dy mm ea eb mn ed ef dx translated">2020 年 Java 程序员可以学习的有用工具、技术、框架和库</h3></div><div class="mp l"><p class="bd b fp z dy mm ea eb mn ed ef dx translated">medium.com</p></div></div><div class="mq l"><div class="mw l ms mt mu mq mv ik mh"/></div></div></a></div></div><div class="ab cl mx my gp mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="hb hc hd he hf"><p id="4aca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ju">原载于 2019 年 4 月 23 日</em><a class="ae jk" href="https://java2blog.com/java-8-parallel-stream/" rel="noopener ugc nofollow" target="_blank"><em class="ju">https://java2blog.com</em></a><em class="ju">。</em></p></div></div>    
</body>
</html>