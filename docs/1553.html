<html>
<head>
<title>WhatsApp System Design</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WhatsApp系统设计</h1>
<blockquote>原文：<a href="https://medium.com/javarevisited/whatsapp-system-design-dd1cc2e6bfb4?source=collection_archive---------0-----------------------#2021-09-13">https://medium.com/javarevisited/whatsapp-system-design-dd1cc2e6bfb4?source=collection_archive---------0-----------------------#2021-09-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="d038" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这篇博客中，我们将介绍一个聊天应用程序的设计，即Whatsapp。</p><p id="ef1e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面是架构图:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/a52c97d899192555661cbcee081c7bac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Omwv_A5ir7eij4tcvVZeKg.png"/></div></div></figure><h2 id="861a" class="jw jx hi bd jy jz ka kb kc kd ke kf kg ix kh ki kj jb kk kl km jf kn ko kp kq bi translated"><strong class="ak">要求:</strong></h2><ol class=""><li id="d33a" class="kr ks hi io b ip kt it ku ix kv jb kw jf kx jj ky kz la lb bi translated">用户可以发送消息</li><li id="7778" class="kr ks hi io b ip lc it ld ix le jb lf jf lg jj ky kz la lb bi translated">用户可以发送媒体(图像、视频、文件等)</li><li id="e43e" class="kr ks hi io b ip lc it ld ix le jb lf jf lg jj ky kz la lb bi translated">用户可以分组进行对话</li><li id="fb85" class="kr ks hi io b ip lc it ld ix le jb lf jf lg jj ky kz la lb bi translated">用户可以查看上次看到的内容</li><li id="cf2d" class="kr ks hi io b ip lc it ld ix le jb lf jf lg jj ky kz la lb bi translated">即使接收者脱机，用户也可以发送消息\</li><li id="07bf" class="kr ks hi io b ip lc it ld ix le jb lf jf lg jj ky kz la lb bi translated">消息加密和调用(考虑到解释中涉及的复杂性，我们将跳过此功能)</li></ol><p id="e813" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">解说:</strong></p><p id="a778" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">个人资料数据库</strong></p><p id="953e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">存储用户的个人资料信息，如状态、个人资料图片、个人资料ID和联系方式。<br/>为了存储个人资料图片，我们将使用s3存储桶，并在数据库中保存相应的链接。</p><p id="2502" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">档案服务</strong></p><p id="3854" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有多个端点，这有助于检索用户的详细信息。Get调用检索配置文件信息，post/put调用添加配置文件信息。</p><p id="f8b3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">聊天服务器</strong></p><p id="355f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">WhatsApp应用程序的主要核心服务器。我们将在下一节详细讨论这一点。</p><p id="8e01" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">映射数据库</strong></p><p id="9764" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将不使用HTTP协议来发送消息，因为在HTTP；为每个用户创建一个新的请求，一旦收到响应，我们就关闭连接。然而，我们不想浪费时间和资源来创建连接，因此我们将使用websocket协议，因为连接不会立即关闭。</p><blockquote class="lh li lj"><p id="4615" class="im in lk io b ip iq ir is it iu iv iw ll iy iz ja lm jc jd je ln jg jh ji jj hb bi translated">映射数据库对这个应用程序至关重要。</p></blockquote><p id="5056" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们举一个例子来解释这个场景:</p><p id="1907" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在上面的架构图中，我们使用了2个用户:UserA和UserB。假设用户a向用户b发送消息“嘿”。</p><p id="1688" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦用户a与聊天服务器交互，就会为这个用户a创建一个新的进程(一个线程)。如果用户b在线，情况也是如此。然后，服务器找出接收者userB的名称，然后它进入数据库，找出userB的进程id (pid ),以便将消息发送给userB。如果用户b想要将消息发送给用户a，则在映射数据库中搜索用户a，一旦找到pid，就将消息发送给该pid，这里基本上就是用户a。</p><p id="65d4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，每当用户与系统对话时，就会创建一个新流程，并将详细信息存储在映射数据库中，类似于以下方式:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es lo"><img src="../Images/16cc1cd5122217aa63b4933b3394060b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*7rHBCd3kGgCPAvuU5GcA8A.png"/></div></figure><p id="3306" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在真实的应用程序中，显然我们会有多个用户和服务器，如下所示:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es lp"><img src="../Images/a66a1c0d9da858cf0c1428797eeb157b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eRNGdM_zW_QZlQ9whqFimQ.png"/></div></div></figure><p id="6941" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们还在每个服务器中包含了一个队列，这样队列就可以处理过量的消息，并且在向不同用户发送任何消息时都不会失败。</p><p id="2298" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">群组服务</strong></p><p id="12cb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于创建的每个组，都会创建一个新的groupId。然后，这个groupId将有一个到组中所有用户的映射。每当发送消息时，聊天服务首先找出接收者的类型(群组或单个用户)，如果是群组，则消息被委托给群组服务。然后，Group Service调用group db来查找groupId和所有相应的userIds，以便可以发送消息。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es lq"><img src="../Images/3532f68d368591547a9777a611efa918.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0NmhasFdZFjYluQml77lOw.png"/></div></div></figure><p id="c45d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">最后看到的服务</strong></p><p id="31a5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">上次看到的服务使用上次看到的数据库，因此可以存储上次看到的信息。这是一个非常简单的服务，它只维护最后看到的时间细节。最好的方法是:每当用户打开WhatsApp并向聊天服务器发送任何与用户相关的请求时，聊天服务器都可以调用这个服务来更新时间细节。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es lr"><img src="../Images/3568828929249e650c38d8ec4c8f7880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*rNZzTXOtfLZ_K-0Q3hEZMA.png"/></div></figure><p id="c97c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">消息存储服务器&amp;存储临时消息DB </strong></p><p id="056a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们需要一个消息存储服务器，因为当消息被发送给一个用户时，该用户可以离线。在这种情况下，我们将不得不保存消息，以便一旦用户点击服务器或重新联机，所有消息都可以被传递。出于安全目的，我们将加密信息存储在数据库中。实际上，整个架构使用加密的消息，然而为了保持文章简短，我们将跳过它。</p><p id="1424" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">媒体类型消息</strong></p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ls"><img src="../Images/2fc59cc3550576cf3b09e080374a0604.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zlyVWhKU9ci7E0wK0TDoXg.png"/></div></div></figure><p id="700e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于媒体类型的消息，聊天服务获取消息并找出消息的类型。一旦消息类型被标记为媒体，它就被存储在S3桶中，这是一个对象存储服务。这些媒体的链接随后存储在sql或nosql db中，并映射到用户详细信息。我们可以使用HTTP协议来传输这些消息。</p><p id="684f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">结论</strong></p><p id="1f7f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由此我们对WhatsApp messenger的设计有了一个大致的了解。我还没有深入讨论使用哪种队列服务或哪种db类型的技术细节，因为这是一个需要研究和实现特定非功能目标的主题。如果您认为体系结构图中有可以改进的地方，请随意评论！</p><p id="49f3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请关注更多关于全栈开发的文章。请通过LinkedIn联系我，或者给我发邮件到vivek.sinless@gmail.com</p></div></div>    
</body>
</html>